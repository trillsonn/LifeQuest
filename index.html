<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Memaster</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Simple task management app to help you organize your day">
    <meta name="theme-color" content="#667eea">
    <meta name="background-color" content="#15202B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Memaster">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Memaster">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik05IDEyTDExIDEyTDE1IDhNMjEgMTJDMjEgMTYuOTcwNiAxNi45NzA2IDIxIDEyIDIxQzcuMDI5NDQgMjEgMyAxNi45NzA2IDMgMTJDMyA3LjAyOTQ0IDcuMDI5NDQgMyAxMiAzqte16Ljk3MDYgMyAyMSA3LjAyOTQ0IDIxIDEyWiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik05IDEyTDExIDEyTDE1IDhNMjEgMTJDMjEgMTYuOTcwNiAxNi45NzA2IDIxIDEyIDIxQzcuMDI5NDQgMjEgMyAxNi45NzA2IDMgMTJDMyA3LjAyOTQ0IDcuMDI5NDQgMyAxMiAzqte16Ljk3MDYgMyAyMSA3LjAyOTQ0IDIxIDEyWiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Local storage only - no Firebase needed -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ensure all input text is visible - Mobile Safari Fix */
        input[type="text"], 
        input[type="email"], 
        input[type="password"], 
        textarea, 
        select {
            color: #ffffff !important;
            -webkit-text-fill-color: #ffffff !important;
            -webkit-opacity: 1 !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            background-color: transparent !important;
            caret-color: #ffffff !important;
        }

        input[type="text"]:focus, 
        input[type="email"]:focus, 
        input[type="password"]:focus, 
        textarea:focus, 
        select:focus {
            color: #ffffff !important;
            -webkit-text-fill-color: #ffffff !important;
            -webkit-opacity: 1 !important;
            background-color: transparent !important;
            caret-color: #ffffff !important;
        }

        /* iOS Safari specific fixes */
        input, textarea, select {
            -webkit-user-select: text !important;
            -webkit-touch-callout: default !important;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1) !important;
        }

        /* Ultimate fallback for mobile text visibility */
        .mobile-container input,
        .mobile-container textarea,
        .mobile-container select {
            color: white !important;
            -webkit-text-fill-color: white !important;
            text-shadow: 0 0 1px rgba(255, 255, 255, 0.8) !important;
        }

        /* Force white text on all form elements */
        input:not([type="submit"]):not([type="button"]):not([type="reset"]),
        textarea,
        select {
            color: #ffffff !important;
            -webkit-text-fill-color: #ffffff !important;
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Emergency visibility fix for iOS */
        @supports (-webkit-appearance: none) {
            input[type="text"],
            textarea {
                color: white !important;
                -webkit-text-fill-color: white !important;
                background-color: rgba(0, 0, 0, 0.3) !important;
                border: 2px solid rgba(255, 255, 255, 0.3) !important;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #15202B;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            width: 100vw;
            max-width: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Prevent any element from causing horizontal scroll on mobile */
        * {
            box-sizing: border-box;
        }

        /* iOS Safari viewport fix */
        @supports (-webkit-touch-callout: none) {
            .chat-input-container {
                bottom: env(safe-area-inset-bottom, 0px);
                padding-bottom: calc(15px + env(safe-area-inset-bottom, 0px));
            }
            
            .ai-chat-modal {
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            .chat-messages {
                max-height: calc(100vh - 140px);
                max-height: calc(-webkit-fill-available - 140px);
            }
        }

        /* Additional fix for iOS portrait mode */
        @media screen and (max-width: 375px) and (orientation: portrait) {
            .chat-input-container {
                bottom: 0;
                position: fixed !important;
                z-index: 200 !important;
            }
            
            .detected-tasks-container {
                margin: 15px 0 !important;
                padding: 12px !important;
            }
            
            .chat-messages {
                height: calc(100vh - 130px);
                padding-bottom: 130px;
            }
        }

        .mobile-container {
            width: 100vw;
            max-width: 100%;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #1e2732 0%, #15202B 100%);
            position: relative;
            box-sizing: border-box;
            padding: 0;
        }

        /* Responsive adjustments for different screen sizes */
        @media screen and (max-width: 375px) {
            /* iPhone 12 Mini, iPhone SE */
            .mobile-container {
                padding: 0 5px;
            }
        }

        @media screen and (min-width: 376px) and (max-width: 414px) {
            /* iPhone 12, iPhone 12 Pro, iPhone 13 */
            .mobile-container {
                padding: 0 10px;
            }
        }

        @media screen and (min-width: 415px) {
            /* iPhone 12 Pro Max, iPhone 13 Pro Max */
            .mobile-container {
                max-width: 428px;
                margin: 0 auto;
                padding: 0 15px;
            }
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
            text-align: center;
        }

        .app-logo {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .app-logo i {
            font-size: 50px;
            color: white;
        }

        .welcome-screen h1 {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 20px;
            color: #ffffff;
        }

        .welcome-screen p {
            font-size: 18px;
            color: #999;
            margin-bottom: 60px;
            line-height: 1.5;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: #cccccc;
            margin: 10px 0 30px 0;
            text-align: center;
            font-weight: 400;
            opacity: 0.9;
        }

        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 280px;
        }

        .welcome-btn {
            padding: 18px 24px;
            border-radius: 12px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .welcome-btn:active {
            transform: scale(0.98);
        }

        /* Main App Screen */
        .main-screen {
            display: none;
            min-height: 100vh;
            padding: 60px 15px 120px;
            box-sizing: border-box;
            width: 100%;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* Responsive padding for iPhone 12 and smaller */
        @media screen and (max-width: 375px) {
            .main-screen {
                padding: 55px 10px 120px;
            }
        }

        .main-screen.active {
            display: block;
        }

        .status-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 390px;
            height: 44px;
            background: rgba(21, 32, 43, 0.95);
            backdrop-filter: blur(20px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            font-size: 14px;
            font-weight: 600;
            position: relative;
        }
        
        .settings-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #667eea;
            font-size: 16px;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-50%) scale(1.1);
        }

        .settings-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .sync-status {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .sync-status.online {
            color: #51cf66;
        }
        
        .sync-status.offline {
            color: #ff6b6b;
        }
        
        .sync-status.syncing {
            color: #667eea;
        }
        
        .sync-icon {
            font-size: 10px;
        }
        
        .sync-icon.spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .question-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .question-header h2 {
            font-size: 28px;
            font-weight: 300;
            line-height: 1.3;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .add-task-container {
            margin-bottom: 20px;
        }

        .add-task-btn {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #999;
            font-size: 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-task-btn:active {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Chat Input Bar */
        .chat-input-bar {
            position: fixed;
            bottom: 85px; /* Flush with bottom navigation */
            left: 0;
            right: 0;
            width: 100vw;
            padding: 8px 15px;
            background: rgba(21, 32, 43, 0.98);
            backdrop-filter: blur(20px);
            display: flex;
            gap: 12px;
            align-items: center;
            z-index: 60;
            box-sizing: border-box;
        }

        /* Hide chat input bar on welcome screen */
        body.welcome-active .chat-input-bar {
            display: none;
        }

        /* Responsive chat input bar */
        @media screen and (max-width: 375px) {
            .chat-input-bar {
                padding: 8px 12px;
                gap: 8px;
            }
        }

        @media screen and (min-width: 415px) {
            .chat-input-bar {
                left: 50%;
                transform: translateX(-50%);
                max-width: 428px;
                width: 100%;
            }
        }

        .bottom-chat-input {
            flex: 1;
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: #ffffff !important;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            -webkit-text-fill-color: #ffffff !important;
            -webkit-opacity: 1 !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            caret-color: #ffffff !important;
        }

        .bottom-chat-input:focus {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            color: #ffffff !important;
            -webkit-text-fill-color: #ffffff !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            caret-color: #ffffff !important;
        }

        .bottom-chat-input::placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        /* Ensure bottom chat input placeholder styling works across all browsers with higher specificity */
        .chat-input-bar .bottom-chat-input::-webkit-input-placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        .chat-input-bar .bottom-chat-input::-moz-placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        .chat-input-bar .bottom-chat-input:-ms-input-placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        /* Additional specificity for the specific bottom chat input */
        #bottomChatInput::placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }

        .voice-input-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .voice-input-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.6);
        }

        .voice-input-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .voice-input-btn.recording {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            animation: voicePulse 1.5s infinite;
        }

        @keyframes voicePulse {
            0% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5); }
            100% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
        }

        /* Ripple effect for touch feedback */
        .voice-input-btn::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0);
            transition: transform 0.3s ease;
        }

        .voice-input-btn:active::before {
            transform: scale(1.2);
            transition: transform 0.1s ease;
        }

        .ai-button {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 8px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        /* Todo List */
        .todo-list {
            list-style: none;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        /* Ensure NO text selection anywhere in todo items */
        .todo-list * {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        .todo-item {
            margin-bottom: 12px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        .todo-item-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            transition: transform 0.3s ease;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 18px 20px;
        }

        .todo-item-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            transition: all 0.3s ease;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        .todo-item-wrapper:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.08);
        }

        .todo-item.swiped .todo-item-wrapper {
            transform: translateX(-160px);
        }
        


        .todo-action-buttons {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 160px;
            display: flex;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease;
        }

        .todo-edit-area {
            width: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 0 0 0 12px;
        }

        .todo-delete-area {
            width: 80px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 0 12px 0 0;
        }

        .todo-item.swiped .todo-action-buttons {
            opacity: 1;
            transform: translateX(0);
            animation: actionButtonsReveal 0.3s ease;
        }

        /* Hide swipe actions when task is expanded */
        .todo-item.expanded .todo-action-buttons {
            display: none;
        }

        @keyframes actionButtonsReveal {
            0% { 
                opacity: 0; 
                transform: translateX(20px) scale(0.8); 
            }
            50% { 
                transform: translateX(-5px) scale(1.1); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0) scale(1); 
            }
        }

        .todo-edit-icon {
            color: white;
            font-size: 20px;
            transition: transform 0.2s ease;
        }

        .todo-delete-icon {
            color: white;
            font-size: 20px;
            transition: transform 0.2s ease;
        }

        .todo-delete-area:active .todo-delete-icon {
            transform: scale(1.2);
        }

        /* Visual feedback during swipe */
        .todo-item.swiping .todo-item-wrapper {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Visual dragging styles */
        .todo-item.dragging {
            position: fixed !important;
            z-index: 1000 !important;
            pointer-events: none;
            background: rgba(102, 126, 234, 0.2) !important;
            border-color: #667eea !important;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3), 0 0 20px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
            transition: none;
        }

        .todo-item.placeholder {
            opacity: 0.3;
            background: transparent !important;
            border: 2px dashed rgba(102, 126, 234, 0.5) !important;
        }

        .todo-item.long-pressing {
            transform: scale(1.02);
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
            transition: all 0.2s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Prevent text selection during reorder operations */
        .dragging-active {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        .dragging-active * {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        /* Visual indicators for drop position */
        .todo-item.drop-target-above {
            border-top: 4px solid #667eea;
            box-shadow: 0 -4px 8px rgba(102, 126, 234, 0.3);
        }

        .todo-item.drop-target-below {
            border-bottom: 4px solid #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        /* Smooth transitions for non-dragging items */
        .todo-item:not(.dragging):not(.placeholder) {
            transition: all 0.2s ease;
        }

        .todo-number {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            min-width: 25px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        .todo-text {
            flex: 1;
            font-size: 17px;
            color: #ffffff;
            line-height: 1.4;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        .todo-item.completed .todo-text {
            color: #666;
            text-decoration: line-through;
        }

        .todo-item.completed .todo-item-content {
            opacity: 0.7;
        }
        
        /* Add subtle border to separate completed tasks */
        .todo-item.completed {
            border-color: rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
        }

        .goal-item-in-today {
            border: 1px solid rgba(102, 126, 234, 0.3);
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            padding: 0;
            transition: all 0.3s ease;
            position: relative;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-appearance: none;
            outline: none;
        }
        
        .goal-item-in-today * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent !important;
            pointer-events: none;
        }
        
        .goal-item-in-today .goal-item-wrapper {
            pointer-events: auto;
        }
        
        .goal-item-in-today .goal-daily-checkbox {
            pointer-events: auto;
        }

        .goal-label {
            position: absolute;
            top: 8px;
            left: 12px;
            font-size: 10px;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(102, 126, 234, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        .goal-item-in-today.expanded {
            background: rgba(102, 126, 234, 0.08);
            border-color: rgba(102, 126, 234, 0.4);
        }

        .goal-item-in-today .todo-expanded-content {
            background: rgba(102, 126, 234, 0.08);
            border-top: 1px solid rgba(102, 126, 234, 0.2);
            padding: 16px;
            border-radius: 0 0 12px 12px;
        }

        .goal-item-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            transition: transform 0.3s ease;
            width: 100%;
            background: transparent;
            padding: 16px;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        .goal-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            transition: background-color 0.2s ease;
        }

        .goal-content:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .goal-title-compact {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 0;
            font-size: 16px;
            font-weight: 500;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .goal-icon {
            font-size: 14px;
        }

        .daily-task-text {
            font-size: 13px;
            color: #999;
            margin-left: 20px;
            font-weight: 400;
        }

        .goal-progress-compact {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            background: rgba(102, 126, 234, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            white-space: nowrap;
            margin-right: 8px;
        }

        .goal-details {
            margin-top: 10px;
            padding: 15px 0;
            border-top: 1px solid rgba(102, 126, 234, 0.2);
        }

        .goal-detail-item {
            margin-bottom: 8px;
            font-size: 13px;
            color: #ccc;
            line-height: 1.4;
        }

        .goal-detail-item strong {
            color: #667eea;
            margin-right: 8px;
        }

        .goal-left-content {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .goal-main-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .goal-number {
            color: #667eea;
            font-weight: 600;
            font-size: 16px;
            min-width: 24px;
        }

        .goal-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .goal-daily-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #666;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: transparent;
            position: relative;
            z-index: 20;
        }

        .goal-daily-checkbox:hover {
            border-color: #4CAF50;
            transform: scale(1.05);
        }

        .goal-daily-checkbox:active {
            transform: scale(0.95);
            background: rgba(76, 175, 80, 0.1);
        }

        .goal-daily-checkbox.checked {
            background: #4CAF50 !important;
            border-color: #4CAF50 !important;
            transform: scale(1.1);
        }

        .goal-daily-checkbox.checked::after {
            content: '✓' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            color: white !important;
            font-size: 12px !important;
            font-weight: 900 !important;
            line-height: 1 !important;
            display: block !important;
            z-index: 30 !important;
        }

        /* Task Expansion Styles */
        .todo-left-content {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .todo-main-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .todo-subtask-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 4px;
        }

        .subtask-indicator {
            font-size: 12px;
            color: #999;
            font-weight: 400;
        }

        .todo-subtask-info .expand-arrow {
            margin-left: 4px;
        }

        .expand-arrow {
            color: #999;
            font-size: 12px;
            transition: transform 0.3s ease;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .todo-main-row .expand-arrow {
            opacity: 0.7;
        }

        .todo-main-row:hover .expand-arrow {
            opacity: 1;
        }

        .todo-item.expanded .expand-arrow {
            transform: rotate(180deg);
        }

        .todo-expanded-content {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.02);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideDown 0.3s ease;
        }

        .subtasks-section {
            margin-top: 10px;
        }

        .subtasks-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #999;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .subtasks-header i {
            font-size: 12px;
        }

        .subtasks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            transition: opacity 0.3s ease;
            border-radius: 8px;
            margin: 2px 0;
        }

        .subtask-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .subtask-item.completed {
            opacity: 0.6;
        }

        .subtask-item.completed .subtask-text {
            text-decoration: line-through;
        }

        .subtask-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
        }

        .subtask-checkbox:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
        }

        .subtask-checkbox.checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .subtask-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .subtask-text {
            flex: 1;
            font-size: 14px;
            color: #ffffff;
            line-height: 1.4;
        }

        /* Task Actions in Expanded View */
        .task-actions-expanded {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .task-action-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #999;
        }

        .task-action-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .task-action-icon.edit-icon:hover {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .task-action-icon.delete-icon:hover {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .task-action-icon i {
            font-size: 14px;
        }

        /* Completion Animation */
        .completion-check {
            width: 30px;
            height: 30px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
            pointer-events: none;
            animation: completionPop 1s ease-out forwards;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
        }

        @keyframes completionPop {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            30% {
                transform: scale(1.3) rotate(10deg);
                opacity: 1;
            }
            60% {
                transform: scale(1.1) rotate(-5deg);
                opacity: 1;
            }
            80% {
                transform: scale(1.2) rotate(2deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.5) rotate(0deg);
                opacity: 0;
            }
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #666;
            background: transparent;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            z-index: 20; /* Higher z-index to ensure it's clickable */
            flex-shrink: 0;
            /* Ensure it's above other elements */
            -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
            /* Larger touch target for mobile */
            min-width: 32px;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .todo-checkbox.checked {
            background: #4CAF50 !important;
            border-color: #4CAF50 !important;
            transform: scale(1.1);
        }

        .todo-checkbox.checked::after {
            content: '✓' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            color: white !important;
            font-size: 12px !important;
            font-weight: 900 !important;
            line-height: 1 !important;
            display: block !important;
            z-index: 30 !important;
        }

        /* Ensure checkbox is always clickable */
        .todo-checkbox:hover {
            border-color: #4CAF50;
            transform: scale(1.05);
        }

        .todo-checkbox:active {
            transform: scale(0.95);
            background: rgba(76, 175, 80, 0.1);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100vw;
            height: 85px;
            background: rgba(21, 32, 43, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: 20px;
            z-index: 40;
            box-sizing: border-box;
        }

        /* Responsive bottom navigation */
        @media screen and (max-width: 375px) and (orientation: portrait) {
            .bottom-nav {
                padding-bottom: max(20px, env(safe-area-inset-bottom));
                height: auto;
                min-height: 85px;
            }
        }

        @media screen and (min-width: 415px) {
            .bottom-nav {
                left: 50%;
                transform: translateX(-50%);
                max-width: 428px;
                width: 100%;
            }
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 12px;
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.2);
        }

        .nav-item i {
            font-size: 22px;
            color: #666;
            transition: color 0.3s ease;
        }

        .nav-item.active i {
            color: #667eea;
        }

        .nav-item span {
            font-size: 11px;
            color: #666;
            font-weight: 500;
        }

        .nav-item.active span {
            color: #667eea;
        }

        /* AI Suggestions Modal */
        .ai-suggestions-modal {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 390px;
            height: 100vh;
            background: #1a1a1a;
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .ai-suggestions-modal.active {
            display: flex;
        }

        .modal-header {
            padding: 60px 20px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h3 {
            font-size: 24px;
            font-weight: 300;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .modal-header p {
            color: #999;
            font-size: 16px;
        }

        .suggestions-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .suggestion-text {
            color: #ffffff;
            font-size: 16px;
            flex: 1;
        }

        .add-suggestion-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .close-modal {
            position: absolute;
            top: 60px;
            right: 20px;
            background: none;
            border: none;
            color: #667eea;
            font-size: 18px;
            cursor: pointer;
        }

        /* Input Modal */
        .input-modal {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 390px;
            height: 100vh;
            background: #15202B;
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .input-modal.active {
            display: flex;
        }

        .input-header {
            padding: 60px 20px 40px;
            text-align: center;
        }

        .input-header h3 {
            font-size: 24px;
            font-weight: 300;
            color: #ffffff;
            margin-bottom: 30px;
        }

        .task-input {
            width: 100%;
            padding: 18px 20px;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #ffffff !important;
            font-size: 16px;
            outline: none;
            margin-bottom: 10px;
            -webkit-text-fill-color: #ffffff !important;
            -webkit-opacity: 1 !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            caret-color: #ffffff !important;
        }

        .task-input:focus {
            background: rgba(255, 255, 255, 0.15) !important;
            color: #ffffff !important;
            -webkit-text-fill-color: #ffffff !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            caret-color: #ffffff !important;
        }

        .task-input::placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        /* Ensure placeholder styling works across all browsers with higher specificity */
        .input-modal .task-input::-webkit-input-placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        .input-modal .task-input::-moz-placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        .input-modal .task-input:-ms-input-placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        /* Additional specificity for the specific input */
        #taskInput::placeholder,
        #editTaskInput::placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }

        .input-actions {
            display: flex;
            gap: 15px;
            padding: 20px;
            position: absolute;
            bottom: 40px;
            left: 0;
            right: 0;
        }

        .input-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #999;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Calendar View */
        .calendar-view {
            display: none;
            padding: 60px 15px 120px;
            box-sizing: border-box;
            width: 100%;
        }

        /* Responsive padding for iPhone 12 and smaller */
        @media screen and (max-width: 375px) {
            .calendar-view {
                padding: 55px 10px 120px;
            }
        }

        .calendar-view.active {
            display: block;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 0 10px;
        }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #667eea;
            font-size: 18px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        .calendar-month {
            font-size: 22px;
            font-weight: 600;
            color: #ffffff;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: rgba(255, 255, 255, 0.05);
            color: #999;
            padding: 12px 4px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px 4px;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .calendar-day:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .calendar-day.other-month {
            color: #444;
        }

        .calendar-day.selected {
            background: rgba(102, 126, 234, 0.3);
            color: #667eea;
            font-weight: 600;
        }

        /* Stats View */
        .stats-view {
            display: none;
            padding: 60px 15px 120px;
            box-sizing: border-box;
            width: 100%;
        }

        /* Responsive padding for iPhone 12 and smaller */
        @media screen and (max-width: 375px) {
            .stats-view {
                padding: 55px 10px 120px;
            }
        }

        .stats-view.active {
            display: block;
        }

        .stats-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .stats-header h2 {
            font-size: 28px;
            font-weight: 300;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }

                 .stat-label {
            font-size: 14px;
            color: #999;
            font-weight: 500;
        }

        /* Goals List Styling */
        .goals-list {
            margin-bottom: 20px;
        }

        .goal-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 0;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .goal-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .goal-item.completed {
            background: rgba(81, 207, 102, 0.1);
            border-color: rgba(81, 207, 102, 0.3);
        }

        .goal-main {
            padding: 20px;
        }

        .goal-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .goal-title-container {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .goal-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
            flex: 1;
            line-height: 1.3;
        }

        .goal-item.completed .goal-title {
            text-decoration: line-through;
            color: #51cf66;
        }

        .goal-progress-container {
            display: flex;
            align-items: center;
        }

        .goal-progress-text {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            min-width: 50px;
            text-align: right;
        }

        .goal-content {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .goal-content:active {
            transform: scale(0.98);
        }

        .goal-priority {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .goal-priority.low {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .goal-priority.medium {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
        }

        .goal-priority.high {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        .goal-description {
            color: #999;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .goal-description {
            color: #cccccc;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .goal-progress {
            margin-bottom: 16px;
        }

        .goal-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 8px;
            transition: width 0.3s ease;
        }

        .goal-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        .goal-target-date {
            color: #999;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .goal-categories {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .goal-progress-text {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            min-width: 40px;
        }

        .goal-actions {
            display: none;
            gap: 12px;
            justify-content: center;
            padding: 15px 20px 5px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 15px;
            animation: slideDown 0.3s ease;
        }

        .goal-item.expanded .goal-actions {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .goal-action-btn {
            flex: 1;
            height: 44px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 600;
            max-width: 120px;
        }

        .goal-edit-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .goal-edit-btn:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        .goal-delete-btn {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        .goal-delete-btn:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        .goal-complete-btn {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .goal-complete-btn:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .empty-goals {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-goals i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-goals h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-goals p {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Voice Recording Modal */
        .voice-modal {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 390px;
            height: 100vh;
            background: #15202B;
            z-index: 200;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .voice-modal.active {
            display: flex;
        }

        .voice-animation {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .voice-animation:active {
            transform: scale(0.95);
        }

        .voice-animation.recording {
            animation: voicePulse 1s infinite;
        }

        .voice-animation::before {
            content: '';
            position: absolute;
            width: 140px;
            height: 140px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
        }

        .voice-animation.recording::before {
            animation: ripple 1.5s infinite;
        }

        @keyframes voicePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }

        .voice-animation i {
            font-size: 40px;
            color: white;
        }

        .voice-status {
            text-align: center;
            margin-bottom: 30px;
        }

        .voice-status h3 {
            font-size: 24px;
            font-weight: 300;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .voice-status p {
            color: #999;
            font-size: 16px;
            line-height: 1.5;
        }

        .voice-transcript {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }

        .voice-transcript-text {
            color: #ffffff;
            font-size: 16px;
            line-height: 1.5;
        }

        .voice-controls {
            display: flex;
            gap: 20px;
            margin-top: 40px;
        }

        .voice-control-btn {
            padding: 16px 24px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-stop {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .btn-process {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #999;
        }

        /* AI Chat Modal */
        .ai-chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100vw;
            height: 100vh;
            background: #15202B;
            z-index: 200;
            display: none;
            flex-direction: column;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* Responsive modal for larger screens */
        @media screen and (min-width: 415px) {
            .ai-chat-modal {
                left: 50%;
                transform: translateX(-50%);
                max-width: 428px;
                width: 100%;
            }
        }

        .ai-chat-modal.active {
            display: flex;
        }

        /* Make chat input more visible on mobile */
        .ai-chat-modal.active .chat-input {
            color: white !important;
            -webkit-text-fill-color: white !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }

        .chat-header {
            padding: 50px 20px 15px; /* Increased top padding to avoid bezel cutoff */
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .chat-header h3 {
            font-size: 18px; /* Smaller header text */
            font-weight: 300;
            color: #ffffff;
            margin-bottom: 3px; /* Reduced margin */
        }

        .chat-header p {
            color: #999;
            font-size: 12px; /* Smaller subtitle */
        }

        .chat-messages {
            flex: 1;
            padding: 15px 20px; /* Reduced top/bottom padding */
            padding-bottom: 200px; /* Normal padding since tasks are now fixed */
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            gap: 8px; /* Reduced gap between messages to save space */
            overscroll-behavior: contain;
            height: auto;
            max-height: calc(100vh - 200px); /* Normal height */
            min-height: 300px;
            scroll-behavior: smooth;
            /* Force scroll container properties */
            position: relative;
            z-index: 1;
        }

        /* Responsive layout for different screen sizes */
        @media screen and (max-width: 428px) {
            .detected-tasks-container {
                left: 10px;
                right: 10px;
                bottom: 180px;
            }
        }

        @media screen and (max-height: 900px) {
            .chat-messages {
                max-height: calc(100vh - 200px);
                padding-bottom: 200px;
            }
            .detected-tasks-container {
                bottom: 185px;
            }
            .chat-input-bar {
                bottom: 85px;
            }
        }

        @media screen and (max-height: 800px) {
            .chat-messages {
                max-height: calc(100vh - 190px);
                padding-bottom: 180px;
            }
            .detected-tasks-container {
                bottom: 175px;
            }
            .chat-input-bar {
                bottom: 85px;
            }
        }

        @media screen and (max-height: 700px) {
            .chat-messages {
                max-height: calc(100vh - 180px);
                padding-bottom: 160px;
            }
            .detected-tasks-container {
                bottom: 165px;
            }
            .chat-input-bar {
                bottom: 85px;
            }
        }
        
        @media screen and (max-height: 600px) {
            .chat-messages {
                max-height: calc(100vh - 170px);
                padding-bottom: 140px;
            }
            .detected-tasks-container {
                bottom: 155px;
            }
            .chat-input-bar {
                bottom: 85px;
            }
        }

        .ai-message,
        .user-message {
            display: flex;
            max-width: 90%; /* Increased width for better readability */
        }

        .ai-message {
            align-self: flex-start;
        }

        .user-message {
            align-self: flex-end;
        }

        .message-bubble {
            padding: 12px 16px; /* Increased padding for better readability */
            border-radius: 12px;
            font-size: 14px; /* Increased font size */
            line-height: 1.4; /* Better line spacing */
            word-wrap: break-word;
        }

        .ai-bubble {
            background: rgba(102, 126, 234, 0.2);
            color: #ffffff;
            border-bottom-left-radius: 6px;
            max-height: 300px; /* Increased height limit for longer messages */
            overflow-y: auto; /* Allow scrolling if too long */
        }

        .ai-bubble i {
            color: #667eea;
            margin-right: 8px;
            font-size: 14px;
        }

        .user-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .chat-input-container {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            align-items: center;
            background: rgba(21, 32, 43, 0.95);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-sizing: border-box;
            min-height: 80px;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }

        /* Responsive positioning for larger screens */
        @media screen and (min-width: 415px) {
            .chat-input-container {
                left: 50%;
                transform: translateX(-50%);
                max-width: 428px;
                width: 100%;
            }
            
            .detected-tasks-container {
                max-width: 388px;
                margin: 15px auto;
            }
        }
        
        /* Mobile responsive styling for detected tasks */
        @media screen and (max-width: 414px) {
            .detected-tasks-container {
                margin: 15px 0 !important;
                padding: 12px !important;
                border-radius: 8px !important;
            }
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: #ffffff;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s ease;
            -webkit-text-fill-color: #ffffff;
            -webkit-opacity: 1;
            -webkit-appearance: none;
            appearance: none;
            caret-color: #ffffff;
        }

        .chat-input:focus {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
            -webkit-text-fill-color: #ffffff;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        /* Ensure chat input placeholder styling works across all browsers with higher specificity */
        .ai-chat-modal .chat-input::-webkit-input-placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        .ai-chat-modal .chat-input::-moz-placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        .ai-chat-modal .chat-input:-ms-input-placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }
        
        /* Additional specificity for the specific chat input */
        #chatInput::placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
            opacity: 0.4 !important;
        }

        /* Make chat input more visible on mobile */
        .ai-chat-modal.active .chat-input {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3) !important;
            border: 2px solid rgba(255, 255, 255, 0.4) !important;
            background: rgba(255, 255, 255, 0.2) !important;
        }

        /* Detected Tasks Styling - Fixed position above input bar */
        .detected-tasks-container {
            position: fixed;
            bottom: 115px; /* Reduced gap by half - closer to input bar */
            left: 15px;
            right: 15px;
            background: rgba(102, 126, 234, 0.25);
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 12px;
            padding: 15px;
            animation: slideDown 0.3s ease-out;
            z-index: 75; /* Higher than input bar z-index (60) */
            pointer-events: auto;
            touch-action: auto;
            display: none;
            visibility: visible;
            opacity: 1;
            backdrop-filter: blur(15px);
            box-sizing: border-box;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
            max-width: 400px;
            margin: 0 auto;
        }

        .detected-tasks-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .detected-tasks-header i {
            font-size: 16px;
        }

        .detected-tasks-list {
            margin-bottom: 15px;
            min-height: 50px;
            position: relative;
            z-index: 1;
            /* Debug styling to make it visible */
            /* border: 2px solid red; */
        }

        .detected-task-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            color: #ffffff;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detected-task-item:last-child {
            margin-bottom: 0;
        }

        .detected-task-item i {
            color: #667eea;
            font-size: 14px;
        }

        .detected-tasks-actions {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            padding: 12px 0 0 0; /* Simple top padding only */
            border-top: 1px solid rgba(102, 126, 234, 0.4);
        }

        .approve-tasks-btn {
            flex: 1;
            padding: 14px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 80;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.6);
            min-height: 48px;
        }

        .approve-tasks-btn:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #5a6edb 0%, #6a4193 100%);
        }

        .dismiss-tasks-btn {
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: #ffffff;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 80;
            min-height: 48px;
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.2);
        }

        .dismiss-tasks-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.05);
        }

        .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }



        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .create-tasks-btn {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .create-tasks-btn:active {
            transform: scale(0.95);
        }

        .create-tasks-btn i {
            font-size: 11px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-size: 14px;
            font-style: italic;
            padding: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            background: #667eea;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Day Schedule View */
        .day-schedule-view {
            display: none;
            min-height: 100vh;
            padding: 0;
            background: #15202B;
        }

        .day-schedule-view.active {
            display: block;
        }

        .day-schedule-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 390px;
            height: 80px;
            background: rgba(21, 32, 43, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #667eea;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .back-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.15);
        }

        .day-schedule-title {
            text-align: center;
            flex: 1;
        }

        .day-schedule-title h2 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 2px;
        }

        .day-schedule-title p {
            font-size: 12px;
            color: #999;
        }

        .add-time-task-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .add-time-task-btn:active {
            transform: scale(0.95);
        }

        .time-slots-container {
            padding: 90px 0 150px;
            height: 100vh;
            overflow-y: auto;
        }

        .time-slot {
            display: flex;
            padding: 0 20px;
            margin-bottom: 1px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 60px;
            align-items: stretch;
        }

        .time-slot:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .time-label {
            width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            margin-right: 15px;
        }

        .time-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 10px 0;
            cursor: pointer;
        }

        .time-content.empty {
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }

        .time-content.empty:hover {
            color: #667eea;
        }

        .scheduled-task {
            background: rgba(102, 126, 234, 0.15);
            border-left: 4px solid #667eea;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 4px 0;
        }

        .scheduled-task-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .scheduled-task-duration {
            font-size: 11px;
            color: #667eea;
        }

        .scheduled-task-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .task-action-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .task-action-btn:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .task-action-btn.complete {
            color: #51cf66;
        }

        .task-action-btn.delete {
            color: #ff6b6b;
        }

        /* Time Task Modal */
        .time-task-modal {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 390px;
            height: 100vh;
            background: #15202B;
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .time-task-modal.active {
            display: flex;
        }

        .time-task-header {
            padding: 60px 20px 30px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .time-task-header h3 {
            font-size: 24px;
            font-weight: 300;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .time-task-header p {
            color: #999;
            font-size: 14px;
        }

        .time-task-form {
            flex: 1;
            padding: 30px 20px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .time-task-input,
        .time-slot-select,
        .duration-select {
            width: 100%;
            padding: 15px 18px;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #ffffff !important;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            -webkit-text-fill-color: #ffffff !important;
            -webkit-opacity: 1 !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            caret-color: #ffffff !important;
        }

        .time-task-input:focus,
        .time-slot-select:focus,
        .duration-select:focus {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15) !important;
            color: #ffffff !important;
            -webkit-text-fill-color: #ffffff !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            caret-color: #ffffff !important;
        }

        .time-task-input::placeholder {
            color: #666 !important;
        }

        select option {
            background: #15202B;
            color: #ffffff;
        }

        .time-task-actions {
            display: flex;
            gap: 15px;
            padding: 20px;
        }

        .time-task-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .time-task-btn.btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #999;
        }

        .time-task-btn.btn-schedule {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Hour markers */
        .time-slot.hour-marker {
            background: rgba(255, 255, 255, 0.08);
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        .time-slot.hour-marker .time-label {
            color: #667eea;
            font-weight: 700;
        }

        /* Task Detail Modal */
        .task-detail-modal {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 390px;
            height: 100vh;
            background: #15202B;
            z-index: 300;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .task-detail-modal.active {
            display: flex;
        }

        .task-detail-header {
            padding: 50px 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: #15202B;
            z-index: 10;
        }

        .task-detail-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
            margin: 0;
        }

        .task-detail-content {
            flex: 1;
            padding: 20px;
        }

        .task-main-info {
            margin-bottom: 30px;
        }

        .task-title-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .task-status-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid #4CAF50;
            background: transparent;
            flex-shrink: 0;
        }

        .task-status-circle.completed {
            background: #4CAF50;
        }

        .task-title {
            flex: 1;
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .task-priority {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .task-priority.low {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .task-priority.medium {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
        }

        .task-priority.high {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        .task-progress {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #51cf66, #4CAF50);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #999;
            text-align: center;
        }

        .task-details-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-size: 16px;
        }

        .detail-label {
            color: #999;
            font-size: 14px;
            min-width: 100px;
        }

        .detail-value {
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
        }

        .category-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .category-tag {
            padding: 4px 12px;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Frequency Selection Styles */
        .frequency-options {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .frequency-btn {
            flex: 1;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }

        .frequency-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-1px);
        }

        .frequency-btn.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            color: #667eea;
        }

        .frequency-btn i {
            font-size: 16px;
        }

        /* Frequency Count Selector Styles */
        .frequency-count-selector {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: nowrap;
            justify-content: space-between;
        }

        .count-btn {
            flex: 1;
            min-width: 40px;
            height: 44px;
            padding: 8px 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
        }

        .count-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-1px);
        }

        .count-btn.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            color: #667eea;
        }

        /* Days Selector Styles */
        .days-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .day-btn {
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            text-align: center;
            min-height: 60px;
        }

        .day-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-1px);
        }

        .day-btn.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            color: #667eea;
        }

        .day-short {
            font-size: 16px;
            font-weight: 600;
        }

        .day-full {
            font-size: 10px;
            opacity: 0.8;
        }

        .frequency-summary {
            margin-top: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .summary-text {
            color: #cccccc;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Mobile responsive for days selector */
        @media (max-width: 480px) {
            .days-selector {
                grid-template-columns: repeat(7, 1fr);
                gap: 4px;
            }
            
            .day-btn {
                padding: 8px 4px;
                min-height: 50px;
            }
            
            .day-short {
                font-size: 14px;
            }
            
            .day-full {
                font-size: 9px;
            }
        }

        .subtasks-section {
            margin-bottom: 30px;
        }

        .subtasks-header {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .subtask-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #666;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .subtask-checkbox.completed {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .subtask-checkbox.completed::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .subtask-text {
            flex: 1;
            font-size: 15px;
            color: #ffffff;
        }

        .subtask-text.completed {
            text-decoration: line-through;
            color: #666;
        }

        .notes-section {
            margin-bottom: 30px;
        }

        .notes-header {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .notes-content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.5;
            min-height: 80px;
        }

        .task-actions {
            display: flex;
            gap: 15px;
            padding: 20px;
            position: sticky;
            bottom: 0;
            background: #15202B;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .task-action-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .btn-complete {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
        }

        .btn-edit:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-complete:active {
            transform: scale(0.98);
            background: linear-gradient(135deg, #45c55a 0%, #2da842 100%);
        }

        /* Task Detail Modal Close Button */
        .task-detail-modal .close-modal {
            position: absolute;
            top: 50px;
            right: 20px;
            background: none;
            border: none;
            color: #667eea;
            font-size: 18px;
            cursor: pointer;
            z-index: 20;
        }

        /* Enhanced Input Modal Styles */
        .enhanced-input-modal {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 390px;
            height: 100vh;
            background: #15202B;
            z-index: 300;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .enhanced-input-modal.active {
            display: flex;
        }

        .enhanced-modal-header {
            padding: 50px 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: #15202B;
            z-index: 10;
        }

        .enhanced-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
            margin: 0;
        }

        .enhanced-modal-header .close-modal {
            position: absolute;
            top: 50px;
            right: 20px;
            background: none;
            border: none;
            color: #667eea;
            font-size: 18px;
            cursor: pointer;
            z-index: 20;
        }

        .enhanced-modal-content {
            flex: 1;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-label i {
            color: #667eea;
            width: 16px;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        .form-input::placeholder {
            color: #666;
        }

        .form-textarea {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        .form-textarea::placeholder {
            color: #666;
        }

        /* Priority Buttons */
        .priority-buttons {
            display: flex;
            gap: 10px;
        }

        .priority-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .priority-btn:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .priority-btn.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .priority-btn.low .priority-dot {
            background: #4CAF50;
        }

        .priority-btn.medium .priority-dot {
            background: #FF9800;
        }

        .priority-btn.high .priority-dot {
            background: #F44336;
        }

        /* Category and Subtask Input */
        .category-input-container,
        .subtask-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .subtask-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .subtask-input-wrapper .form-input {
            flex: 1;
        }

        .add-subtask-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .add-subtask-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .add-subtask-btn:active {
            transform: scale(0.95);
        }

        .selected-categories,
        .added-subtasks {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .category-item .remove-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin-left: 4px;
        }

        .subtask-item-form {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .subtask-item-form:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .subtask-number {
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
            min-width: 20px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .subtask-item-form .subtask-text {
            flex: 1;
            color: #ffffff;
            font-size: 14px;
        }

        .subtask-item-form .remove-btn {
            background: none;
            border: none;
            color: #F44336;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
        }

        /* Enhanced Modal Actions */
        .enhanced-modal-actions {
            display: flex;
            gap: 15px;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            bottom: 0;
            background: #15202B;
        }

        .modal-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .modal-btn.btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- Status Bar -->
        <div class="status-bar">
            <button class="settings-btn" onclick="showSettings()" title="AI Settings">
                <i class="fas fa-cog"></i>
            </button>
            <span>Memaster</span>
            <div class="sync-status offline" id="syncStatus">
                <i class="fas fa-wifi sync-icon" id="syncIcon"></i>
                <span id="syncText">Offline</span>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen" onclick="showMainApp()">
            <div class="app-logo">
                <i class="fas fa-tasks"></i>
            </div>
            <h1>MeMaster - Task & Goal Manager</h1>
            <p class="welcome-subtitle">Click anywhere to get started</p>
        </div>

        <!-- Main App Screen -->
        <div class="main-screen" id="mainScreen">
            <div class="question-header">
                <h2>What would you like to get done today?</h2>
            </div>

            <div class="add-task-container">
                <button class="add-task-btn" onclick="showInputModal()">
                    Add Task
                </button>
            </div>



            <ul class="todo-list" id="todoList">
                <!-- Todos will be populated here -->
            </ul>
        </div>

        <!-- Calendar View -->
        <div class="calendar-view" id="calendarView">
            <div class="calendar-header">
                <button class="calendar-nav-btn" onclick="previousMonth()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="calendar-month" id="calendarMonth">January 2024</div>
                <button class="calendar-nav-btn" onclick="nextMonth()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated -->
            </div>
        </div>

        <!-- Goals View -->
        <div class="stats-view" id="statsView">
            <div class="stats-header">
                <h2>Your Goals</h2>
                <p>Set and track your long-term objectives</p>
            </div>
            
            <!-- Add Goal Button -->
            <div class="add-task-container">
                <button class="add-task-btn" onclick="showGoalModal()">
                    Add Goal
                </button>
            </div>
            
            <!-- Goals List -->
            <div class="goals-list" id="goalsList">
                <!-- Goals will be populated here -->
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid" style="margin-top: 30px;">
                <div class="stat-card">
                    <div class="stat-number" id="totalGoalsCount">0</div>
                    <div class="stat-label">Total Goals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedGoalsCount">0</div>
                    <div class="stat-label">Achieved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTasksCount">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionPercentage">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>
        </div>

        <!-- Day Schedule View -->
        <div class="day-schedule-view" id="dayScheduleView">
            <div class="day-schedule-header">
                <button class="back-btn" onclick="closeDaySchedule()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="day-schedule-title">
                    <h2 id="dayScheduleDate">Today's Schedule</h2>
                    <p id="dayScheduleSubtitle">Plan your perfect day</p>
                </div>
                <button class="add-time-task-btn" onclick="showTimeTaskModal()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="time-slots-container" id="timeSlotsContainer">
                <!-- Time slots will be generated here -->
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showView('main')">
                <i class="fas fa-tasks"></i>
                <span>Today</span>
            </div>
            <div class="nav-item" onclick="showView('calendar')">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendar</span>
            </div>
            <div class="nav-item" onclick="showView('stats')">
                <i class="fas fa-chart-bar"></i>
                <span>Goals</span>
            </div>
        </div>

        <!-- AI Suggestions Modal -->
        <div class="ai-suggestions-modal" id="aiModal">
            <button class="close-modal" onclick="closeAIModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h3>AI Suggestions</h3>
                <p>Smart recommendations for your day</p>
            </div>
            <div class="suggestions-list" id="suggestionsList">
                <!-- AI suggestions will be populated here -->
            </div>
        </div>

                 <!-- Enhanced Add Task Modal -->
        <div class="enhanced-input-modal" id="inputModal">
            <div class="enhanced-modal-header">
                <button class="close-modal" onclick="closeInputModal()">
                    <i class="fas fa-times"></i>
                </button>
                <h3>Add New Task</h3>
            </div>
            
            <div class="enhanced-modal-content">
                <!-- Task Title -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-edit"></i>
                        Task Title
                    </label>
                    <input type="text" class="form-input" id="taskInput" placeholder="What do you want to accomplish?">
                </div>
                
                <!-- Priority -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-flag"></i>
                        Priority
                    </label>
                    <div class="priority-buttons">
                        <button type="button" class="priority-btn low" data-priority="low">
                            <span class="priority-dot"></span>
                            Low
                        </button>
                        <button type="button" class="priority-btn medium active" data-priority="medium">
                            <span class="priority-dot"></span>
                            Medium
                        </button>
                        <button type="button" class="priority-btn high" data-priority="high">
                            <span class="priority-dot"></span>
                            High
                        </button>
                    </div>
                </div>
                
                <!-- Due Date -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i>
                        Due Date
                    </label>
                    <input type="date" class="form-input" id="taskDueInput">
                </div>
                
                <!-- Estimated Time -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-clock"></i>
                        Estimated Time
                    </label>
                    <select class="form-input" id="taskTimeInput">
                        <option value="">Select time needed</option>
                        <option value="30 minutes">30 minutes</option>
                        <option value="1 hour">1 hour</option>
                        <option value="2 hours">2 hours</option>
                        <option value="3 hours">3 hours</option>
                        <option value="4 hours">4 hours</option>
                        <option value="8 hours">8 hours</option>
                        <option value="1 day">1 day</option>
                        <option value="2 days">2 days</option>
                        <option value="1 week">1 week</option>
                    </select>
                </div>
                
                <!-- Categories -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-tag"></i>
                        Categories
                    </label>
                    <div class="category-input-container">
                        <input type="text" class="form-input" id="taskCategoryInput" placeholder="Add categories (press Enter)">
                        <div class="selected-categories" id="selectedCategories"></div>
                    </div>
                </div>
                
                <!-- Reminder -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-bell"></i>
                        Reminder
                    </label>
                    <select class="form-input" id="taskReminderInput">
                        <option value="">No reminder</option>
                        <option value="Today 9:00 AM">Today 9:00 AM</option>
                        <option value="Tomorrow 9:00 AM">Tomorrow 9:00 AM</option>
                        <option value="1 hour before due">1 hour before due</option>
                        <option value="1 day before due">1 day before due</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                
                <!-- Subtasks -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-list"></i>
                        Subtasks
                    </label>
                    <div class="subtask-input-container">
                        <div class="added-subtasks" id="addedSubtasks"></div>
                        <div class="subtask-input-wrapper">
                            <input type="text" class="form-input" id="subtaskInput" placeholder="Add subtask (press Enter to add more)">
                            <button type="button" class="add-subtask-btn" onclick="addSubtaskFromInput('subtaskInput')" title="Add subtask">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="subtask-hint" style="font-size: 12px; color: #999; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> Press Enter or click + to add each subtask
                        </div>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Notes
                    </label>
                    <textarea class="form-textarea" id="taskNotesInput" placeholder="Add any additional notes or details..."></textarea>
                </div>
            </div>
            
            <div class="enhanced-modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeInputModal()">Cancel</button>
                <button class="modal-btn btn-add" onclick="addEnhancedTask()">Add Task</button>
            </div>
        </div>

        <!-- Enhanced Edit Modal -->
        <div class="enhanced-input-modal" id="editModal">
            <div class="enhanced-modal-header">
                <button class="close-modal" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
                <h3>Edit Task</h3>
            </div>
            
            <div class="enhanced-modal-content">
                <!-- Task Title -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-edit"></i>
                        Task Title
                    </label>
                    <input type="text" class="form-input" id="editTaskInput" placeholder="Edit your task">
                </div>
                
                <!-- Priority -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-flag"></i>
                        Priority
                    </label>
                    <div class="priority-buttons">
                        <button type="button" class="priority-btn low" data-priority="low">
                            <span class="priority-dot"></span>
                            Low
                        </button>
                        <button type="button" class="priority-btn medium active" data-priority="medium">
                            <span class="priority-dot"></span>
                            Medium
                        </button>
                        <button type="button" class="priority-btn high" data-priority="high">
                            <span class="priority-dot"></span>
                            High
                        </button>
                    </div>
                </div>
                
                <!-- Due Date -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i>
                        Due Date
                    </label>
                    <input type="date" class="form-input" id="editTaskDueInput">
                </div>
                
                <!-- Estimated Time -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-clock"></i>
                        Estimated Time
                    </label>
                    <select class="form-input" id="editTaskTimeInput">
                        <option value="">Select time needed</option>
                        <option value="30 minutes">30 minutes</option>
                        <option value="1 hour">1 hour</option>
                        <option value="2 hours">2 hours</option>
                        <option value="3 hours">3 hours</option>
                        <option value="4 hours">4 hours</option>
                        <option value="8 hours">8 hours</option>
                        <option value="1 day">1 day</option>
                        <option value="2 days">2 days</option>
                        <option value="1 week">1 week</option>
                    </select>
                </div>
                
                <!-- Categories -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-tag"></i>
                        Categories
                    </label>
                    <div class="category-input-container">
                        <input type="text" class="form-input" id="editTaskCategoryInput" placeholder="Add categories (press Enter)">
                        <div class="selected-categories" id="editSelectedCategories"></div>
                    </div>
                </div>
                
                <!-- Reminder -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-bell"></i>
                        Reminder
                    </label>
                    <select class="form-input" id="editTaskReminderInput">
                        <option value="">No reminder</option>
                        <option value="Today 9:00 AM">Today 9:00 AM</option>
                        <option value="Tomorrow 9:00 AM">Tomorrow 9:00 AM</option>
                        <option value="1 hour before due">1 hour before due</option>
                        <option value="1 day before due">1 day before due</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                
                <!-- Subtasks -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-list"></i>
                        Subtasks
                    </label>
                    <div class="subtask-input-container">
                        <div class="added-subtasks" id="editAddedSubtasks"></div>
                        <div class="subtask-input-wrapper">
                            <input type="text" class="form-input" id="editSubtaskInput" placeholder="Add subtask (press Enter to add more)">
                            <button type="button" class="add-subtask-btn" onclick="addSubtaskFromInput('editSubtaskInput')" title="Add subtask">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="subtask-hint" style="font-size: 12px; color: #999; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> Press Enter or click + to add each subtask
                        </div>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Notes
                    </label>
                    <textarea class="form-textarea" id="editTaskNotesInput" placeholder="Add any additional notes or details..."></textarea>
                </div>
            </div>
            
            <div class="enhanced-modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn btn-add" onclick="saveEnhancedTask()">Save Changes</button>
            </div>
        </div>

                 <!-- Voice Recording Modal -->
        <div class="voice-modal" id="voiceModal">
            <div class="voice-animation" id="voiceAnimation" onclick="handleVoiceAnimationClick()">
                <i class="fas fa-microphone"></i>
            </div>
            
            <div class="voice-status" id="voiceStatus">
                <h3>Tap to start speaking</h3>
                <p>Tell me what you want to get done today.<br>I'll create a todo list for you!</p>
            </div>

            <div class="voice-transcript" id="voiceTranscript" style="display: none;">
                <div class="voice-transcript-text" id="transcriptText"></div>
            </div>

            <div class="voice-controls">
                <button class="voice-control-btn btn-cancel" onclick="cancelVoiceInput()">
                    Cancel
                </button>
                <button class="voice-control-btn btn-stop" id="voiceStopBtn" onclick="stopVoiceInput()" style="display: none;">
                    Stop Recording
                </button>
                <button class="voice-control-btn btn-process" id="voiceProcessBtn" onclick="processVoiceInput()" style="display: none;">
                    Create Tasks
                </button>
            </div>
        </div>

        <!-- API Settings Modal -->
        <div class="enhanced-input-modal" id="settingsModal">
            <div class="enhanced-modal-header">
                <button class="close-modal" onclick="closeSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
                <h3>AI Assistant Settings</h3>
            </div>
            
            <div class="enhanced-modal-content">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-key"></i>
                        Gemini API Key
                    </label>
                    <input type="password" class="form-input" id="apiKeyInput" 
                           placeholder="Enter your Gemini API key here...">
                    <div style="margin-top: 8px; font-size: 12px; color: #999; line-height: 1.4;">
                        Get your free API key at: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #667eea;">aistudio.google.com/app/apikey</a>
                        <br>Current status: <span id="apiStatus" style="font-weight: bold;"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-robot"></i>
                        AI Model
                    </label>
                    <select class="form-input" id="modelSelect">
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash (Recommended)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-cog"></i>
                        Response Style
                    </label>
                    <select class="form-input" id="responseStyleSelect">
                        <option value="casual">Casual & Friendly</option>
                        <option value="professional">Professional</option>
                        <option value="concise">Brief & Concise</option>
                        <option value="detailed">Detailed & Helpful</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <div class="form-label" style="margin-bottom: 15px;">
                        <i class="fas fa-flask"></i>
                        Test Your Setup
                    </div>
                    <button type="button" class="priority-btn" onclick="testGeminiAPI()" id="testApiBtn" 
                            style="width: 100%; justify-content: center; padding: 12px;">
                        <i class="fas fa-play"></i>
                        Test AI Connection
                    </button>
                    <div id="testResult" style="margin-top: 10px; font-size: 14px; padding: 10px; border-radius: 8px; display: none;"></div>
                </div>
            </div>
            
            <div class="enhanced-modal-actions">
                <button class="modal-btn btn-cancel" onclick="clearGeminiApiKey(); closeSettingsModal();">Clear & Close</button>
                <button class="modal-btn btn-add" onclick="saveApiSettings()">Save Settings</button>
            </div>
        </div>

        <!-- Goal Modal -->
        <div class="enhanced-input-modal" id="goalModal">
            <div class="enhanced-modal-header">
                <button class="close-modal" onclick="closeGoalModal()">
                    <i class="fas fa-times"></i>
                </button>
                <h3 id="goalModalTitle">Add New Goal</h3>
            </div>
            
            <div class="enhanced-modal-content">
                <!-- Goal Title -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-bullseye"></i>
                        Goal Title
                    </label>
                    <input type="text" class="form-input" id="goalTitleInput" placeholder="What do you want to achieve?">
                </div>
                
                <!-- Goal Description -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-align-left"></i>
                        Description
                    </label>
                    <textarea class="form-textarea" id="goalDescriptionInput" placeholder="Describe your goal in detail..."></textarea>
                </div>
                
                <!-- Priority -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-flag"></i>
                        Priority
                    </label>
                    <div class="priority-buttons">
                        <button type="button" class="priority-btn low" data-priority="low">
                            <span class="priority-dot"></span>
                            Low
                        </button>
                        <button type="button" class="priority-btn medium active" data-priority="medium">
                            <span class="priority-dot"></span>
                            Medium
                        </button>
                        <button type="button" class="priority-btn high" data-priority="high">
                            <span class="priority-dot"></span>
                            High
                        </button>
                    </div>
                </div>
                
                <!-- Target Date -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar-check"></i>
                        Target Date
                    </label>
                    <input type="date" class="form-input" id="goalTargetDateInput">
                </div>
                
                <!-- Progress -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-percentage"></i>
                        Current Progress
                    </label>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="range" class="form-input" id="goalProgressInput" min="0" max="100" value="0" 
                               style="flex: 1;" oninput="updateProgressDisplay(this.value)">
                        <span id="progressDisplay" style="color: #667eea; font-weight: 600; min-width: 40px;">0%</span>
                    </div>
                </div>
                
                <!-- Categories -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-tag"></i>
                        Categories
                    </label>
                    <div class="category-input-container">
                        <input type="text" class="form-input" id="goalCategoryInput" placeholder="Add categories (press Enter)">
                        <div class="selected-categories" id="goalSelectedCategories"></div>
                    </div>
                </div>
                
                <!-- Goals automatically appear in Today tab based on frequency -->

                <!-- Weekly Frequency -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar-week"></i>
                        Frequency
                    </label>
                    <div class="frequency-options">
                        <button type="button" class="frequency-btn active" data-frequency="daily">
                            <span>Daily</span>
                        </button>
                        <button type="button" class="frequency-btn" data-frequency="weekly">
                            <span>Weekly Schedule</span>
                        </button>
                        <button type="button" class="frequency-btn" data-frequency="flexible">
                            <span>X Times/Week</span>
                        </button>
                    </div>
                </div>

                <!-- Flexible Frequency Count (shown when X Times/Week is selected) -->
                <div class="form-group" id="flexibleFrequencyGroup" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-hashtag"></i>
                        Times per Week
                    </label>
                    <div class="frequency-count-selector">
                        <button type="button" class="count-btn" data-count="1">1</button>
                        <button type="button" class="count-btn" data-count="2">2</button>
                        <button type="button" class="count-btn active" data-count="3">3</button>
                        <button type="button" class="count-btn" data-count="4">4</button>
                        <button type="button" class="count-btn" data-count="5">5</button>
                        <button type="button" class="count-btn" data-count="6">6</button>
                        <button type="button" class="count-btn" data-count="7">7</button>
                    </div>
                    <div class="frequency-summary" id="flexibleSummary">
                        <span class="summary-text">Appears daily - complete 3 times per week</span>
                    </div>
                </div>

                <!-- Days of Week (shown when Weekly Schedule is selected) -->
                <div class="form-group" id="daysOfWeekGroup" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-calendar-check"></i>
                        Select Days
                    </label>
                    <div class="days-selector">
                        <button type="button" class="day-btn" data-day="monday">
                            <span class="day-short">M</span>
                            <span class="day-full">Mon</span>
                        </button>
                        <button type="button" class="day-btn" data-day="tuesday">
                            <span class="day-short">T</span>
                            <span class="day-full">Tue</span>
                        </button>
                        <button type="button" class="day-btn" data-day="wednesday">
                            <span class="day-short">W</span>
                            <span class="day-full">Wed</span>
                        </button>
                        <button type="button" class="day-btn" data-day="thursday">
                            <span class="day-short">T</span>
                            <span class="day-full">Thu</span>
                        </button>
                        <button type="button" class="day-btn" data-day="friday">
                            <span class="day-short">F</span>
                            <span class="day-full">Fri</span>
                        </button>
                        <button type="button" class="day-btn" data-day="saturday">
                            <span class="day-short">S</span>
                            <span class="day-full">Sat</span>
                        </button>
                        <button type="button" class="day-btn" data-day="sunday">
                            <span class="day-short">S</span>
                            <span class="day-full">Sun</span>
                        </button>
                    </div>
                    <div class="frequency-summary" id="frequencySummary">
                        <span class="summary-text">Select days to work on this goal</span>
                    </div>
                </div>
            </div>
            
            <div class="enhanced-modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeGoalModal()">Cancel</button>
                <button class="modal-btn btn-add" id="goalSubmitBtn" onclick="saveGoal()">Add Goal</button>
            </div>
        </div>

        <!-- Time Task Modal -->
        <div class="time-task-modal" id="timeTaskModal">
            <button class="close-modal" onclick="closeTimeTaskModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="time-task-header">
                <h3>Schedule Task</h3>
                <p>Add a task to your daily schedule</p>
            </div>
            
            <div class="time-task-form">
                <div class="form-group">
                    <label>Task Description</label>
                    <input type="text" class="time-task-input" id="timeTaskInput" placeholder="What do you want to do?">
                </div>
                
                <div class="form-group">
                    <label>Time Slot</label>
                    <select class="time-slot-select" id="timeSlotSelect">
                        <!-- Time options will be populated -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Duration</label>
                    <select class="duration-select" id="durationSelect">
                        <option value="15">15 minutes</option>
                        <option value="30" selected>30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="90">1.5 hours</option>
                        <option value="120">2 hours</option>
                        <option value="180">3 hours</option>
                    </select>
                </div>
            </div>
            
            <div class="time-task-actions">
                <button class="time-task-btn btn-cancel" onclick="closeTimeTaskModal()">Cancel</button>
                <button class="time-task-btn btn-schedule" onclick="scheduleTimeTask()">Schedule Task</button>
            </div>
        </div>

         <!-- AI Chat Modal -->
         <div class="ai-chat-modal" id="aiChatModal">
             <div class="chat-header">
                                 <button class="close-modal" onclick="closeAIChat()">
                    <i class="fas fa-times"></i>
                </button>
                 <h3>AI Assistant</h3>
                 <p>Let's plan your perfect day together!</p>
             </div>
             
             <div class="chat-messages" id="chatMessages">
                 <div class="ai-message">
                     <div class="message-bubble ai-bubble">
                         <i class="fas fa-robot"></i>
                         <span>Hi! What would you like to accomplish today?</span>
                     </div>
                 </div>
             </div>
             
                         <!-- Detected Tasks Display -->
            <div class="detected-tasks-container" id="detectedTasksContainer" style="display: none;">
                <div class="detected-tasks-header">
                    <i class="fas fa-tasks"></i>
                    <span id="detectedTasksMessage">I found these tasks. Should I add them to your planner?</span>
                </div>
                <div class="detected-tasks-list" id="detectedTasksList"></div>
                <div class="detected-tasks-actions">
                    <button class="approve-tasks-btn" onclick="approveDetectedTasks()">
                        <i class="fas fa-check"></i>
                        <span id="addTasksButtonText">Add These Tasks</span>
                    </button>
                                    <button class="dismiss-tasks-btn" onclick="dismissDetectedTasks()">
                    <i class="fas fa-times"></i>
                    Not Now
                </button>
            </div>

        </div>

            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Tell me what's on your mind..." 
                       autocomplete="off" autocorrect="off" autocapitalize="sentences" spellcheck="true"
                       style="color: white !important; -webkit-text-fill-color: white !important; background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.3) !important; font-size: 16px !important; font-weight: 500 !important;"
                       onkeypress="if(event.key==='Enter'){sendMessage();}"
                       onfocus="this.style.setProperty('background', 'rgba(255,255,255,0.15)', 'important'); this.style.setProperty('color', 'white', 'important'); this.style.setProperty('-webkit-text-fill-color', 'white', 'important');"
                       onblur="this.style.setProperty('background', 'rgba(255,255,255,0.1)', 'important');"
                       oninput="this.style.setProperty('color', 'white', 'important'); this.style.setProperty('-webkit-text-fill-color', 'white', 'important');">
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
         </div>

         <!-- Task Detail Modal -->
         <div class="task-detail-modal" id="taskDetailModal">
             <div class="task-detail-header">
                 <button class="close-modal" onclick="closeTaskDetail()">
                     <i class="fas fa-times"></i>
                 </button>
                 <h3>Enhanced Task Detail View</h3>
             </div>
             
             <div class="task-detail-content">
                 <div class="task-main-info">
                     <div class="task-title-row">
                         <div class="task-status-circle" id="taskStatusCircle"></div>
                         <div class="task-title" id="taskTitle">Task Title</div>
                         <div class="task-priority" id="taskPriority">Medium</div>
                     </div>
                     
                     <div class="task-progress">
                         <div class="progress-bar">
                             <div class="progress-fill" id="taskProgressFill" style="width: 0%"></div>
                         </div>
                         <div class="progress-text" id="taskProgressText">0% Complete</div>
                     </div>
                 </div>
                 
                 <div class="task-details-grid">
                     <div class="detail-item">
                         <div class="detail-icon"><i class="fas fa-calendar"></i></div>
                         <div class="detail-label">Due Date</div>
                         <div class="detail-value" id="taskDueDate">Aug 5, 2025</div>
                     </div>
                     
                     <div class="detail-item">
                         <div class="detail-icon"><i class="fas fa-clock"></i></div>
                         <div class="detail-label">Estimated Time</div>
                         <div class="detail-value" id="taskEstimatedTime">8 hours</div>
                     </div>
                     
                     <div class="detail-item">
                         <div class="detail-icon"><i class="fas fa-tag"></i></div>
                         <div class="detail-label">Category</div>
                         <div class="detail-value">
                             <div class="category-tags" id="taskCategories">
                                 <span class="category-tag">Work</span>
                                 <span class="category-tag">Coding</span>
                             </div>
                         </div>
                     </div>
                     
                     <div class="detail-item">
                         <div class="detail-icon"><i class="fas fa-bell"></i></div>
                         <div class="detail-label">Reminder</div>
                         <div class="detail-value" id="taskReminder">Tomorrow 9:00 AM</div>
                     </div>
                 </div>
                 
                 <div class="subtasks-section">
                     <div class="subtasks-header" id="subtasksHeader">Subtasks (0/0 completed)</div>
                     <div id="subtasksList">
                         <!-- Subtasks will be populated here -->
                     </div>
                 </div>
                 
                 <div class="notes-section">
                     <div class="notes-header">Notes</div>
                     <div class="notes-content" id="taskNotes">
                         Focus on getting the core task management features working first. The priority system and categories are most important. Consider using React Native for cross-platform compatibility.
                     </div>
                 </div>
             </div>
             
             <div class="task-actions">
                 <button class="task-action-btn btn-edit" onclick="editTaskDetail()">Edit</button>
                 <button class="task-action-btn btn-complete" onclick="toggleTaskComplete()">Mark Complete</button>
             </div>
         </div>

         <!-- Chat Input Bar -->
        <div class="chat-input-bar" id="chatInputBar">
            <input type="text" class="bottom-chat-input" id="bottomChatInput" placeholder="Ask AI to help plan your day..." 
                   style="color: white !important; -webkit-text-fill-color: white !important; background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important;"
                   onfocus="this.style.setProperty('background', 'rgba(255,255,255,0.15)', 'important'); this.style.setProperty('color', 'white', 'important'); this.style.setProperty('-webkit-text-fill-color', 'white', 'important');"
                   onblur="this.style.setProperty('background', 'rgba(255,255,255,0.1)', 'important');"
                   oninput="this.style.setProperty('color', 'white', 'important'); this.style.setProperty('-webkit-text-fill-color', 'white', 'important');"
                   onkeypress="if(event.key==='Enter'){sendMessageFromBottom();}">
            <button class="send-btn" id="sendBtn" onclick="sendMessageFromBottom()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

        
     </div>

    <script>
        // Global variables
        let currentDate = new Date();
        let selectedDate = new Date();
        let todos = []; // Will be loaded from DataLayer
        let scheduledTasks = JSON.parse(localStorage.getItem('memaster_scheduled_tasks')) || {};
        let currentView = 'main';
        let recognition = null;
        let isRecording = false;
        let voiceTranscript = '';
        let selectedTimeSlot = null;

        // Initialize app
        async function initializeApp() {
            console.log('🚀 Initializing MeMaster...');
            
            // Load todos from DataLayer
            try {
                todos = await DataLayer.loadTodos();
                console.log('📋 Loaded', todos.length, 'todos');
                
                // If no todos exist, create a sample enhanced task for demonstration
                if (todos.length === 0) {
                    createSampleTask();
                }
            } catch (error) {
                console.error('❌ Failed to load todos:', error);
                todos = []; // Fallback to empty array
                createSampleTask(); // Create sample task on error too
            }
            
            renderTodos();
            updateStats();
            updateSyncStatus();
            preventTextSelection();
            initializeEnhancedForms();
        }

        // Initialize Enhanced Form Interactions
        function initializeEnhancedForms() {
            // Priority button handlers
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    handlePriorityClick(btn.dataset.priority);
                });
            });
            
            // Category input handlers
            const categoryInputs = [
                document.getElementById('taskCategoryInput'), 
                document.getElementById('editTaskCategoryInput'),
                document.getElementById('goalCategoryInput')
            ];
            categoryInputs.forEach(input => {
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const category = e.target.value.trim();
                            if (category) {
                                if (input.id === 'goalCategoryInput') {
                                    // Handle goal categories
                                    if (!selectedGoalCategories.includes(category)) {
                                        selectedGoalCategories.push(category);
                                        updateGoalCategoriesDisplay();
                                    }
                                } else {
                                    // Handle task categories
                                    addCategory(category);
                                }
                                e.target.value = '';
                            }
                        }
                    });
                }
            });
            
            // Subtask input handlers
            const subtaskInputs = [
                { input: document.getElementById('subtaskInput'), id: 'subtaskInput' },
                { input: document.getElementById('editSubtaskInput'), id: 'editSubtaskInput' }
            ];
            
            subtaskInputs.forEach(({input, id}) => {
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addSubtaskFromInput(id);
                        }
                    });
                    
                    // Add visual feedback for typing
                    input.addEventListener('input', (e) => {
                        const text = e.target.value.trim();
                        if (text.length > 0) {
                            e.target.style.borderColor = '#667eea';
                        } else {
                            e.target.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                        }
                    });
                }
            });
        }

        // Create a sample enhanced task for demonstration
        function createSampleTask() {
            const sampleTask = {
                id: Date.now().toString(),
                text: 'Finish my app',
                completed: false,
                date: selectedDate.toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                priority: 'medium',
                dueDate: 'Aug 5, 2025',
                estimatedTime: '8 hours',
                categories: ['Work', 'Coding'],
                reminder: 'Tomorrow 9:00 AM',
                notes: 'Focus on getting the core task management features working first. The priority system and categories are most important. Consider using React Native for cross-platform compatibility.',
                subtasks: [
                    { text: 'Design user interface', completed: true },
                    { text: 'Set-up database', completed: true },
                    { text: 'Implement user authentication', completed: true },
                    { text: 'Add task management features', completed: false },
                    { text: 'Test and debug', completed: false }
                ]
            };
            
            todos.push(sampleTask);
            
            // Add a second sample task to show variety
            const sampleTask2 = {
                id: (Date.now() + 1).toString(),
                text: 'Plan weekend trip',
                completed: false,
                date: selectedDate.toISOString().split('T')[0],
                createdAt: new Date(Date.now() + 1000).toISOString(),
                priority: 'low',
                dueDate: 'Aug 10, 2025',
                estimatedTime: '2 hours',
                categories: ['Personal', 'Travel'],
                reminder: 'Friday 6:00 PM',
                notes: 'Research destinations, book accommodations, and plan activities. Check weather forecast and pack accordingly.',
                subtasks: [
                    { text: 'Research destinations', completed: false },
                    { text: 'Check flight prices', completed: false },
                    { text: 'Book hotel', completed: false }
                ]
            };
            
            todos.push(sampleTask2);
            
            // Add a high priority task
            const sampleTask3 = {
                id: (Date.now() + 2).toString(),
                text: 'Submit project proposal',
                completed: false,
                date: selectedDate.toISOString().split('T')[0],
                createdAt: new Date(Date.now() + 2000).toISOString(),
                priority: 'high',
                dueDate: 'Aug 3, 2025',
                estimatedTime: '3 hours',
                categories: ['Work', 'Important'],
                reminder: 'Today 4:00 PM',
                notes: 'Final review needed before submission. Make sure all requirements are met and documents are properly formatted.',
                subtasks: [
                    { text: 'Review requirements', completed: true },
                    { text: 'Write executive summary', completed: false },
                    { text: 'Prepare budget section', completed: false },
                    { text: 'Final proofreading', completed: false }
                ]
            };
            
            todos.push(sampleTask3);
            DataLayer.saveTodos(todos);
        }

        function showMainApp() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainScreen').classList.add('active');
            document.body.classList.remove('welcome-active');
            initializeApp();
        }

        // View management
        function showView(view) {
            // Close any open swipes
            closeAllSwipes();
            
            // Hide all views
            document.querySelectorAll('.main-screen, .calendar-view, .stats-view, .day-schedule-view').forEach(v => {
                v.classList.remove('active');
            });
            
            // Remove active from nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected view and activate nav
            if (view === 'main') {
                document.getElementById('mainScreen').classList.add('active');
                renderTodos();
                updateChatPlaceholder('Ask AI to help plan your day...');
            } else if (view === 'calendar') {
                document.getElementById('calendarView').classList.add('active');
                renderCalendar();
                updateChatPlaceholder('Ask AI about scheduling...');
            } else if (view === 'stats') {
                document.getElementById('statsView').classList.add('active');
                updateStats();
                renderGoals();
                updateChatPlaceholder('Ask AI about your goals...');
            }
            
            // Activate nav item
            event.target.closest('.nav-item').classList.add('active');
            currentView = view;
        }

        // Update chat placeholder based on active view
        function updateChatPlaceholder(placeholder) {
            const chatInput = document.getElementById('bottomChatInput');
            if (chatInput) {
                chatInput.placeholder = placeholder;
            }
        }

        // Todo functions
        function renderTodos() {
            const todoList = document.getElementById('todoList');
            const dateKey = selectedDate.toISOString().split('T')[0];
            const todayTodos = todos.filter(todo => todo.date === dateKey);
            
            // Get goals that should show in today tab (respects weekly schedule)
            const todayGoals = goals.filter(goal => shouldShowGoalToday(goal, selectedDate));
            
            // Sort todos: uncompleted first, then completed
            const sortedTodos = todayTodos.sort((a, b) => {
                if (a.completed === b.completed) {
                    // If both have same completion status, maintain original order
                    return new Date(a.createdAt) - new Date(b.createdAt);
                }
                // Uncompleted tasks come first (false < true)
                return a.completed ? 1 : -1;
            });
            
            todoList.innerHTML = '';
            
            // Track overall numbering for all items (goals + tasks) - v2024
            let itemNumber = 1;
            
            // Render goals first if any exist
            todayGoals.forEach((goal, goalIndex) => {
                const li = document.createElement('li');
                li.className = 'goal-item-in-today';
                li.dataset.goalId = goal.id;
                
                // Generate daily task text based on goal
                const dailyTaskText = generateDailyTaskText(goal.title);
                const todayKey = selectedDate.toISOString().split('T')[0];
                const dailyTaskCompleted = goal.dailyTasks && goal.dailyTasks[todayKey] ? goal.dailyTasks[todayKey].completed : false;
                
                // Build expanded content for goals
                let goalExpandedHTML = `
                    <div class="todo-expanded-content" style="display: none;">
                        <div class="task-actions-expanded">
                            <div class="task-action-icon edit-icon" onclick="editGoal('${goal.id}'); event.stopPropagation();" title="Edit Goal">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="task-action-icon delete-icon" onclick="deleteGoal('${goal.id}'); event.stopPropagation();" title="Delete Goal">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                        <div class="goal-details">
                            <div class="goal-detail-item">
                                <strong>Progress:</strong> ${goal.progress}% complete
                            </div>
                            ${goal.description ? `<div class="goal-detail-item"><strong>Description:</strong> ${goal.description}</div>` : ''}
                            ${goal.targetDate ? `<div class="goal-detail-item"><strong>Target Date:</strong> ${goal.targetDate}</div>` : ''}
                        </div>
                    </div>
                `;

                const goalHTML = `
                    <div class="goal-label">Goal</div>
                    <div class="goal-item-wrapper" onclick="toggleGoalExpansionInToday('${goal.id}')">
                        <div class="goal-content">
                            <div class="goal-number">${itemNumber}.</div>
                            <div class="goal-text">
                                <div class="goal-title-compact">
                                    <span style="font-weight: 600; color: #667eea;">${goal.title}</span>
                                </div>
                                <div class="daily-task-text">${dailyTaskText}</div>
                            </div>
                        </div>
                        <div class="goal-daily-checkbox ${dailyTaskCompleted ? 'checked' : ''}" 
                             onclick="toggleGoalDailyTask('${goal.id}'); event.stopPropagation(); return false;">
                        </div>
                    </div>
                    ${goalExpandedHTML}
                `;
                
                li.innerHTML = goalHTML;
                todoList.appendChild(li);
                itemNumber++; // Increment after each goal
            });
            
            sortedTodos.forEach((todo, index) => {
                const li = document.createElement('li');
                li.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                li.dataset.todoId = todo.id;
                
                // Build expanded content HTML (actions first, then subtasks)
                let expandedHTML = `
                    <div class="todo-expanded-content" style="display: none;">
                        <div class="task-actions-expanded">
                            <div class="task-action-icon edit-icon" onclick="editTodo('${todo.id}'); event.stopPropagation();" title="Edit">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="task-action-icon delete-icon" onclick="deleteTodoWithSlide('${todo.id}'); event.stopPropagation();" title="Delete">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                        ${todo.subtasks && todo.subtasks.length > 0 ? `
                            <div class="subtasks-section">
                                <div class="subtasks-header">
                                    <i class="fas fa-list"></i>
                                    <span>Subtasks (${todo.subtasks.filter(s => s.completed).length}/${todo.subtasks.length} completed)</span>
                                </div>
                                <div class="subtasks-list">
                                    ${todo.subtasks.map((subtask, subIndex) => `
                                        <div class="subtask-item ${subtask.completed ? 'completed' : ''}">
                                            <span class="subtask-text">${subtask.text}</span>
                                            <div class="subtask-checkbox ${subtask.completed ? 'checked' : ''}" 
                                                 onclick="toggleSubtaskComplete('${todo.id}', ${subIndex}); event.stopPropagation();">
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                const todoHTML = `
                    <div class="todo-item-wrapper">
                        <div class="todo-item-content" 
                             onclick="toggleTaskExpansion(event, '${todo.id}')"
                             style="cursor: pointer;">
                            <div class="todo-left-content">
                                <div class="todo-main-row">
                                    <div class="todo-number">${itemNumber}.</div>
                                    <div class="todo-text">${todo.text}</div>

                                </div>
                                ${todo.subtasks && todo.subtasks.length > 0 ? `
                                    <div class="todo-subtask-info">
                                        <div class="todo-number"></div>
                                        <span class="subtask-indicator">${todo.subtasks.length} subtasks</span>
                                        <div class="expand-arrow"><i class="fas fa-chevron-down"></i></div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="todo-checkbox ${todo.completed ? 'checked' : ''}" 
                             onclick="handleCheckboxClick(event, '${todo.id}'); return false;"
                             ontouchstart="event.stopPropagation(); event.preventDefault(); return false;"
                             ontouchmove="event.stopPropagation(); event.preventDefault(); return false;"
                             ontouchend="handleCheckboxClick(event, '${todo.id}'); event.stopPropagation(); event.preventDefault(); return false;"
                             onmousedown="event.stopPropagation(); return false;"
                             onmouseup="event.stopPropagation(); return false;"
                             style="pointer-events: auto; z-index: 25; touch-action: none;">
                        </div>
                    </div>
                    ${expandedHTML}
                `;
                
                li.innerHTML = todoHTML;
                todoList.appendChild(li);
                itemNumber++; // Increment after each task
            });
            
            // Ensure text selection is prevented on newly rendered todos
            preventTextSelection();
        }

        // Enhanced Task Form Variables
        let selectedCategories = [];
        let selectedSubtasks = [];
        let selectedPriority = 'medium';

        // Enhanced Task Creation
        async function addEnhancedTask() {
            const titleInput = document.getElementById('taskInput');
            const text = titleInput.value.trim();
            
            if (!text) {
                titleInput.focus();
                return;
            }
            
            // Get form values
            const dueDate = document.getElementById('taskDueInput').value;
            const estimatedTime = document.getElementById('taskTimeInput').value;
            const reminder = document.getElementById('taskReminderInput').value;
            const notes = document.getElementById('taskNotesInput').value.trim();
            
            const todo = {
                id: Date.now().toString(),
                text: text,
                completed: false,
                date: selectedDate.toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                priority: selectedPriority,
                dueDate: dueDate || null,
                estimatedTime: estimatedTime || null,
                categories: [...selectedCategories],
                reminder: reminder || null,
                notes: notes || null,
                subtasks: [...selectedSubtasks]
            };
            
            todos.push(todo);
            
            // Save using DataLayer
            try {
                await DataLayer.saveTodos(todos);
                console.log('✅ Enhanced task added and saved');
            } catch (error) {
                console.error('❌ Failed to save enhanced task:', error);
            }
            
            // Reset form
            resetTaskForm();
            closeInputModal();
            renderTodos();
            updateStats();
        }

        // Legacy simple task function for backward compatibility
        async function addTask() {
            await addEnhancedTask();
        }

        // Reset Task Form
        function resetTaskForm() {
            // Clear text inputs
            document.getElementById('taskInput').value = '';
            document.getElementById('taskDueInput').value = '';
            document.getElementById('taskTimeInput').value = '';
            document.getElementById('taskReminderInput').value = '';
            document.getElementById('taskNotesInput').value = '';
            document.getElementById('taskCategoryInput').value = '';
            document.getElementById('subtaskInput').value = '';
            
            // Reset priority to medium
            selectedPriority = 'medium';
            updatePriorityButtons();
            
            // Clear categories and subtasks
            selectedCategories = [];
            selectedSubtasks = [];
            updateCategoriesDisplay();
            updateSubtasksDisplay();
        }

        // Priority Management
        function updatePriorityButtons() {
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.priority === selectedPriority) {
                    btn.classList.add('active');
                }
            });
        }

        function handlePriorityClick(priority) {
            selectedPriority = priority;
            updatePriorityButtons();
        }

        // Category Management
        function addCategory(category) {
            if (category && !selectedCategories.includes(category)) {
                selectedCategories.push(category);
                updateCategoriesDisplay();
            }
        }

        function removeCategory(category) {
            selectedCategories = selectedCategories.filter(c => c !== category);
            updateCategoriesDisplay();
        }

        function updateCategoriesDisplay() {
            const container = document.getElementById('selectedCategories');
            const editContainer = document.getElementById('editSelectedCategories');
            
            [container, editContainer].forEach(cont => {
                if (cont) {
                    cont.innerHTML = '';
                    selectedCategories.forEach(category => {
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.innerHTML = `
                            ${category}
                            <button class="remove-btn" onclick="removeCategory('${category}')">&times;</button>
                        `;
                        cont.appendChild(item);
                    });
                }
            });
        }

        // Subtask Management
        function addSubtask(text) {
            if (!text) return false;
            
            // Check for duplicates
            if (selectedSubtasks.find(s => s.text.toLowerCase() === text.toLowerCase())) {
                showToast(`⚠️ "${text}" is already in your subtasks`);
                return false;
            }
            
            selectedSubtasks.push({ text: text, completed: false });
            updateSubtasksDisplay();
            
            // Show visual feedback
            showToast(`✅ Subtask added: "${text}"`);
            return true;
        }

        function addSubtaskFromInput(inputId) {
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if (text) {
                addSubtask(text);
                input.value = '';
                input.focus(); // Keep focus so user can add more
            }
        }

        function removeSubtask(index) {
            const removedSubtask = selectedSubtasks[index];
            selectedSubtasks.splice(index, 1);
            updateSubtasksDisplay();
            
            // Show visual feedback
            if (removedSubtask) {
                showToast(`🗑️ Removed: "${removedSubtask.text}"`);
            }
        }

        function updateSubtasksDisplay() {
            const container = document.getElementById('addedSubtasks');
            const editContainer = document.getElementById('editAddedSubtasks');
            
            [container, editContainer].forEach(cont => {
                if (cont) {
                    cont.innerHTML = '';
                    
                    if (selectedSubtasks.length > 0) {
                        selectedSubtasks.forEach((subtask, index) => {
                            const item = document.createElement('div');
                            item.className = 'subtask-item-form';
                            item.style.cssText = 'animation: slideIn 0.3s ease; margin-bottom: 8px;';
                            item.innerHTML = `
                                <div class="subtask-number">${index + 1}.</div>
                                <span class="subtask-text">${subtask.text}</span>
                                <button class="remove-btn" onclick="removeSubtask(${index})" title="Remove subtask">&times;</button>
                            `;
                            cont.appendChild(item);
                        });
                        
                        // Add some spacing before the input field
                        cont.style.marginBottom = '15px';
                    } else {
                        // Reset margin when no subtasks
                        cont.style.marginBottom = '0';
                    }
                }
            });
        }

        // Enhanced Edit Task Function
        async function saveEnhancedTask() {
            const editModal = document.getElementById('editModal');
            const todoId = editModal.dataset.todoId;
            const todo = todos.find(t => t.id === todoId);
            
            if (!todo) return;
            
            const titleInput = document.getElementById('editTaskInput');
            const text = titleInput.value.trim();
            
            if (!text) {
                titleInput.focus();
                return;
            }
            
            // Get form values
            const dueDate = document.getElementById('editTaskDueInput').value;
            const estimatedTime = document.getElementById('editTaskTimeInput').value;
            const reminder = document.getElementById('editTaskReminderInput').value;
            const notes = document.getElementById('editTaskNotesInput').value.trim();
            
            // Update todo
            todo.text = text;
            todo.priority = selectedPriority;
            todo.dueDate = dueDate || null;
            todo.estimatedTime = estimatedTime || null;
            todo.categories = [...selectedCategories];
            todo.reminder = reminder || null;
            todo.notes = notes || null;
            todo.subtasks = [...selectedSubtasks];
            
            // Save using DataLayer
            try {
                await DataLayer.saveTodos(todos);
                console.log('✅ Enhanced task updated and saved');
            } catch (error) {
                console.error('❌ Failed to save enhanced task update:', error);
            }
            
            closeEditModal();
            renderTodos();
            updateStats();
        }

        // Legacy edit function for backward compatibility
        async function saveEditedTask() {
            await saveEnhancedTask();
        }

        function handleCheckboxClick(event, id) {
            console.log('🔘 Checkbox clicked for task id:', id);
            console.log('🔘 Event target:', event.target);
            console.log('🔘 Event type:', event.type);
            
            // CRITICAL: Stop all event propagation immediately
            event.stopPropagation();
            event.preventDefault();
            event.stopImmediatePropagation();
            
            // Disable any parent element interactions temporarily
            const todoItem = event.target.closest('.todo-item');
            if (todoItem) {
                todoItem.style.pointerEvents = 'none';
                setTimeout(() => {
                    todoItem.style.pointerEvents = '';
                }, 300);
            }
            
            // Add visual feedback immediately
            const checkbox = event.target;
            checkbox.style.transform = 'scale(0.9)';
            setTimeout(() => {
                checkbox.style.transform = '';
            }, 150);
            
            console.log('🔘 About to call toggleTodo immediately');
            
            // Call toggleTodo immediately - no delay needed
            toggleTodo(id);
            
            // Return false to prevent any further event processing
            return false;
        }

        async function toggleTodo(id) {
            console.log('🔄 Toggling task with id:', id);
            const todo = todos.find(t => t.id === id);
            if (todo) {
                console.log('📝 Task found:', todo.text, 'Current completed state:', todo.completed);
                todo.completed = !todo.completed;
                console.log('📝 New completed state:', todo.completed);
                
                // Save using DataLayer
                try {
                    await DataLayer.saveTodos(todos);
                    console.log('✅ Task toggled and saved');
                } catch (error) {
                    console.error('❌ Failed to save task toggle:', error);
                }
                
                renderTodos();
                updateStats();
            } else {
                console.error('❌ Task not found with id:', id);
            }
        }

        function handleTodoClick(event, todoId) {
            // Don't handle todo clicks if it's on the checkbox
            if (event.target.classList.contains('todo-checkbox')) {
                return;
            }
            
            // Don't handle if we're currently dragging
            if (isDragging) {
                return;
            }
            
            event.preventDefault();
            const todoItem = event.target.closest('.todo-item');
            
            // If item is already swiped, close it
            if (todoItem.classList.contains('swiped')) {
                todoItem.classList.remove('swiped');
                return;
            }
            
            // Close all other swiped items first
            document.querySelectorAll('.todo-item.swiped').forEach(item => {
                item.classList.remove('swiped');
            });
            
            // Simple click opens task detail modal
            showTaskDetail(todoId);
        }

        // Touch support for mobile swipe gestures
        let touchStartX = null;
        let touchStartY = null;
        let currentTouchItem = null;
        
        // Task reordering variables
        let longPressTimer = null;
        let isDragging = false;
        let dragStartY = null;
        let dragElement = null;
        let dragIndex = null;

        function handleTouchStart(event, todoId) {
            // Don't start touch handling if it's on the checkbox
            if (event.target.classList.contains('todo-checkbox')) {
                return;
            }
            
            const touch = event.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            currentTouchItem = event.target.closest('.todo-item');
            
            // Start long press timer for drag and drop
            if (currentTouchItem && !isDragging) {
                clearTimeout(longPressTimer);
                longPressTimer = setTimeout(() => {
                    startDragOperation(event, todoId, currentTouchItem);
                }, 500); // 500ms long press
                
                // Add visual feedback for long press and prevent text selection
                currentTouchItem.classList.add('long-pressing');
                document.body.classList.add('dragging-active');
                
                // Prevent text selection during long press
                event.preventDefault();
                
                // Remove long-pressing class after a moment if not dragging
                setTimeout(() => {
                    if (!isDragging && currentTouchItem) {
                        currentTouchItem.classList.remove('long-pressing');
                        document.body.classList.remove('dragging-active');
                    }
                }, 600);
            }
        }

        function handleTouchMove(event) {
            if (!touchStartX || !currentTouchItem) return;
            
            // Double-check we're not on a checkbox
            if (event.target.classList.contains('todo-checkbox')) {
                return;
            }
            
            const touch = event.touches[0];
            const deltaX = touchStartX - touch.clientX;
            const deltaY = touchStartY - touch.clientY;
            
            // If we're dragging, handle visual movement
            if (isDragging && dragElement && dragElement.dragClone) {
                event.preventDefault();
                
                // Update clone position to follow finger
                const clone = dragElement.dragClone;
                clone.style.left = (touch.clientX - dragElement.offsetX) + 'px';
                clone.style.top = (touch.clientY - dragElement.offsetY) + 'px';
                
                // Find what item we're hovering over
                findDropTarget(touch.clientX, touch.clientY);
                return;
            }
            
            // Cancel long press if moved too much
            if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                clearTimeout(longPressTimer);
                if (currentTouchItem) {
                    currentTouchItem.classList.remove('long-pressing');
                    document.body.classList.remove('dragging-active');
                }
            }
            
            // Only process horizontal swipes for regular swipe gestures (ignore vertical scrolling)
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
                event.preventDefault();
                
                if (deltaX > 0) { // Swiping left
                    currentTouchItem.classList.add('swiped');
                    // Close other swipes
                    document.querySelectorAll('.todo-item.swiped').forEach(item => {
                        if (item !== currentTouchItem) {
                            item.classList.remove('swiped');
                        }
                    });
                }
            }
        }

        function handleTouchEnd(event) {
            // Don't process if it's on a checkbox - let the checkbox handle it
            if (event.target.classList.contains('todo-checkbox')) {
                return;
            }
            
            // Clean up long press timer
            clearTimeout(longPressTimer);
            
            // If we were dragging, handle drop
            if (isDragging) {
                handleDrop();
                return;
            }
            
            // Clean up long-pressing state
            if (currentTouchItem) {
                currentTouchItem.classList.remove('long-pressing');
            }
            
            touchStartX = null;
            touchStartY = null;
            currentTouchItem = null;
        }

        // Visual Drag and Drop Functions
        function startDragOperation(event, todoId, todoItem) {
            console.log('🎯 Starting visual drag operation for task:', todoId);
            
            isDragging = true;
            dragElement = todoItem;
            const touch = event.touches[0];
            
            // Find the index of this todo
            const dateKey = selectedDate.toISOString().split('T')[0];
            const todayTodos = todos.filter(todo => todo.date === dateKey);
            const sortedTodos = todayTodos.sort((a, b) => {
                if (a.completed === b.completed) {
                    return new Date(a.createdAt) - new Date(b.createdAt);
                }
                return a.completed ? 1 : -1;
            });
            
            dragIndex = sortedTodos.findIndex(todo => todo.id === todoId);
            
            // Get original position
            const rect = todoItem.getBoundingClientRect();
            
            // Create placeholder in original position
            todoItem.classList.add('placeholder');
            todoItem.classList.remove('long-pressing');
            
            // Create dragging clone
            const clone = todoItem.cloneNode(true);
            clone.classList.remove('placeholder', 'long-pressing');
            clone.classList.add('dragging');
            
            // Position clone at original location
            clone.style.left = rect.left + 'px';
            clone.style.top = rect.top + 'px';
            clone.style.width = rect.width + 'px';
            
            // Store offset from touch point to element origin
            dragElement.offsetX = touch.clientX - rect.left;
            dragElement.offsetY = touch.clientY - rect.top;
            
            document.body.appendChild(clone);
            dragElement.dragClone = clone;
            
            // Add haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            console.log('📱 Visual drag started! Drag to reorder tasks.');
        }

        function findDropTarget(x, y) {
            // Temporarily hide the dragging clone to get element underneath
            const clone = dragElement.dragClone;
            clone.style.pointerEvents = 'none';
            
            // Get element at touch position
            const elementBelow = document.elementFromPoint(x, y);
            const targetTodoItem = elementBelow ? elementBelow.closest('.todo-item') : null;
            
            // Clear all drop target indicators
            document.querySelectorAll('.todo-item').forEach(item => {
                item.classList.remove('drop-target-above', 'drop-target-below');
            });
            
            // If hovering over a valid todo item (not the placeholder)
            if (targetTodoItem && !targetTodoItem.classList.contains('placeholder')) {
                const targetRect = targetTodoItem.getBoundingClientRect();
                const targetCenter = targetRect.top + targetRect.height / 2;
                
                // Find target index in the sorted list
                const dateKey = selectedDate.toISOString().split('T')[0];
                const todayTodos = todos.filter(todo => todo.date === dateKey);
                const sortedTodos = todayTodos.sort((a, b) => {
                    if (a.completed === b.completed) {
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    }
                    return a.completed ? 1 : -1;
                });
                
                const targetId = targetTodoItem.dataset.todoId;
                const targetIndex = sortedTodos.findIndex(todo => todo.id === targetId);
                
                if (targetIndex !== -1 && targetIndex !== dragIndex) {
                    // Determine if we should insert above or below
                    if (y < targetCenter) {
                        // Insert above target
                        targetTodoItem.classList.add('drop-target-above');
                        dragElement.targetIndex = targetIndex;
                        dragElement.insertAbove = true;
                    } else {
                        // Insert below target  
                        targetTodoItem.classList.add('drop-target-below');
                        dragElement.targetIndex = targetIndex;
                        dragElement.insertAbove = false;
                    }
                }
            }
        }

        async function handleDrop() {
            console.log('🎯 Handling visual drop operation');
            
            if (!isDragging || !dragElement || dragIndex === null) {
                cleanupDragOperation();
                return;
            }
            
            // Calculate new index based on drop target
            let newIndex = dragIndex;
            
            if (dragElement.targetIndex !== undefined) {
                const targetIndex = dragElement.targetIndex;
                
                if (dragElement.insertAbove) {
                    // Insert above target
                    newIndex = targetIndex < dragIndex ? targetIndex : targetIndex;
                } else {
                    // Insert below target
                    newIndex = targetIndex > dragIndex ? targetIndex : targetIndex + 1;
                }
            }
            
            // Perform reordering if position changed
            if (newIndex !== dragIndex) {
                await reorderTodos(dragIndex, newIndex);
                console.log(`📝 Task moved from position ${dragIndex + 1} to ${newIndex + 1}`);
                
                // Haptic feedback for successful drop
                if (navigator.vibrate) {
                    navigator.vibrate([30, 30, 30]);
                }
            }
            
            cleanupDragOperation();
        }

        function cleanupDragOperation() {
            isDragging = false;
            dragIndex = null;
            
            // Remove drag clone
            if (dragElement && dragElement.dragClone) {
                dragElement.dragClone.remove();
                delete dragElement.dragClone;
            }
            
            // Clean up classes and properties
            document.querySelectorAll('.todo-item').forEach(item => {
                item.classList.remove('dragging', 'placeholder', 'drop-target-above', 'drop-target-below', 'long-pressing');
                delete item.offsetX;
                delete item.offsetY;
                delete item.targetIndex;
                delete item.insertAbove;
            });
            
            // Remove text selection prevention
            document.body.classList.remove('dragging-active');
            
            // Clear timers
            clearTimeout(longPressTimer);
            
            dragElement = null;
        }

        async function reorderTodos(fromIndex, toIndex) {
            const dateKey = selectedDate.toISOString().split('T')[0];
            const todayTodos = todos.filter(todo => todo.date === dateKey);
            const otherTodos = todos.filter(todo => todo.date !== dateKey);
            
            // Sort today's todos the same way as display
            const sortedTodos = todayTodos.sort((a, b) => {
                if (a.completed === b.completed) {
                    return new Date(a.createdAt) - new Date(b.createdAt);
                }
                return a.completed ? 1 : -1;
            });
            
            // Move the item
            const movedTodo = sortedTodos.splice(fromIndex, 1)[0];
            sortedTodos.splice(toIndex, 0, movedTodo);
            
            // Update createdAt timestamps to maintain new order
            sortedTodos.forEach((todo, index) => {
                const baseTime = new Date(selectedDate);
                baseTime.setHours(0, 0, 0, 0);
                todo.createdAt = new Date(baseTime.getTime() + index * 1000).toISOString();
            });
            
            // Combine with other days' todos
            todos = [...otherTodos, ...sortedTodos];
            
            // Save to DataLayer
            try {
                await DataLayer.saveTodos(todos);
                console.log('✅ Reordered tasks saved');
            } catch (error) {
                console.error('❌ Failed to save reordered tasks:', error);
            }
            
            // Re-render to show new order
            renderTodos();
        }

        // Prevent any text selection events on todo items
        function preventTextSelection() {
            const todoList = document.getElementById('todoList');
            if (todoList) {
                todoList.addEventListener('selectstart', function(e) {
                    e.preventDefault();
                    return false;
                }, false);
                
                todoList.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                    return false;
                }, false);
                
                todoList.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                }, false);
            }
        }

        function editTodo(id) {
            console.log('Editing task with id:', id);
            const todo = todos.find(t => t.id === id);
            
            if (!todo) {
                console.error('Todo item not found for id:', id);
                showToast('Error: Task not found');
                return;
            }
            
            // Close any open swipes
            closeAllSwipes();
            
            // Show edit modal with current task text
            showEditModal(todo);
        }

        async function deleteTodoWithSlide(id) {
            console.log('🗑️ DELETE FUNCTION CALLED! Task id:', id, 'type:', typeof id);
            console.log('🗑️ Call stack:', new Error().stack);
            const todoItem = document.querySelector(`.todo-item[data-todo-id="${id}"]`);
            
            if (!todoItem) {
                console.error('Todo item not found for id:', id);
                showToast('Error: Task not found');
                return;
            }
            
            // Add slide out animation
            todoItem.style.transform = 'translateX(-100%)';
            todoItem.style.opacity = '0';
            
            // Remove from array and update storage after animation
            setTimeout(async () => {
                console.log('Before deletion, todos count:', todos.length);
                const originalLength = todos.length;
                
                // Convert both ids to strings for comparison to handle type mismatches
                todos = todos.filter(t => t.id.toString() !== id.toString());
                
                console.log('After deletion, todos count:', todos.length);
                
                if (todos.length === originalLength) {
                    console.error('Task was not removed from array. ID mismatch?');
                    console.log('Available todo ids:', todos.map(t => `${t.id} (${typeof t.id})`));
                }
                
                // Save using DataLayer
                try {
                    await DataLayer.saveTodos(todos);
                    console.log('✅ Task deleted and saved');
                } catch (error) {
                    console.error('❌ Failed to save task deletion:', error);
                }
                
                renderTodos();
                updateStats();
                showToast('Task deleted');
            }, 300);
        }

        // Close swipes when clicking elsewhere
        function closeAllSwipes() {
            document.querySelectorAll('.todo-item.swiped').forEach(item => {
                item.classList.remove('swiped');
            });
        }

        // Modal functions
        function showInputModal() {
            document.getElementById('inputModal').classList.add('active');
            setTimeout(() => {
                document.getElementById('taskInput').focus();
            }, 300);
        }

        function closeInputModal() {
            document.getElementById('inputModal').classList.remove('active');
            resetTaskForm();
        }

        function showEditModal(todo) {
            const editModal = document.getElementById('editModal');
            
            // Populate form with current task data
            document.getElementById('editTaskInput').value = todo.text;
            document.getElementById('editTaskDueInput').value = todo.dueDate || '';
            document.getElementById('editTaskTimeInput').value = todo.estimatedTime || '';
            document.getElementById('editTaskReminderInput').value = todo.reminder || '';
            document.getElementById('editTaskNotesInput').value = todo.notes || '';
            
            // Set priority
            selectedPriority = todo.priority || 'medium';
            updatePriorityButtons();
            
            // Set categories
            selectedCategories = [...(todo.categories || [])];
            updateCategoriesDisplay();
            
            // Set subtasks
            selectedSubtasks = [...(todo.subtasks || [])];
            updateSubtasksDisplay();
            
            // Store the todo id for saving
            editModal.dataset.todoId = todo.id;
            
            // Show the modal
            editModal.classList.add('active');
            
            // Focus the input
            setTimeout(() => {
                document.getElementById('editTaskInput').focus();
            }, 300);
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            resetTaskForm();
        }

        // Task Detail Modal Functions
        function showTaskDetail(todoId) {
            const todo = todos.find(t => t.id === todoId);
            if (!todo) return;
            
            // Populate task details
            document.getElementById('taskTitle').textContent = todo.text;
            
            // Set completion status
            const statusCircle = document.getElementById('taskStatusCircle');
            statusCircle.className = todo.completed ? 'task-status-circle completed' : 'task-status-circle';
            
            // Set priority (default to medium for now)
            const priority = todo.priority || 'medium';
            const priorityElement = document.getElementById('taskPriority');
            priorityElement.textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
            priorityElement.className = `task-priority ${priority}`;
            
            // Calculate progress based on completed subtasks
            const subtasks = todo.subtasks || [];
            const completedSubtasks = subtasks.filter(s => s.completed).length;
            const progress = subtasks.length > 0 ? Math.round((completedSubtasks / subtasks.length) * 100) : 0;
            
            document.getElementById('taskProgressFill').style.width = `${progress}%`;
            document.getElementById('taskProgressText').textContent = `${progress}% Complete`;
            
            // Set task details
            document.getElementById('taskDueDate').textContent = todo.dueDate || 'No due date';
            document.getElementById('taskEstimatedTime').textContent = todo.estimatedTime || 'Not set';
            document.getElementById('taskReminder').textContent = todo.reminder || 'No reminder';
            
            // Populate categories
            const categoriesContainer = document.getElementById('taskCategories');
            categoriesContainer.innerHTML = '';
            const categories = todo.categories || ['General'];
            categories.forEach(category => {
                const tag = document.createElement('span');
                tag.className = 'category-tag';
                tag.textContent = category;
                categoriesContainer.appendChild(tag);
            });
            
            // Populate subtasks
            populateSubtasks(todo);
            
            // Set notes
            document.getElementById('taskNotes').textContent = todo.notes || 'No notes added yet.';
            
            // Store current todo ID for actions
            document.getElementById('taskDetailModal').dataset.todoId = todoId;
            
            // Show modal
            document.getElementById('taskDetailModal').classList.add('active');
        }

        function populateSubtasks(todo) {
            const subtasksList = document.getElementById('subtasksList');
            const subtasks = todo.subtasks || [];
            
            // Update header
            const completedCount = subtasks.filter(s => s.completed).length;
            document.getElementById('subtasksHeader').textContent = `Subtasks (${completedCount}/${subtasks.length} completed)`;
            
            // Clear and populate subtasks
            subtasksList.innerHTML = '';
            
            if (subtasks.length === 0) {
                subtasksList.innerHTML = '<div style="color: #666; font-style: italic; padding: 20px 0;">No subtasks added yet.</div>';
                return;
            }
            
            subtasks.forEach((subtask, index) => {
                const subtaskElement = document.createElement('div');
                subtaskElement.className = 'subtask-item';
                subtaskElement.innerHTML = `
                    <div class="subtask-checkbox ${subtask.completed ? 'completed' : ''}" 
                         onclick="toggleSubtask(${index})"></div>
                    <div class="subtask-text ${subtask.completed ? 'completed' : ''}">${subtask.text}</div>
                `;
                subtasksList.appendChild(subtaskElement);
            });
        }

        function toggleSubtask(subtaskIndex) {
            const todoId = document.getElementById('taskDetailModal').dataset.todoId;
            const todo = todos.find(t => t.id === todoId);
            
            if (!todo || !todo.subtasks || !todo.subtasks[subtaskIndex]) return;
            
            // Toggle subtask completion
            todo.subtasks[subtaskIndex].completed = !todo.subtasks[subtaskIndex].completed;
            
            // Save and refresh
            DataLayer.saveTodos(todos);
            populateSubtasks(todo);
            
            // Update progress
            const completedSubtasks = todo.subtasks.filter(s => s.completed).length;
            const progress = Math.round((completedSubtasks / todo.subtasks.length) * 100);
            document.getElementById('taskProgressFill').style.width = `${progress}%`;
            document.getElementById('taskProgressText').textContent = `${progress}% Complete`;
            
            // Update main todo list if needed
            renderTodos();
        }

        function closeTaskDetail() {
            document.getElementById('taskDetailModal').classList.remove('active');
        }

        function editTaskDetail() {
            // For now, just close the detail modal and open edit modal
            const todoId = document.getElementById('taskDetailModal').dataset.todoId;
            const todo = todos.find(t => t.id === todoId);
            
            closeTaskDetail();
            setTimeout(() => {
                showEditModal(todo);
            }, 300);
        }

        function toggleTaskComplete() {
            const todoId = document.getElementById('taskDetailModal').dataset.todoId;
            toggleTodo(todoId);
            
            // Update the modal display
            setTimeout(() => {
                showTaskDetail(todoId);
            }, 100);
        }

        async function saveEditedTask() {
            const editModal = document.getElementById('editModal');
            const editInput = document.getElementById('editTaskInput');
            const todoId = editModal.dataset.todoId;
            const newText = editInput.value.trim();
            
            if (!newText) {
                showToast('Task text cannot be empty');
                return;
            }
            
            const todo = todos.find(t => t.id === todoId);
            if (!todo) {
                showToast('Error: Task not found');
                closeEditModal();
                return;
            }
            
            // Update the task text
            todo.text = newText;
            
            // Save using DataLayer
            try {
                await DataLayer.saveTodos(todos);
                console.log('✅ Task edited and saved');
            } catch (error) {
                console.error('❌ Failed to save task edit:', error);
            }
            
            closeEditModal();
            renderTodos();
            updateStats();
            showToast('Task updated');
        }

        function showAISuggestions() {
            const modal = document.getElementById('aiModal');
            const suggestionsList = document.getElementById('suggestionsList');
            
            // Generate AI suggestions based on time of day
            const hour = new Date().getHours();
            let suggestions = [];
            
            if (hour < 10) {
                suggestions = [
                    'Review your goals for the day',
                    'Do a 10-minute morning meditation',
                    'Plan your most important task',
                    'Check and respond to messages',
                    'Prepare a healthy breakfast'
                ];
            } else if (hour < 14) {
                suggestions = [
                    'Focus on your most challenging task',
                    'Take a 15-minute break',
                    'Call someone important',
                    'Organize your workspace',
                    'Review project progress'
                ];
            } else if (hour < 18) {
                suggestions = [
                    'Complete pending tasks',
                    'Plan tomorrow\'s priorities',
                    'Take a walk outside',
                    'Follow up on communications',
                    'Prepare for evening activities'
                ];
            } else {
                suggestions = [
                    'Reflect on today\'s achievements',
                    'Prepare for tomorrow',
                    'Do a quick workout',
                    'Read for 30 minutes',
                    'Connect with family or friends'
                ];
            }
            
            suggestionsList.innerHTML = '';
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `
                    <div class="suggestion-text">${suggestion}</div>
                    <button class="add-suggestion-btn" onclick="addSuggestionAsTodo('${suggestion}')">
                        Add
                    </button>
                `;
                suggestionsList.appendChild(div);
            });
            
            modal.classList.add('active');
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('active');
        }

        async function addSuggestionAsTodo(suggestion) {
            const todo = {
                id: Date.now().toString(),
                text: suggestion,
                completed: false,
                date: selectedDate.toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            };
            
            todos.push(todo);
            
            // Save using DataLayer
            try {
                await DataLayer.saveTodos(todos);
                console.log('✅ Suggestion added and saved');
            } catch (error) {
                console.error('❌ Failed to save suggestion:', error);
            }
            
            closeAIModal();
            renderTodos();
            updateStats();
        }

        // Calendar functions
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('calendarMonth');
            
            monthDisplay.textContent = currentDate.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            grid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Generate calendar days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (date.getMonth() !== currentDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                if (date.toDateString() === selectedDate.toDateString()) {
                    dayElement.classList.add('selected');
                }
                
                dayElement.textContent = date.getDate();
                dayElement.addEventListener('click', () => {
                    selectedDate = new Date(date);
                    renderCalendar();
                    
                    // Open day schedule view
                    openDaySchedule();
                });
                
                grid.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        // Stats functions
        function updateStats() {
            const allTodos = todos;
            const completedTodos = allTodos.filter(todo => todo.completed);
            const totalTasks = allTodos.length;
            const completedTasks = completedTodos.length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // Calculate streak (simplified)
            const streak = calculateStreak();
            
            document.getElementById('totalTasksCount').textContent = totalTasks;
            document.getElementById('completedTasksCount').textContent = completedTasks;
            document.getElementById('streakCount').textContent = streak;
            document.getElementById('completionPercentage').textContent = completionRate + '%';
        }

        function calculateStreak() {
            // Simplified streak calculation
            const today = new Date().toISOString().split('T')[0];
            const todayTodos = todos.filter(todo => todo.date === today);
            const todayCompleted = todayTodos.filter(todo => todo.completed);
            
            return todayCompleted.length > 0 ? 1 : 0; // Simplified for demo
        }

        // Voice Recognition Functions
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isRecording = true;
                    updateVoiceUI('recording');
                };

                recognition.onresult = function(event) {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            transcript += event.results[i][0].transcript;
                        }
                    }
                    
                    if (transcript) {
                        voiceTranscript += transcript + ' ';
                        updateTranscriptDisplay();
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    updateVoiceUI('error');
                };

                recognition.onend = function() {
                    isRecording = false;
                    updateVoiceUI('stopped');
                };

                return true;
            }
            return false;
        }

        function startVoiceInput() {
            const modal = document.getElementById('voiceModal');
            const floatingBtn = document.querySelector('.floating-voice-btn');
            
            // Check if speech recognition is supported
            if (!initSpeechRecognition()) {
                alert('Speech recognition is not supported in your browser. Please try Chrome or Safari.');
                return;
            }

            // Reset state
            voiceTranscript = '';
            updateTranscriptDisplay();
            
            // Show modal
            modal.classList.add('active');
            updateVoiceUI('ready');
            
            // Start recording after a short delay
            setTimeout(() => {
                if (recognition) {
                    recognition.start();
                }
            }, 500);
        }

        function stopVoiceInput() {
            if (recognition && isRecording) {
                recognition.stop();
            }
        }

        function cancelVoiceInput() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            
            voiceTranscript = '';
            document.getElementById('voiceModal').classList.remove('active');
            
            // Reset voice button state
            const voiceBtn = document.querySelector('.voice-input-btn');
            voiceBtn.classList.remove('recording');
            
            updateVoiceUI('ready');
        }

        async function processVoiceInput() {
            if (!voiceTranscript.trim()) {
                alert('No speech detected. Please try again.');
                return;
            }

            // Parse the transcript and create tasks
            const tasks = parseVoiceToTasks(voiceTranscript);
            
            if (tasks.length > 0) {
                // Add all tasks to the todo list
                tasks.forEach(taskText => {
                    const todo = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        text: taskText.trim(),
                        completed: false,
                        date: selectedDate.toISOString().split('T')[0],
                        createdAt: new Date().toISOString()
                    };
                    
                    todos.push(todo);
                });

                // Save using DataLayer
                try {
                    await DataLayer.saveTodos(todos);
                    console.log('✅ Voice tasks created and saved');
                } catch (error) {
                    console.error('❌ Failed to save voice tasks:', error);
                }
                
                // Close modal and refresh UI
                document.getElementById('voiceModal').classList.remove('active');
                
                // Reset voice button state
                const voiceBtn = document.querySelector('.voice-input-btn');
                voiceBtn.classList.remove('recording');
                
                renderTodos();
                updateStats();
                
                // Show success message
                showToast(`Created ${tasks.length} tasks from your speech!`);
            } else {
                alert('Could not understand any tasks from your speech. Please try again.');
            }
        }

        function parseVoiceToTasks(transcript) {
            // Clean up the transcript
            let text = transcript.toLowerCase().trim();
            
            // Remove filler words and clean up
            text = text.replace(/\b(um|uh|er|ah|like|you know)\b/g, '');
            text = text.replace(/\s+/g, ' ').trim();
            
            // Split by common task separators
            const separators = [
                /\band then\b/g,
                /\balso\b/g,
                /\bnext\b/g,
                /\bafter that\b/g,
                /\bthen\b/g,
                /\bfinally\b/g,
                /\blastly\b/g,
                /\bmoreover\b/g,
                /\bfurthermore\b/g,
                /\bin addition\b/g,
                /\bplus\b/g,
                /\boh and\b/g,
                /\band\b/g,
                /\,/g,
                /\./g
            ];
            
            let tasks = [text];
            
            // Split by each separator
            separators.forEach(separator => {
                let newTasks = [];
                tasks.forEach(task => {
                    newTasks.push(...task.split(separator));
                });
                tasks = newTasks;
            });
            
            // Clean and filter tasks
            tasks = tasks
                .map(task => task.trim())
                .filter(task => task.length > 2)
                .map(task => {
                    // Capitalize first letter
                    return task.charAt(0).toUpperCase() + task.slice(1);
                })
                .filter(task => {
                    // Remove very short or meaningless tasks
                    const meaninglessWords = ['i', 'me', 'my', 'the', 'a', 'an', 'to', 'do', 'get', 'go', 'have', 'be', 'will', 'want', 'need'];
                    const words = task.toLowerCase().split(' ');
                    return words.length > 1 || !meaninglessWords.includes(words[0]);
                });
            
            // If we couldn't parse individual tasks, treat the whole thing as one task
            if (tasks.length === 0 && transcript.trim().length > 0) {
                tasks = [transcript.trim().charAt(0).toUpperCase() + transcript.trim().slice(1)];
            }
            
            return tasks;
        }

        function updateVoiceUI(state) {
            const animation = document.getElementById('voiceAnimation');
            const status = document.getElementById('voiceStatus');
            const stopBtn = document.getElementById('voiceStopBtn');
            const processBtn = document.getElementById('voiceProcessBtn');
            const transcript = document.getElementById('voiceTranscript');
            const voiceBtn = document.querySelector('.voice-input-btn');
            
            switch(state) {
                case 'ready':
                    animation.classList.remove('recording');
                    voiceBtn.classList.remove('recording');
                    status.innerHTML = '<h3>Tap to start speaking</h3><p>Tell me what you want to get done today.<br>I\'ll create a todo list for you!</p>';
                    stopBtn.style.display = 'none';
                    processBtn.style.display = 'none';
                    transcript.style.display = 'none';
                    break;
                    
                case 'recording':
                    animation.classList.add('recording');
                    voiceBtn.classList.add('recording');
                    status.innerHTML = '<h3>Listening...</h3><p>Speak clearly and tell me all your tasks.<br>I\'m creating your todo list!</p>';
                    stopBtn.style.display = 'block';
                    processBtn.style.display = 'none';
                    transcript.style.display = 'block';
                    break;
                    
                case 'stopped':
                    animation.classList.remove('recording');
                    voiceBtn.classList.remove('recording');
                    status.innerHTML = '<h3>Processing your speech...</h3><p>Review what I heard and create your tasks!</p>';
                    stopBtn.style.display = 'none';
                    processBtn.style.display = 'block';
                    transcript.style.display = 'block';
                    break;
                    
                case 'error':
                    animation.classList.remove('recording');
                    voiceBtn.classList.remove('recording');
                    status.innerHTML = '<h3>Speech recognition error</h3><p>Please try again or check your microphone.</p>';
                    stopBtn.style.display = 'none';
                    processBtn.style.display = 'none';
                    break;
            }
        }

        function updateTranscriptDisplay() {
            const transcriptElement = document.getElementById('transcriptText');
            transcriptElement.textContent = voiceTranscript || 'Listening for your voice...';
        }

        function handleVoiceAnimationClick() {
            if (!isRecording && recognition) {
                // Start recording if not already recording
                recognition.start();
            }
        }

        function showToast(message) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                z-index: 1000;
                animation: slideDown 3s ease-out forwards;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    10% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    90% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                }
            `;
            document.head.appendChild(style);
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
                document.head.removeChild(style);
            }, 3000);
        }

        // AI Chat Functions
        let chatMessages = [];
        let isAITyping = false;
        let isChatExpanded = false;

        function handleBottomChatInput() {
            const input = document.getElementById('bottomChatInput');
            const message = input.value.trim();
            
            if (message) {
                // Expand chat if not already expanded
                if (!isChatExpanded) {
                    openChatModal();
                }
                
                // Send the message
                sendMessageFromBottom(message);
                input.value = '';
            }
        }

        function openChatModal() {
            document.getElementById('aiChatModal').classList.add('active');
            isChatExpanded = true;
            
            // Force visibility and proper positioning
            forceInputVisibility();
            
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                const chatContainer = document.querySelector('.chat-input-container');
                
                if (chatInput) {
                    // Apply visibility fixes
                    forceInputVisibility();
                    
                    // Ensure container is properly positioned
                    if (chatContainer) {
                        chatContainer.style.setProperty('position', 'fixed', 'important');
                        chatContainer.style.setProperty('bottom', '0', 'important');
                        chatContainer.style.setProperty('left', '0', 'important');
                        chatContainer.style.setProperty('right', '0', 'important');
                        chatContainer.style.setProperty('z-index', '200', 'important');
                    }
                    
                    // Focus with iOS Safari compatibility
                    chatInput.focus();
                    
                    // Scroll to ensure input is visible on iOS
                    setTimeout(() => {
                        chatInput.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'end',
                            inline: 'nearest' 
                        });
                    }, 100);
                }
            }, 300);
        }

        function closeAIChat() {
            document.getElementById('aiChatModal').classList.remove('active');
            document.getElementById('chatInput').value = '';
            document.getElementById('bottomChatInput').value = '';
            isChatExpanded = false;
        }

        function sendMessageFromBottom(message) {
            console.log('=== sendMessageFromBottom called ===');
            console.log('🔵 Message:', message);
            
            // AGGRESSIVE reset - same as main function
            console.log('🔵 AGGRESSIVE CLEAN STATE');
            resetAIState();
            const indicators = document.querySelectorAll('.typing-indicator');
            indicators.forEach(i => i.remove());
            console.log('🔵 State cleaned, isAITyping now:', isAITyping);
            
            // Add user message
            addMessageToChat('user', message);
            
            // Extract tasks
            const detectedTasks = extractTasksFromMessage(message);
            console.log('🔵 Bottom detected tasks:', detectedTasks);
            
            // Start typing
            isAITyping = true;
            window.aiTypingStartTime = Date.now(); // Track when typing started
            showAITyping();
            
            // FALLBACK SYSTEM DISABLED FOR TESTING - Testing real AI only
            console.log('🧪 BOTTOM FALLBACK SYSTEM DISABLED - Testing real AI only');
            const guaranteedTimer = null; // Disabled for testing
            
            // Try real AI
            generateAIResponseWithRetry(message)
                .then(aiResponse => {
                    console.log('🔵 Bottom AI response received:', aiResponse);
                    console.log('🔵 Bottom current isAITyping state:', isAITyping);
                    
                    // Always use the real AI response since fallback is disabled
                    console.log('🔵 Bottom using real AI response (fallback disabled)');
                    clearTimeout(guaranteedTimer);
                    isAITyping = false;
                    hideAITyping();
                    addMessageToChat('ai', aiResponse);
                    
                    console.log('🔍 Bottom task detection check:');
                    console.log('🔍 detectedTasks:', detectedTasks);
                    console.log('🔍 detectedTasks.length:', detectedTasks ? detectedTasks.length : 'null');
                    console.log('🔍 isTaskCreationIntent:', isTaskCreationIntent(message));
                    console.log('🔍 Original message:', message);
                    
                    if (detectedTasks && detectedTasks.length > 0 && isTaskCreationIntent(message)) {
                        console.log('🔍 Bottom showing task popup with tasks:', detectedTasks);
                        setTimeout(() => {
                            showDetectedTasks(detectedTasks);
                        }, 500);
                    } else if (detectedTasks && detectedTasks.length > 0) {
                        console.log('🔍 Bottom tasks detected but isTaskCreationIntent returned false');
                    } else {
                        console.log('🔍 Bottom no tasks detected');
                    }
                    
                    // Extra safety cleanup
                    setTimeout(() => {
                        isAITyping = false;
                        hideAITyping();
                    }, 1000);
                })
                .catch(error => {
                    console.log('🔵 Bottom AI failed:', error.message);
                    console.log('🔵 Bottom Full error:', error);
                    
                    // Since fallback is disabled, handle errors manually
                    resetAIState();
                    addMessageToChat('ai', `❌ AI Error: ${error.message}`);
                });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            console.log('=== sendMessage called ===');
            console.log('Message:', message);
            console.log('isAITyping before:', isAITyping);
            console.log('Current time:', new Date().toLocaleTimeString());
            
            // EMERGENCY CHECK: If isAITyping is stuck, force reset immediately
            if (isAITyping && window.aiTypingStartTime && (Date.now() - window.aiTypingStartTime > 3000)) {
                console.log('🚨 EMERGENCY: Detected stuck isAITyping (>3s), forcing reset');
                resetAIState();
                const indicators = document.querySelectorAll('.typing-indicator');
                indicators.forEach(i => i.remove());
            }
            
            // Check for orphaned typing indicators
            const orphanedIndicators = document.querySelectorAll('.typing-indicator');
            if (orphanedIndicators.length > 0) {
                console.log('🧹 Removing orphaned typing indicators:', orphanedIndicators.length);
                orphanedIndicators.forEach(i => i.remove());
            }
            
            // AGGRESSIVE reset - always start clean
            console.log('🧹 AGGRESSIVE CLEAN STATE');
            resetAIState();
            const indicators = document.querySelectorAll('.typing-indicator');
            indicators.forEach(i => i.remove());
            console.log('🧹 State cleaned, isAITyping now:', isAITyping);
            
            if (message) {
                console.log('✅ Processing message...');
                
                // Clear input immediately
                input.value = '';
                
                // Add user message to chat
                addMessageToChat('user', message);
                
                // Extract tasks FIRST
                const detectedTasks = extractTasksFromMessage(message);
                console.log('📋 Detected tasks:', detectedTasks);
                
                // Start typing indicator
                isAITyping = true;
                window.aiTypingStartTime = Date.now(); // Track when typing started
                showAITyping();
                console.log('👤 AI typing started, isAITyping:', isAITyping);
                
                // FALLBACK SYSTEM DISABLED FOR TESTING - Let's see if real AI works
                console.log('🧪 FALLBACK SYSTEM DISABLED - Testing real AI only');
                const guaranteedTimer = null; // Disabled for testing
                
                // Try real AI (but don't depend on it)
                generateAIResponseWithRetry(message)
                    .then(aiResponse => {
                        console.log('🤖 Real AI responded:', aiResponse);
                        // Only use if we haven't already responded
                        console.log('🤖 Real AI response received:', aiResponse);
                        console.log('🤖 Current isAITyping state:', isAITyping);
                        
                        // Always use the real AI response since fallback is disabled
                        console.log('🤖 Using real AI response (fallback disabled)');
                        clearTimeout(guaranteedTimer);
                        isAITyping = false;
                        hideAITyping();
                        addMessageToChat('ai', aiResponse);
                        
                                            console.log('🔍 Task detection check:');
                    console.log('🔍 detectedTasks:', detectedTasks);
                    console.log('🔍 detectedTasks.length:', detectedTasks ? detectedTasks.length : 'null');
                    console.log('🔍 isTaskCreationIntent:', isTaskCreationIntent(message));
                    console.log('🔍 Original message:', message);
                    
                    // Check if user is agreeing to AI's task suggestion
                    try {
                        const isAgreeing = /^(yes|yeah|yep|sure|ok|okay|sounds good|let's do it|i'm in|absolutely|definitely|of course|please do|go ahead)$/i.test(message.trim());
                        const lastAIMessage = getLastAIMessage();
                        const aiSuggestedTask = lastAIMessage ? extractTaskFromAISuggestion(lastAIMessage) : null;
                        
                        console.log('🔍 Agreement check:', isAgreeing);
                        console.log('🔍 Last AI message:', lastAIMessage);
                        console.log('🔍 AI suggested task:', aiSuggestedTask);
                        console.log('🔍 Both conditions met?', isAgreeing && aiSuggestedTask);
                        
                        if (isAgreeing && aiSuggestedTask) {
                            console.log('🔍 ✅ User agreed to AI suggestion, showing task popup for:', aiSuggestedTask);
                            console.log('🔍 ✅ Calling showDetectedTasks with:', [aiSuggestedTask]);
                            showDetectedTasks([aiSuggestedTask]);
                        } else {
                            console.log('🔍 ❌ Conditions not met - isAgreeing:', isAgreeing, 'aiSuggestedTask:', aiSuggestedTask);
                        }
                        
                        // Check if user expressed intent to do something (immediate popup)
                        const directTaskFromMessage = extractDirectTaskFromMessage(message);
                        if (directTaskFromMessage) {
                            console.log('🔍 ✅ Direct task detected, showing popup immediately:', directTaskFromMessage);
                            // Handle both single task (string) and multiple tasks (array)
                            const tasksToShow = Array.isArray(directTaskFromMessage) ? directTaskFromMessage : [directTaskFromMessage];
                            showDetectedTasks(tasksToShow);
                        } else if (detectedTasks && detectedTasks.length > 0 && isTaskCreationIntent(message)) {
                            console.log('🔍 Showing task popup with tasks:', detectedTasks);
                            setTimeout(() => {
                                showDetectedTasks(detectedTasks);
                            }, 500);
                        } else if (detectedTasks && detectedTasks.length > 0) {
                            console.log('🔍 Tasks detected but isTaskCreationIntent returned false');
                        } else {
                            console.log('🔍 No tasks detected');
                        }
                    } catch (error) {
                        console.error('🔍 Error in agreement check:', error);
                        // Fall back to normal task detection
                        if (detectedTasks && detectedTasks.length > 0 && isTaskCreationIntent(message)) {
                            console.log('🔍 Fallback: Showing task popup with tasks:', detectedTasks);
                            setTimeout(() => {
                                showDetectedTasks(detectedTasks);
                            }, 500);
                        } else if (detectedTasks && detectedTasks.length > 0) {
                            console.log('🔍 Fallback: Tasks detected but isTaskCreationIntent returned false');
                        } else {
                            console.log('🔍 Fallback: No tasks detected');
                        }
                    }
                        
                        // Extra safety cleanup
                        setTimeout(() => {
                            isAITyping = false;
                            hideAITyping();
                        }, 1000);
                    })
                    .catch(error => {
                        console.log('🤖 Real AI failed:', error.message);
                        console.log('🤖 Full error:', error);
                        
                        // Since fallback is disabled, we need to handle errors manually
                        resetAIState();
                        addMessageToChat('ai', `❌ AI Error: ${error.message}`);
                    });
                    
            } else {
                console.log('❌ No message to send');
            }
        }
        
        // Helper function to properly reset AI state
        function resetAIState() {
            isAITyping = false;
            window.aiTypingStartTime = null;
            hideAITyping();
        }
        
        // Determine if user wants to create tasks or just have a conversation
        function isTaskCreationIntent(message) {
            const lowerMessage = message.toLowerCase();
            
            // Conversational phrases that indicate they DON'T want to create tasks
            const conversationalIndicators = [
                'can you give me',
                'what should i',
                'any suggestions',
                'suggestions on',
                'ideas for',
                'what are some',
                'help me think',
                'brainstorm',
                'recommend',
                'advice',
                'how do i',
                'what would you',
                'tell me about',
                'explain',
                'how are you',
                'hello',
                'hi',
                'hey'
            ];
            
            // Check if message contains conversational indicators
            for (const indicator of conversationalIndicators) {
                if (lowerMessage.includes(indicator)) {
                    console.log('🗣️ Detected conversational intent:', indicator);
                    return false;
                }
            }
            
            // Task creation phrases that indicate they DO want to create tasks
            const taskCreationIndicators = [
                'i want to',
                'i wanna',
                'i need to',
                'i have to',
                'i should',
                'i plan to',
                'remind me to',
                'add task',
                'create task',
                'add this to my planner',
                'add to my planner',
                'add these to my planner',
                'my goal is',
                'today i will',
                'tomorrow i will',
                // Agreement phrases that indicate they want to act on a suggestion
                'i\'ll do that',
                'ill do that',
                'i will do that',
                'okay i\'ll',
                'okay ill',
                'sounds good',
                'sounds nice',
                'that sounds good',
                'that sounds nice',
                'good idea',
                'great idea',
                'yes i\'ll',
                'yes ill',
                'yeah i\'ll',
                'yeah ill',
                'i agree',
                'let\'s do it',
                'lets do it',
                'i\'m in',
                'im in',
                'count me in'
            ];
            
            // Check for pattern-based task creation phrases
            const taskCreationPatterns = [
                /add .+ to my planner/i,
                /add .+ to the planner/i,
                /create .+ task/i,
                /make .+ task/i,
                /schedule .+ for/i,
                /plan to .+/i
            ];
            
            // Check patterns first (more specific)
            for (const pattern of taskCreationPatterns) {
                if (pattern.test(lowerMessage)) {
                    console.log('✅ Detected task creation pattern:', pattern.toString());
                    return true;
                }
            }
            
            // Check if message contains task creation indicators
            for (const indicator of taskCreationIndicators) {
                if (lowerMessage.includes(indicator)) {
                    console.log('✅ Detected task creation intent:', indicator);
                    return true;
                }
            }
            
            // Default to conversation if unclear
            console.log('🗣️ Defaulting to conversational mode');
            return false;
        }

        // Get the last AI message from chat history
        function getLastAIMessage() {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) {
                console.log('🔍 chatHistory element not found');
                return null;
            }
            
            const aiMessages = chatHistory.querySelectorAll('.ai-message');
            if (aiMessages.length > 0) {
                return aiMessages[aiMessages.length - 1].textContent.trim();
            }
            return null;
        }

        // Extract task from AI suggestion like "Should I help you add 'take a walk' to your planner?"
        function extractTaskFromAISuggestion(aiMessage) {
            console.log('🔍 Extracting task from AI message:', aiMessage);
            
            // Pattern to match "add 'task' to your planner" or "add \"task\" to your planner"
            const patterns = [
                /add\s+['"]([^'"]+)['"]?\s+to\s+your\s+task\s+list/i,
                /add\s+['"]([^'"]+)['"]?\s+to\s+your\s+planner/i,
                /add\s+['"]([^'"]+)['"]?\s+to\s+planner/i,
                /help\s+you\s+add\s+['"]([^'"]+)['"]?/i,
                /create\s+a\s+task\s+for\s+['"]([^'"]+)['"]?/i,
                /should\s+i\s+add\s+['"]([^'"]+)['"]?\s+to/i
            ];
            
            for (const pattern of patterns) {
                const match = aiMessage.match(pattern);
                if (match) {
                    const task = match[1].trim();
                    console.log('🔍 Extracted task from AI suggestion:', task);
                    return capitalizeFirst(task);
                }
            }
            
            console.log('🔍 No task found in AI suggestion');
            return null;
        }

        // Helper function to capitalize first letter
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Split multiple tasks from a single string
        function splitMultipleTasks(taskString) {
            console.log('🔍 Splitting multiple tasks from:', taskString);
            
            // First try splitting by clear separators: "and", commas, "then"
            let tasks = taskString.split(/\s+and\s+|\s*,\s*|\s+then\s+/i);
            
            // If we didn't get multiple tasks, try to detect task boundaries by action verbs
            if (tasks.length === 1) {
                console.log('🔍 Trying direct pattern matching for:', taskString);
                
                // Use direct regex to capture tasks that start with action verbs, stopping at other verbs
                const taskPattern = /\b(go to (?:the )?[a-zA-Z\s]+?)(?=\s+(?:read|call|walk|buy|clean|do|make|cook|visit|run|swim|exercise|study|work|play|eat|drink|watch|listen|write|send|and|,)|$)|read a [a-zA-Z\s]+?(?=\s+(?:go|call|walk|buy|clean|do|make|cook|visit|run|swim|exercise|study|work|play|eat|drink|watch|listen|write|send|and|,)|$)|call (?:my )?[a-zA-Z\s]+?(?=\s+(?:go|read|walk|buy|clean|do|make|cook|visit|run|swim|exercise|study|work|play|eat|drink|watch|listen|write|send|and|,)|$)|walk (?:my )?[a-zA-Z\s]+?(?=\s+(?:go|read|call|buy|clean|do|make|cook|visit|run|swim|exercise|study|work|play|eat|drink|watch|listen|write|send|and|,)|$)|buy [a-zA-Z\s]+?(?=\s+(?:go|read|call|walk|clean|do|make|cook|visit|run|swim|exercise|study|work|play|eat|drink|watch|listen|write|send|and|,)|$)/gi;
                
                const matches = taskString.match(taskPattern);
                console.log('🔍 Direct pattern matches:', matches);
                
                if (matches && matches.length > 1) {
                    // Clean up each match
                    const cleanedTasks = matches.map(task => {
                        // Remove trailing "and" or connecting words
                        task = task.replace(/\s+and\s*$/i, '').trim();
                        return capitalizeFirst(task);
                    });
                    
                    console.log('🔍 Cleaned tasks:', cleanedTasks);
                    tasks = cleanedTasks;
                }
            }
            
            // Clean up each task
            tasks = tasks.map(task => {
                task = task.trim();
                
                // Remove leading articles and connecting words
                task = task.replace(/^(the|a|an)\s+/i, '');
                
                // Capitalize first letter
                return capitalizeFirst(task);
            }).filter(task => task.length > 2); // Filter out very short tasks
            
            console.log('🔍 Split result:', tasks);
            return tasks;
        }

        // Extract task directly from user's current message  
        function extractDirectTaskFromMessage(message) {
            console.log('🔍 Checking for direct task in message:', message);
            
            const text = message.toLowerCase().trim();
            
            // "I want to" patterns (including "I also want to") - with multiple task support
            const wantPattern = /^(?:i (?:also )?want to|i (?:also )?wanna) (.+)$/i;
            const wantMatch = message.match(wantPattern);
            if (wantMatch) {
                const taskString = wantMatch[1].trim().replace(/[.!?]*$/, ''); // Remove trailing punctuation
                console.log('🔍 Found "I want to" task string:', taskString);
                
                // Check if it contains multiple tasks (split by "and", commas, etc.)
                const multipleTasks = splitMultipleTasks(taskString);
                if (multipleTasks.length > 1) {
                    console.log('🔍 Found multiple tasks:', multipleTasks);
                    return multipleTasks; // Return array of tasks
                } else {
                    return capitalizeFirst(taskString);
                }
            }
            
            // "I need to" patterns (including "I also need to")
            const needPattern = /^i (?:also )?need to (.+)$/i;
            const needMatch = message.match(needPattern);
            if (needMatch) {
                const task = needMatch[1].trim().replace(/[.!?]*$/, ''); // Remove trailing punctuation
                console.log('🔍 Found "I need to" task:', task);
                return capitalizeFirst(task);
            }
            
            // "I should" patterns (including "I also should")
            const shouldPattern = /^i (?:also )?should (.+)$/i;
            const shouldMatch = message.match(shouldPattern);
            if (shouldMatch) {
                const task = shouldMatch[1].trim().replace(/[.!?]*$/, ''); // Remove trailing punctuation
                console.log('🔍 Found "I should" task:', task);
                return capitalizeFirst(task);
            }
            
            // Continuation patterns like "oh and [action]" (with optional punctuation)
            const continuationPattern = /^(?:oh[,\s]*and|and\s+also|also|and)[,\s]+(.+)$/i;
            const continuationMatch = message.match(continuationPattern);
            if (continuationMatch) {
                const task = continuationMatch[1].trim().replace(/[.!?]*$/, ''); // Remove trailing punctuation
                console.log('🔍 Found continuation task:', task);
                return capitalizeFirst(task);
            }
            
            // "Can you add [task] to the list?" patterns
            const canYouAddPattern = /^(?:can you (?:also )?add|please add|add) (.+?) to (?:the )?(?:list|planner|tasks?)[\?\.]*$/i;
            const canYouAddMatch = message.match(canYouAddPattern);
            if (canYouAddMatch) {
                const task = canYouAddMatch[1].trim().replace(/[.!?]*$/, ''); // Remove trailing punctuation
                console.log('🔍 Found "can you add" task:', task);
                return capitalizeFirst(task);
            }

            // Direct action patterns without "I" - like "do laundry", "walk my cat"
            const directActionPattern = /^(do|walk|feed|clean|call|buy|get|go|visit|make|cook|finish|complete|organize|study|work|play|exercise|run|swim)[,\s]+(.+)$/i;
            const directActionMatch = message.match(directActionPattern);
            if (directActionMatch) {
                const action = directActionMatch[1];
                const object = directActionMatch[2].trim().replace(/[.!?]*$/, ''); // Remove trailing punctuation
                const task = `${action} ${object}`;
                console.log('🔍 Found direct action task:', task);
                return capitalizeFirst(task);
            }
            
            console.log('🔍 No direct task found in message');
            return null;
        }

        // Find task from recent conversation context
        function findTaskFromRecentContext() {
            console.log('🔍 Looking for task in recent context...');
            
            try {
                const chatHistory = document.getElementById('chatHistory');
                if (!chatHistory) {
                    console.log('🔍 No chat history found');
                    return null;
                }
                
                const allMessages = chatHistory.querySelectorAll('.user-message, .ai-message');
                const recentMessages = Array.from(allMessages).slice(-6); // Last 6 messages
                
                // Look for "I want to" patterns in recent user messages
                for (let i = recentMessages.length - 1; i >= 0; i--) {
                    const messageElement = recentMessages[i];
                    const messageText = messageElement.textContent.trim();
                    
                    if (messageElement.classList.contains('user-message')) {
                        console.log('🔍 Checking user message:', messageText);
                        
                        // Look for "I want to [action]" patterns
                        const wantPattern = /i want to (.+)/i;
                        const wantMatch = messageText.match(wantPattern);
                        if (wantMatch) {
                            const action = wantMatch[1].trim();
                            console.log('🔍 Found "I want to" action:', action);
                            return capitalizeFirst(action);
                        }
                        
                        // Look for "I need to [action]" patterns  
                        const needPattern = /i need to (.+)/i;
                        const needMatch = messageText.match(needPattern);
                        if (needMatch) {
                            const action = needMatch[1].trim();
                            console.log('🔍 Found "I need to" action:', action);
                            return capitalizeFirst(action);
                        }
                        
                        // Look for direct action statements
                        const directActions = ['buy', 'get', 'purchase', 'go to', 'visit', 'call', 'email', 'text'];
                        for (const actionWord of directActions) {
                            const actionPattern = new RegExp(`\\b${actionWord}\\s+(.+)`, 'i');
                            const actionMatch = messageText.match(actionPattern);
                            if (actionMatch) {
                                const action = `${actionWord} ${actionMatch[1]}`.trim();
                                console.log('🔍 Found direct action:', action);
                                return capitalizeFirst(action);
                            }
                        }
                    }
                }
                
                console.log('🔍 No task found in recent context');
                return null;
                
            } catch (error) {
                console.error('🔍 Error finding task from context:', error);
                return null;
            }
        }

        // Quick response generator for fallback
        function generateQuickResponse(message, detectedTasks) {
            console.log('📝 Generating quick response for:', message);
            console.log('📝 Detected tasks:', detectedTasks);
            
            try {
                const lowerMessage = message.toLowerCase();
                
                // Check if user wants to create tasks or just chat
                const wantsToCreateTasks = isTaskCreationIntent(message);
                
                if (detectedTasks && detectedTasks.length > 0 && wantsToCreateTasks) {
                    const taskList = detectedTasks.join(' and ');
                    const response = `Great! I can see you want to work on: ${taskList}. I'll help you add these to your planner. When are you thinking of tackling these tasks?`;
                    console.log('📝 Using task-based response:', response);
                    return response;
                } else if (detectedTasks && detectedTasks.length > 0 && !wantsToCreateTasks) {
                    // They mentioned activities but don't want to create tasks - give suggestions instead
                    console.log('📝 Providing suggestions instead of creating tasks');
                    return generateSuggestionResponse(message);
                }
            } catch (error) {
                console.error('📝 Error in generateQuickResponse:', error);
            }
            
            // Generate conversational suggestions instead of tasks
            return generateSuggestionResponse(message);
        }
        
        // Generate helpful suggestions without creating tasks
        function generateSuggestionResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('suggestions') || lowerMessage.includes('ideas') || lowerMessage.includes('what should')) {
                const suggestions = [
                    "Here are some great things you could do today:",
                    "• Take a refreshing walk outside 🚶‍♀️",
                    "• Read a few chapters of a good book 📚", 
                    "• Call a friend or family member 📞",
                    "• Try a new recipe or cook a favorite meal 🍳",
                    "• Do some light cleaning or organizing 🧹",
                    "• Practice a hobby or creative activity 🎨",
                    "• Exercise or stretch for 20-30 minutes 💪",
                    "• Listen to music or a podcast 🎵",
                    "",
                    "Would you like me to help you create tasks for any of these activities? Just let me know what you'd like to commit to doing!"
                ];
                return suggestions.join('\n');
            }
            
            // Context-aware responses for common cases
            if (lowerMessage.includes('call') && lowerMessage.includes('mom')) {
                return "📞 Calling your mom is such a thoughtful idea! Family connections are so important. What's a good time when you both are usually free to chat?";
            } else if (lowerMessage.includes('read') && lowerMessage.includes('book')) {
                return "📚 Reading is an excellent goal! What type of book are you in the mood for? Setting aside some dedicated reading time will help make it happen.";
            } else if (lowerMessage.includes('gym') || lowerMessage.includes('workout') || lowerMessage.includes('exercise')) {
                return "💪 That's awesome! Exercise is such an important habit. What time of day works best for your workouts?";
            } else if (lowerMessage.includes('walk') && lowerMessage.includes('dog')) {
                return "🐕 Your dog will love that! Regular walks are great exercise for both of you. How long do you usually walk for?";
            } else if (lowerMessage.includes('clean')) {
                return "🧹 Cleaning can feel so satisfying once it's done! Which area are you planning to tackle first?";
            } else if (lowerMessage.includes('cook') || lowerMessage.includes('food') || lowerMessage.includes('eat')) {
                return "🍳 Cooking is such a great skill! Are you planning to try a new recipe or make a favorite dish?";
            } else if (lowerMessage.includes('work') || lowerMessage.includes('study')) {
                return "📝 Staying productive is important! What's the main thing you want to focus on getting done?";
            } else {
                const response = `I hear you want to work on something important! I'm here to help you organize your day. What's the most important thing you'd like to focus on?`;
                console.log('📝 Using fallback response:', response);
                return response;
            }
            
            // Emergency fallback if everything else fails
            return "I'm here to help! What would you like to work on today?";
        }


        function addMessageToChat(sender, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${sender}-message`;
            
            if (sender === 'ai') {
                messageDiv.innerHTML = `
                    <div class="message-bubble ai-bubble">
                        <i class="fas fa-robot"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                // CRITICAL: Always ensure AI state is clean after adding AI message
                setTimeout(() => {
                    console.log('🔄 Checking AI state after AI message added, isAITyping:', isAITyping);
                    if (isAITyping) {
                        console.log('🔄 Auto-reset AI state after AI message added');
                        resetAIState();
                    }
                }, 300);
                
            } else {
                messageDiv.innerHTML = `
                    <div class="message-bubble user-bubble">
                        <span>${message}</span>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            
            // Smooth scroll to bottom for new messages
            setTimeout(() => {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 50);
            
            // Store message
            chatMessages.push({ sender, message, timestamp: new Date() });
            
            // Show create tasks button after meaningful conversation
            if (chatMessages.length >= 4) { // After at least 2 exchanges
                const createTasksBtn = document.getElementById('createTasksBtn');
                if (createTasksBtn) {
                    createTasksBtn.style.display = 'flex';
                }
            }
        }

        function showAITyping() {
            // First, make sure any existing typing indicator is removed
            hideAITyping();
            
            isAITyping = true;
            console.log('AI typing started');
            
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-bubble ai-bubble">
                    <i class="fas fa-robot"></i>
                    <span>AI is thinking</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideAITyping() {
            isAITyping = false;
            console.log('AI typing stopped, isAITyping now:', isAITyping);
            
            // Remove all typing indicators to prevent duplicates
            const typingIndicators = document.querySelectorAll('.typing-indicator');
            typingIndicators.forEach(indicator => indicator.remove());
            
            // Force reset the flag to ensure future messages can be sent
            setTimeout(() => {
                isAITyping = false;
            }, 100);
        }

        // Enhanced Gemini API Configuration System
        // Get API key from localStorage or use default
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || 'YOUR_GEMINI_API_KEY_HERE';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // Function to save API key
        function saveGeminiApiKey(apiKey) {
            localStorage.setItem('gemini_api_key', apiKey);
            GEMINI_API_KEY = apiKey;
            showToast('✅ Gemini API key saved successfully!');
        }

        // Function to clear API key
        function clearGeminiApiKey() {
            localStorage.removeItem('gemini_api_key');
            GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE';
            updateSettingsButtonIndicator();
            showToast('🗑️ Gemini API key cleared');
        }

        // Check if API key is configured
        function isGeminiConfigured() {
            return GEMINI_API_KEY && GEMINI_API_KEY !== 'YOUR_GEMINI_API_KEY_HERE' && GEMINI_API_KEY.length > 10;
        }

        // Settings Modal Functions
        function showSettings() {
            const modal = document.getElementById('settingsModal');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const modelSelect = document.getElementById('modelSelect');
            const responseStyleSelect = document.getElementById('responseStyleSelect');
            
            // Load current settings
            apiKeyInput.value = isGeminiConfigured() ? GEMINI_API_KEY : '';
            modelSelect.value = localStorage.getItem('gemini_model') || 'gemini-2.0-flash';
            responseStyleSelect.value = localStorage.getItem('response_style') || 'casual';
            
            updateAPIStatus();
            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function updateAPIStatus() {
            const statusEl = document.getElementById('apiStatus');
            if (isGeminiConfigured()) {
                statusEl.textContent = '✅ Connected';
                statusEl.style.color = '#51cf66';
            } else {
                statusEl.textContent = '❌ Not configured';
                statusEl.style.color = '#ff6b6b';
            }
        }

        function saveApiSettings() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const modelSelect = document.getElementById('modelSelect');
            const responseStyleSelect = document.getElementById('responseStyleSelect');
            
            const apiKey = apiKeyInput.value.trim();
            const model = modelSelect.value;
            const responseStyle = responseStyleSelect.value;
            
            if (apiKey && apiKey !== 'YOUR_GEMINI_API_KEY_HERE') {
                saveGeminiApiKey(apiKey);
                localStorage.setItem('gemini_model', model);
                localStorage.setItem('response_style', responseStyle);
                
                // Update the API URL with selected model
                const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
                
                // Update settings button indicator
                updateSettingsButtonIndicator();
                
                closeSettingsModal();
            } else {
                showToast('❌ Please enter a valid API key');
                apiKeyInput.focus();
            }
        }

        function updateSettingsButtonIndicator() {
            const settingsBtn = document.querySelector('.settings-btn');
            if (settingsBtn) {
                settingsBtn.style.position = 'relative';
                if (isGeminiConfigured()) {
                    // Green dot - configured
                    settingsBtn.innerHTML = '<i class="fas fa-cog"></i><div style="position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; background: #51cf66; border-radius: 50%; border: 2px solid #15202B;"></div>';
                } else {
                    // Orange dot - not configured
                    settingsBtn.innerHTML = '<i class="fas fa-cog"></i><div style="position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; background: #ff9800; border-radius: 50%; border: 2px solid #15202B;"></div>';
                }
            }
        }

        async function testGeminiAPI() {
            const testBtn = document.getElementById('testApiBtn');
            const testResult = document.getElementById('testResult');
            const apiKeyInput = document.getElementById('apiKeyInput');
            
            const testApiKey = apiKeyInput.value.trim();
            if (!testApiKey || testApiKey === 'YOUR_GEMINI_API_KEY_HERE') {
                testResult.style.display = 'block';
                testResult.style.background = 'rgba(255, 107, 107, 0.1)';
                testResult.style.color = '#ff6b6b';
                testResult.innerHTML = '❌ Please enter an API key first';
                return;
            }
            
            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            testResult.style.display = 'block';
            testResult.style.background = 'rgba(102, 126, 234, 0.1)';
            testResult.style.color = '#667eea';
            testResult.innerHTML = '🔄 Testing connection...';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': testApiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'Hello! Please respond with just "API test successful" to confirm the connection.'
                            }]
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'API connected!';
                    
                    testResult.style.background = 'rgba(81, 207, 102, 0.1)';
                    testResult.style.color = '#51cf66';
                    testResult.innerHTML = `✅ Success! AI responded: "${aiResponse.substring(0, 100)}${aiResponse.length > 100 ? '...' : ''}"`;
                } else {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
            } catch (error) {
                testResult.style.background = 'rgba(255, 107, 107, 0.1)';
                testResult.style.color = '#ff6b6b';
                testResult.innerHTML = `❌ Test failed: ${error.message}`;
            }
            
            testBtn.disabled = false;
            testBtn.innerHTML = '<i class="fas fa-play"></i> Test AI Connection';
        }

        // Goals Management
        let goals = [];
        let selectedGoalCategories = [];
        let currentEditingGoalId = null;
        let selectedFrequency = 'daily';
        let selectedDays = [];
        let weeklyCount = 3;

        // Load goals from localStorage
        async function loadGoals() {
            try {
                const savedGoals = JSON.parse(localStorage.getItem('memaster_goals')) || [];
                goals = savedGoals;
                renderGoals();
                updateGoalsStats();
                console.log('✅ Loaded', goals.length, 'goals from localStorage');
            } catch (error) {
                console.error('❌ Failed to load goals:', error);
                goals = [];
            }
        }

        // Save goals to localStorage
        async function saveGoals() {
            try {
                localStorage.setItem('memaster_goals', JSON.stringify(goals));
                console.log('✅ Goals saved to localStorage');
                updateGoalsStats();
            } catch (error) {
                console.error('❌ Failed to save goals:', error);
            }
        }

        // Show goal modal
        function showGoalModal() {
            const modal = document.getElementById('goalModal');
            const modalTitle = document.getElementById('goalModalTitle');
            const submitBtn = document.getElementById('goalSubmitBtn');
            
            // Reset form
            resetGoalForm();
            
            // Set for adding new goal
            currentEditingGoalId = null;
            modalTitle.textContent = 'Add New Goal';
            submitBtn.textContent = 'Add Goal';
            
            modal.classList.add('active');
            document.body.classList.add('modal-open');
            
            // Initialize frequency handlers
            setTimeout(() => {
                initializeFrequencyHandlers();
                document.getElementById('goalTitleInput').focus();
            }, 300);
        }

        // Close goal modal
        function closeGoalModal() {
            const modal = document.getElementById('goalModal');
            modal.classList.remove('active');
            document.body.classList.remove('modal-open');
            resetGoalForm();
        }

        // Reset goal form
        function resetGoalForm() {
            document.getElementById('goalTitleInput').value = '';
            document.getElementById('goalDescriptionInput').value = '';
            document.getElementById('goalTargetDateInput').value = '';
            document.getElementById('goalProgressInput').value = '0';
            document.getElementById('progressDisplay').textContent = '0%';
            document.getElementById('goalCategoryInput').value = '';
            // Goals automatically appear in Today tab based on frequency
            
            // Reset priority
            selectedPriority = 'medium';
            updatePriorityButtons();
            
            // Reset categories
            selectedGoalCategories = [];
            updateGoalCategoriesDisplay();
            
            // Reset frequency settings
            selectedFrequency = 'daily';
            selectedDays = [];
            weeklyCount = 3;
            updateFrequencyButtons();
            updateDaysDisplay();
            updateCountButtons();
        }

        // Initialize frequency event handlers
        function initializeFrequencyHandlers() {
            // Frequency button handlers
            document.querySelectorAll('.frequency-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const frequency = this.dataset.frequency;
                    selectFrequency(frequency);
                });
            });

            // Day button handlers
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const day = this.dataset.day;
                    toggleDay(day);
                });
            });

            // Count button handlers
            document.querySelectorAll('.count-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const count = parseInt(this.dataset.count);
                    selectWeeklyCount(count);
                });
            });
        }

        // Select frequency type
        function selectFrequency(frequency) {
            selectedFrequency = frequency;
            updateFrequencyButtons();
            
            const daysGroup = document.getElementById('daysOfWeekGroup');
            const flexibleGroup = document.getElementById('flexibleFrequencyGroup');
            
            // Hide all groups first
            daysGroup.style.display = 'none';
            flexibleGroup.style.display = 'none';
            
            if (frequency === 'weekly') {
                daysGroup.style.display = 'block';
            } else if (frequency === 'flexible') {
                flexibleGroup.style.display = 'block';
                updateFlexibleSummary();
            } else {
                // Daily mode - clear selections
                selectedDays = [];
                updateDaysDisplay();
            }
        }

        // Update frequency button states
        function updateFrequencyButtons() {
            document.querySelectorAll('.frequency-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.frequency === selectedFrequency) {
                    btn.classList.add('active');
                }
            });
        }

        // Toggle day selection
        function toggleDay(day) {
            const index = selectedDays.indexOf(day);
            if (index > -1) {
                selectedDays.splice(index, 1);
            } else {
                selectedDays.push(day);
            }
            updateDaysDisplay();
            updateFrequencySummary();
        }

        // Update day button states
        function updateDaysDisplay() {
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('active');
                if (selectedDays.includes(btn.dataset.day)) {
                    btn.classList.add('active');
                }
            });
        }

        // Select weekly count
        function selectWeeklyCount(count) {
            weeklyCount = count;
            updateCountButtons();
            updateFlexibleSummary();
        }

        // Update count button states
        function updateCountButtons() {
            document.querySelectorAll('.count-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.count) === weeklyCount) {
                    btn.classList.add('active');
                }
            });
        }

        // Update flexible frequency summary
        function updateFlexibleSummary() {
            const summaryEl = document.querySelector('#flexibleSummary .summary-text');
            if (!summaryEl) return;
            summaryEl.textContent = `Appears daily - complete ${weeklyCount} times per week`;
        }

        // Update frequency summary text
        function updateFrequencySummary() {
            const summaryEl = document.querySelector('.summary-text');
            if (!summaryEl) return;

            if (selectedDays.length === 0) {
                summaryEl.textContent = 'Select days to work on this goal';
            } else if (selectedDays.length === 7) {
                summaryEl.textContent = 'Daily - appears every day';
            } else {
                const dayNames = {
                    'monday': 'Mon', 'tuesday': 'Tue', 'wednesday': 'Wed',
                    'thursday': 'Thu', 'friday': 'Fri', 'saturday': 'Sat', 'sunday': 'Sun'
                };
                const selectedDayNames = selectedDays.map(day => dayNames[day]).join(', ');
                summaryEl.textContent = `${selectedDays.length} times per week: ${selectedDayNames}`;
            }
        }

        // Check if a goal should be shown today based on its frequency settings
        function shouldShowGoalToday(goal, date = new Date()) {
            // Don't show completed goals
            if (goal.completed) {
                return false;
            }

            // If frequency is daily or flexible, show every day
            if (!goal.frequency || goal.frequency === 'daily' || goal.frequency === 'flexible') {
                return true;
            }

            // For weekly frequency, check if today is in scheduled days
            if (goal.frequency === 'weekly' && goal.scheduledDays) {
                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const todayName = dayNames[date.getDay()];
                return goal.scheduledDays.includes(todayName);
            }

            return true; // Default to showing
        }

        // Update progress display
        function updateProgressDisplay(value) {
            document.getElementById('progressDisplay').textContent = value + '%';
        }

        // Save goal
        async function saveGoal() {
            const title = document.getElementById('goalTitleInput').value.trim();
            const description = document.getElementById('goalDescriptionInput').value.trim();
            const targetDate = document.getElementById('goalTargetDateInput').value;
            const progress = parseInt(document.getElementById('goalProgressInput').value);
            // Goals automatically appear in Today tab based on frequency
            
            if (!title) {
                showToast('❌ Please enter a goal title');
                document.getElementById('goalTitleInput').focus();
                return;
            }
            
            // Validate weekly frequency - must select at least one day
            if (selectedFrequency === 'weekly' && selectedDays.length === 0) {
                showToast('❌ Please select at least one day for weekly schedule');
                return;
            }

            const goal = {
                id: currentEditingGoalId || Date.now().toString() + Math.random().toString(36).substr(2, 9),
                title: title,
                description: description,
                priority: selectedPriority,
                targetDate: targetDate || null,
                progress: progress,
                categories: [...selectedGoalCategories],
                completed: progress >= 100,
                // Goals automatically appear in Today tab based on frequency
                frequency: selectedFrequency,
                scheduledDays: selectedFrequency === 'weekly' ? [...selectedDays] : [],
                weeklyCount: selectedFrequency === 'flexible' ? weeklyCount : null,
                createdAt: currentEditingGoalId ? (goals.find(g => g.id === currentEditingGoalId)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (currentEditingGoalId) {
                // Update existing goal
                const index = goals.findIndex(g => g.id === currentEditingGoalId);
                if (index !== -1) {
                    goals[index] = goal;
                    showToast('✅ Goal updated successfully!');
                }
            } else {
                // Add new goal
                goals.push(goal);
                showToast('✅ Goal added successfully!');
            }
            
            await saveGoals();
            renderGoals();
            closeGoalModal();
        }

        // Render goals
        function renderGoals() {
            const container = document.getElementById('goalsList');
            
            if (goals.length === 0) {
                container.innerHTML = `
                    <div class="empty-goals">
                        <i class="fas fa-bullseye"></i>
                        <h3>No goals yet</h3>
                        <p>Set your first goal to start tracking your progress towards achieving your dreams!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            goals.forEach(goal => {
                const goalElement = document.createElement('div');
                goalElement.className = `goal-item ${goal.completed ? 'completed' : ''}`;
                goalElement.innerHTML = `
                    <div class="goal-content" onclick="toggleGoalExpansion('${goal.id}')">
                        <div class="goal-main">
                            <div class="goal-header">
                                <div class="goal-title-container">
                                    <h3 class="goal-title">${goal.title}</h3>
                                    <span class="goal-priority ${goal.priority}">${goal.priority.toUpperCase()}</span>
                                </div>
                                <div class="goal-progress-container">
                                    <div class="goal-progress-text">${goal.progress}%</div>
                                </div>
                            </div>
                            
                            ${goal.description ? `<div class="goal-description">${goal.description}</div>` : ''}
                            
                            <div class="goal-progress">
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" style="width: ${goal.progress}%"></div>
                                </div>
                            </div>
                            
                            <div class="goal-meta">
                                ${goal.targetDate ? `<div class="goal-target-date">
                                    <i class="fas fa-calendar"></i> ${new Date(goal.targetDate).toLocaleDateString()}
                                </div>` : ''}
                                
                                ${goal.categories.length > 0 ? `<div class="goal-categories">
                                    ${goal.categories.map(cat => `<span class="category-tag">${cat}</span>`).join('')}
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="goal-actions">
                        <button class="goal-action-btn goal-edit-btn" onclick="event.stopPropagation(); editGoal('${goal.id}')" title="Edit goal">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                        </button>
                        <button class="goal-action-btn goal-complete-btn" onclick="event.stopPropagation(); toggleGoalComplete('${goal.id}')" 
                                title="${goal.completed ? 'Mark incomplete' : 'Mark complete'}">
                            <i class="fas fa-${goal.completed ? 'undo' : 'check'}"></i>
                            <span>${goal.completed ? 'Undo' : 'Done'}</span>
                        </button>
                        <button class="goal-action-btn goal-delete-btn" onclick="event.stopPropagation(); deleteGoal('${goal.id}')" title="Delete goal">
                            <i class="fas fa-trash"></i>
                            <span>Delete</span>
                        </button>
                    </div>
                `;
                container.appendChild(goalElement);
            });
        }

        // Edit goal
        function editGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            currentEditingGoalId = goalId;
            
            // Populate form
            document.getElementById('goalTitleInput').value = goal.title;
            document.getElementById('goalDescriptionInput').value = goal.description || '';
            document.getElementById('goalTargetDateInput').value = goal.targetDate || '';
            document.getElementById('goalProgressInput').value = goal.progress.toString();
            // Goals automatically appear in Today tab based on frequency
            updateProgressDisplay(goal.progress);
            
            // Set priority
            selectedPriority = goal.priority;
            updatePriorityButtons();
            
            // Set categories
            selectedGoalCategories = [...goal.categories];
            updateGoalCategoriesDisplay();
            
            // Set frequency settings
            selectedFrequency = goal.frequency || 'daily';
            selectedDays = goal.scheduledDays || [];
            weeklyCount = goal.weeklyCount || 3;
            
            // Initialize frequency handlers and update UI
            setTimeout(() => {
                initializeFrequencyHandlers();
                updateFrequencyButtons();
                updateDaysDisplay();
                updateCountButtons();
                updateFrequencySummary();
                updateFlexibleSummary();
                
                // Show/hide selectors based on frequency
                const daysGroup = document.getElementById('daysOfWeekGroup');
                const flexibleGroup = document.getElementById('flexibleFrequencyGroup');
                
                daysGroup.style.display = 'none';
                flexibleGroup.style.display = 'none';
                
                if (selectedFrequency === 'weekly') {
                    daysGroup.style.display = 'block';
                } else if (selectedFrequency === 'flexible') {
                    flexibleGroup.style.display = 'block';
                }
            }, 100);
            
            // Update modal
            const modal = document.getElementById('goalModal');
            const modalTitle = document.getElementById('goalModalTitle');
            const submitBtn = document.getElementById('goalSubmitBtn');
            
            modalTitle.textContent = 'Edit Goal';
            submitBtn.textContent = 'Save Changes';
            
            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        // Toggle goal completion
        async function toggleGoalComplete(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            goal.completed = !goal.completed;
            goal.progress = goal.completed ? 100 : Math.min(goal.progress, 99);
            goal.updatedAt = new Date().toISOString();
            
            await saveGoals();
            renderGoals();
            
            showToast(goal.completed ? '🎉 Goal completed!' : '🔄 Goal marked incomplete');
        }

        // Delete goal
        async function deleteGoal(goalId) {
            if (!confirm('Are you sure you want to delete this goal?')) return;
            
            goals = goals.filter(g => g.id !== goalId);
            await saveGoals();
            renderGoals();
            showToast('🗑️ Goal deleted');
        }

        // Update goals stats
        function updateGoalsStats() {
            const totalGoals = goals.length;
            const completedGoals = goals.filter(g => g.completed).length;
            
            document.getElementById('totalGoalsCount').textContent = totalGoals;
            document.getElementById('completedGoalsCount').textContent = completedGoals;
        }

        // Goal categories management
        function updateGoalCategoriesDisplay() {
            const container = document.getElementById('goalSelectedCategories');
            if (!container) return;
            
            container.innerHTML = '';
            selectedGoalCategories.forEach(category => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.innerHTML = `
                    ${category}
                    <button class="remove-btn" onclick="removeGoalCategory('${category}')">&times;</button>
                `;
                container.appendChild(item);
            });
        }

        function removeGoalCategory(category) {
            selectedGoalCategories = selectedGoalCategories.filter(c => c !== category);
            updateGoalCategoriesDisplay();
        }



        // Generate daily task text based on goal title
        function generateDailyTaskText(goalTitle) {
            const lowerTitle = goalTitle.toLowerCase();
            
            if (lowerTitle.includes('app') || lowerTitle.includes('project') || lowerTitle.includes('build') || lowerTitle.includes('develop')) {
                return 'Work on development';
            } else if (lowerTitle.includes('marathon') || lowerTitle.includes('run') || lowerTitle.includes('exercise') || lowerTitle.includes('fitness')) {
                return 'Work towards fitness goal';
            } else if (lowerTitle.includes('learn') || lowerTitle.includes('study') || lowerTitle.includes('course') || lowerTitle.includes('skill')) {
                return 'Study and practice';
            } else if (lowerTitle.includes('read') || lowerTitle.includes('book')) {
                return 'Read and take notes';
            } else if (lowerTitle.includes('weight') || lowerTitle.includes('diet') || lowerTitle.includes('health')) {
                return 'Focus on health habits';
            } else if (lowerTitle.includes('save') || lowerTitle.includes('money') || lowerTitle.includes('budget')) {
                return 'Track spending and save';
            } else {
                return `Work towards: ${goalTitle}`;
            }
        }

        // Toggle goal expansion to show/hide expanded content
        function toggleGoalExpansion(event, goalId) {
            console.log('🎯 toggleGoalExpansion called for goal:', goalId);
            event.preventDefault();
            event.stopPropagation();
            
            const goalItem = document.querySelector(`[data-goal-id="${goalId}"]`);
            if (!goalItem) {
                console.error('❌ Goal item not found:', goalId);
                return;
            }
            
            const expandedContent = goalItem.querySelector('.todo-expanded-content');
            if (!expandedContent) {
                console.error('❌ Expanded content not found for goal:', goalId);
                return;
            }
            
            const isExpanded = goalItem.classList.contains('expanded');
            console.log('🎯 Goal expansion state:', isExpanded ? 'expanded' : 'collapsed');
            
            // Close all other expanded goals and tasks first
            document.querySelectorAll('.todo-item.expanded, .goal-item-in-today.expanded').forEach(item => {
                if (item !== goalItem) {
                    item.classList.remove('expanded');
                    const otherExpandedContent = item.querySelector('.todo-expanded-content');
                    if (otherExpandedContent) {
                        otherExpandedContent.style.display = 'none';
                    }
                }
            });
            
            // Toggle current goal
            if (isExpanded) {
                goalItem.classList.remove('expanded');
                expandedContent.style.display = 'none';
                console.log('🎯 Goal collapsed');
            } else {
                goalItem.classList.add('expanded');
                expandedContent.style.display = 'block';
                console.log('🎯 Goal expanded');
            }
        }

        // Toggle goal expansion in Today tab
        function toggleGoalExpansionInToday(goalId) {
            console.log('🎯 toggleGoalExpansionInToday called for goal:', goalId);
            
            const goalItem = document.querySelector(`[data-goal-id="${goalId}"]`);
            if (!goalItem) {
                console.error('❌ Goal item not found:', goalId);
                return;
            }
            
            const expandedContent = goalItem.querySelector('.todo-expanded-content');
            if (!expandedContent) {
                console.error('❌ Expanded content not found for goal:', goalId);
                return;
            }
            
            const isExpanded = goalItem.classList.contains('expanded');
            console.log('🎯 Goal expansion state:', isExpanded ? 'expanded' : 'collapsed');
            
            // Close all other expanded goals and tasks first
            document.querySelectorAll('.todo-item.expanded, .goal-item-in-today.expanded').forEach(item => {
                if (item !== goalItem) {
                    item.classList.remove('expanded');
                    const otherExpandedContent = item.querySelector('.todo-expanded-content');
                    if (otherExpandedContent) {
                        otherExpandedContent.style.display = 'none';
                    }
                }
            });
            
            // Toggle current goal
            if (isExpanded) {
                goalItem.classList.remove('expanded');
                expandedContent.style.display = 'none';
                console.log('🎯 Goal collapsed');
            } else {
                goalItem.classList.add('expanded');
                expandedContent.style.display = 'block';
                console.log('🎯 Goal expanded');
            }
        }

        // Toggle goal daily task completion
        function toggleGoalDailyTask(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const todayKey = selectedDate.toISOString().split('T')[0];
            
            // Initialize dailyTasks if it doesn't exist
            if (!goal.dailyTasks) {
                goal.dailyTasks = {};
            }
            
            // Initialize today's task if it doesn't exist
            if (!goal.dailyTasks[todayKey]) {
                goal.dailyTasks[todayKey] = { completed: false, date: todayKey };
            }
            
            // Toggle completion
            const wasCompleted = goal.dailyTasks[todayKey].completed;
            goal.dailyTasks[todayKey].completed = !wasCompleted;
            
            // Update visual state immediately
            const checkbox = event.target;
            if (goal.dailyTasks[todayKey].completed) {
                checkbox.classList.add('checked');
                if (!wasCompleted) {
                    showCompletionAnimation(checkbox);
                }
                showToast('🎯 Daily goal progress logged!');
            } else {
                checkbox.classList.remove('checked');
            }
            
            // Save goals
            saveGoals();
            updateGoalsStats();
        }

        // Show goal detail from Today tab
        function showGoalDetail(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            // Show a simple toast with goal info and option to edit
            showToast(`🎯 ${goal.title} (${goal.progress}% complete)`, 4000);
            
            // Optional: Switch to Goals tab after a delay
            setTimeout(() => {
                if (confirm('Would you like to view this goal in the Goals tab?')) {
                    showView('stats');
                    
                    // Scroll to the specific goal and expand it
                    setTimeout(() => {
                        const goalElement = document.querySelector(`[onclick*="${goalId}"]`)?.closest('.goal-item');
                        if (goalElement) {
                            goalElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            goalElement.classList.add('expanded');
                        }
                    }, 300);
                }
            }, 1000);
        }

        // Toggle task expansion to show/hide expanded content (subtasks + actions)
        function toggleTaskExpansion(event, todoId) {
            event.stopPropagation();
            
            const todoItem = document.querySelector(`[data-todo-id="${todoId}"]`);
            const expandedContent = todoItem.querySelector('.todo-expanded-content');
            
            if (!expandedContent) return; // Safety check
            
            const isExpanded = todoItem.classList.contains('expanded');
            
            // Close all other expanded tasks first
            document.querySelectorAll('.todo-item.expanded').forEach(item => {
                if (item !== todoItem) {
                    item.classList.remove('expanded', 'swiped');
                    const otherExpandedContent = item.querySelector('.todo-expanded-content');
                    if (otherExpandedContent) {
                        otherExpandedContent.style.display = 'none';
                    }
                }
            });
            
            // Toggle current task
            if (isExpanded) {
                todoItem.classList.remove('expanded');
                expandedContent.style.display = 'none';
            } else {
                // Clear any swipe state when expanding
                todoItem.classList.remove('swiped');
                todoItem.classList.add('expanded');
                expandedContent.style.display = 'block';
            }
        }

        // Toggle subtask completion
        function toggleSubtaskComplete(todoId, subtaskIndex) {
            const todo = todos.find(t => t.id === todoId);
            if (!todo || !todo.subtasks || !todo.subtasks[subtaskIndex]) return;
            
            const wasCompleted = todo.subtasks[subtaskIndex].completed;
            const clickedElement = event.target;
            
            // Toggle subtask completion
            todo.subtasks[subtaskIndex].completed = !todo.subtasks[subtaskIndex].completed;
            
            // Update the visual state immediately without re-rendering
            if (todo.subtasks[subtaskIndex].completed) {
                clickedElement.classList.add('checked');
                if (!wasCompleted) {
                    showCompletionAnimation(clickedElement);
                }
            } else {
                clickedElement.classList.remove('checked');
            }
            
            // Update the subtask text appearance
            const subtaskItem = clickedElement.closest('.subtask-item');
            if (subtaskItem) {
                if (todo.subtasks[subtaskIndex].completed) {
                    subtaskItem.classList.add('completed');
                } else {
                    subtaskItem.classList.remove('completed');
                }
            }
            
            // Check if all subtasks are completed to auto-complete the main task
            const allSubtasksCompleted = todo.subtasks.every(subtask => subtask.completed);
            if (allSubtasksCompleted && !todo.completed) {
                todo.completed = true;
                showToast('🎉 Task completed! All subtasks are done.');
                // Update main task checkbox visually
                const mainTaskCheckbox = document.querySelector(`[data-todo-id="${todoId}"] .todo-checkbox`);
                if (mainTaskCheckbox) {
                    mainTaskCheckbox.classList.add('checked');
                }
            } else if (!allSubtasksCompleted && todo.completed) {
                // If task was completed but now has incomplete subtasks, uncheck it
                todo.completed = false;
                const mainTaskCheckbox = document.querySelector(`[data-todo-id="${todoId}"] .todo-checkbox`);
                if (mainTaskCheckbox) {
                    mainTaskCheckbox.classList.remove('checked');
                }
            }
            
            // Save data but don't re-render immediately to preserve visual state
            saveTodos();
            updateStats();
        }

        // Show completion animation
        function showCompletionAnimation(element) {
            const checkElement = document.createElement('div');
            checkElement.className = 'completion-check';
            checkElement.innerHTML = '✓';
            
            // Position it over the checkbox
            const rect = element.getBoundingClientRect();
            checkElement.style.position = 'fixed';
            checkElement.style.left = rect.left + rect.width/2 - 15 + 'px';
            checkElement.style.top = rect.top + rect.height/2 - 15 + 'px';
            checkElement.style.zIndex = '1000';
            
            document.body.appendChild(checkElement);
            
            // Remove animation element after shorter duration
            setTimeout(() => {
                if (checkElement.parentNode) {
                    checkElement.parentNode.removeChild(checkElement);
                }
            }, 600);
        }

        // Simple local storage - no backend needed!
        let isOnline = navigator.onLine;

        // Sync Status Management
        function updateSyncStatus() {
            const statusEl = document.getElementById('syncStatus');
            const iconEl = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            
            if (!statusEl) return; // Not loaded yet
            
            statusEl.className = 'sync-status offline';
            iconEl.className = 'fas sync-icon fa-hdd';
            textEl.textContent = 'Local';
        }

        // Network Status Monitoring (simple)
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('📡 Back online');
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('📡 Gone offline');
        });

        // Simple Data Layer - uses localStorage only
        const DataLayer = {
            // Save todos
            async saveTodos(todosArray) {
                console.log('💾 Saving todos:', todosArray.length, 'items to localStorage');
                localStorage.setItem('memaster_todos', JSON.stringify(todosArray));
                console.log('✅ Todos saved locally');
                return true;
            },

            // Load todos
            async loadTodos() {
                console.log('📂 Loading todos from localStorage...');
                const localTodos = JSON.parse(localStorage.getItem('memaster_todos')) || [];
                console.log('✅ Loaded', localTodos.length, 'todos from localStorage');
                return localTodos;
            }
        };



        // Add retry logic for API calls
        async function generateAIResponseWithRetry(userMessage, retryCount = 0) {
            const maxRetries = 2;
            
            try {
                console.log(`API call attempt ${retryCount + 1}/${maxRetries + 1}`);
                const response = await generateAIResponse(userMessage);
                return response;
            } catch (error) {
                console.log(`API call attempt ${retryCount + 1} failed:`, error.message);
                
                if (retryCount < maxRetries) {
                    // Wait a bit before retrying (exponential backoff)
                    const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s...
                    console.log(`Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return generateAIResponseWithRetry(userMessage, retryCount + 1);
                } else {
                    // All retries exhausted, throw the error
                    throw error;
                }
            }
        }

        async function generateAIResponse(userMessage) {
            console.log('=== generateAIResponse called ===');
            console.log('User message:', userMessage);
            console.log('API Key configured:', GEMINI_API_KEY ? 'YES' : 'NO');
            console.log('API Key length:', GEMINI_API_KEY ? GEMINI_API_KEY.length : 0);
            console.log('Timestamp:', new Date().toISOString());
            console.log('Current URL:', window.location.href);
            console.log('User Agent:', navigator.userAgent);
            
            // Check if API key is configured
            if (!isGeminiConfigured()) {
                console.warn('Gemini API key not configured');
                return "🤖 **AI Assistant Setup Required!** \n\nClick the ⚙️ settings button in the top-left corner to configure your Gemini API key.\n\n**Get your free API key at:** https://aistudio.google.com/app/apikey\n\n**After setup, you'll get:**\n• Intelligent responses to your questions\n• Smart task suggestions\n• Natural conversation about your daily planning\n\nFor now, I can still help with task detection! Try saying: 'I want to go to the gym and read a book'";
            }
            
            try {
                // Get user settings
                const selectedModel = localStorage.getItem('gemini_model') || 'gemini-2.0-flash';
                const responseStyle = localStorage.getItem('response_style') || 'casual';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent`;
                
                console.log('Sending request to:', apiUrl);
                console.log('Using model:', selectedModel);
                console.log('Response style:', responseStyle);
                console.log('Request payload preview:', {
                    message: userMessage.substring(0, 50),
                    hasApiKey: !!GEMINI_API_KEY
                });
                
                // Build system prompt based on response style
                let systemPrompt = '';
                switch (responseStyle) {
                    case 'professional':
                        systemPrompt = 'You are a professional AI assistant helping with productivity and planning. Be courteous, clear, and efficient in your responses.';
                        break;
                    case 'concise':
                        systemPrompt = 'You are a helpful AI assistant. Give brief, direct answers. Keep responses to 1 sentence when possible.';
                        break;
                    case 'detailed':
                        systemPrompt = 'You are a thorough AI assistant. Provide detailed, helpful responses with actionable advice and context.';
                        break;
                    case 'casual':
                    default:
                        systemPrompt = 'You are a casual, friendly AI assistant helping with daily planning. Be conversational and natural - like texting a friend.';
                        break;
                }
                
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: `${systemPrompt}

IMPORTANT: You CANNOT directly add tasks to planners or todo lists. You can only chat and provide suggestions. Never claim you've added, created, or saved anything.

Context: This is a task management app called MeMaster. The user can create tasks, set priorities, schedule items, and get AI assistance with planning.

User said: "${userMessage}"

CRITICAL: Be proactive about task suggestions! When users mention wanting to do something, ALWAYS offer to add it to their planner:
- If they say "I want to [action]" → "Great! Should I add '[action]' to your task list?"
- If they say "I need to [action]" → "Should I help you add '[action]' to your planner?"
- If they mention any action/goal → Offer to add it as a task

Examples:
- User: "I want to buy a bike" → You: "Buying a bike sounds exciting! Should I add 'buy a bike' to your task list?"
- User: "I need to call my mom" → You: "Should I help you add 'call mom' to your planner?"

ALWAYS be helpful and suggest adding tasks when users mention wanting/needing to do something.

${responseStyle === 'concise' ? 'Respond in 1 sentence.' : responseStyle === 'detailed' ? 'Provide a helpful, detailed response.' : 'Respond naturally in 1-2 short sentences max. Be helpful but keep it brief and human-like. No excessive enthusiasm or formal language.'} If they mention tasks or agree to suggestions, acknowledge them and offer to help add them to their planner.`
                        }]
                    }]
                };
                
                console.log('🚀 Making fetch request now...');
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': GEMINI_API_KEY
                    },
                    body: JSON.stringify(requestBody)
                });
                console.log('✅ Fetch request completed, got response object');

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    
                    if (response.status === 403) {
                        throw new Error('Invalid API key - please check your Gemini API key');
                    } else if (response.status === 429) {
                        throw new Error('Rate limit exceeded - too many requests');
                    } else if (response.status === 400) {
                        throw new Error('Bad request - check API parameters');
                    }
                    throw new Error(`API request failed: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('Full API response:', data);
                
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm here to help you plan your day! What would you like to work on?";
                
                console.log('Extracted AI response:', aiResponse);
                return aiResponse;
                
            } catch (error) {
                console.error('Full Gemini API error:', error);
                console.error('Error type:', typeof error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                // Specific error messages for common issues
                if (error.message.includes('Invalid API key')) {
                    return "❌ **API Key Error:** Your Gemini API key appears to be invalid. Please check it and try again. Get a new key at: https://aistudio.google.com/app/apikey";
                }
                
                if (error.message.includes('Rate limit exceeded') || error.message.includes('429')) {
                    return "⏱️ **Rate Limited:** The AI service is getting too many requests. Please wait 30 seconds and try again, or the task detection will still work!";
                }
                
                if (error.message.includes('403')) {
                    return "❌ **Access Denied:** Please check your Gemini API key permissions. Make sure it's correctly configured.";
                }
                
                if (error.message.includes('Failed to fetch') || error.message.includes('network')) {
                    return "🌐 **Network Error:** Can't connect to the AI service. Please check your internet connection and try again.";
                }
                
                // Fallback to simple AI responses
                console.log('Using fallback AI response due to API error');
                
                // Simple rule-based responses for common cases
                const lowerMessage = userMessage.toLowerCase();
                
                if (lowerMessage.includes('read') && lowerMessage.includes('book')) {
                    return "📚 Reading is a great goal! What type of book are you thinking of reading? Setting aside dedicated reading time will help you actually get it done!";
                } else if (lowerMessage.includes('gym') || lowerMessage.includes('exercise') || lowerMessage.includes('workout')) {
                    return "💪 Excellent! Going to the gym is such an important habit. What time works best for your workout? Planning it out will help make sure it happens!";
                } else if (lowerMessage.includes('walk') && lowerMessage.includes('dog')) {
                    return "🐕 Your dog will love that! Walking is great exercise for both of you. What time do you usually take your walks?";
                } else if (lowerMessage.includes('clean')) {
                    return "🧹 Cleaning can be so satisfying once it's done! Breaking it into smaller tasks makes it feel less overwhelming. What area are you planning to tackle?";
                } else if (lowerMessage.includes('call') && lowerMessage.includes('mom')) {
                    return "📞 That's so thoughtful! Family connections are important. Is there a good time when you both are usually free to chat?";
                } else {
                    return `I hear you want to work on: "${userMessage}". That sounds like a great goal! When are you planning to tackle this? The task detection should still work even though the AI service is having issues.`;
                }
            }
        }



        async function createTasksFromChat() {
            // Extract potential tasks from the conversation
            const userMessages = chatMessages.filter(msg => msg.sender === 'user');
            const extractedTasks = [];
            
            userMessages.forEach(msg => {
                const tasks = extractTasksFromMessage(msg.message);
                extractedTasks.push(...tasks);
            });
            
            if (extractedTasks.length > 0) {
                // Add tasks to the todo list
                extractedTasks.forEach(taskText => {
                    const todo = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        text: taskText.trim(),
                        completed: false,
                        date: selectedDate.toISOString().split('T')[0],
                        createdAt: new Date().toISOString()
                    };
                    todos.push(todo);
                });

                // Save using DataLayer
                try {
                    await DataLayer.saveTodos(todos);
                    console.log('✅ Chat tasks created and saved');
                } catch (error) {
                    console.error('❌ Failed to save chat tasks:', error);
                }
                
                // Close chat and refresh UI
                closeAIChat();
                renderTodos();
                updateStats();
                
                // Show success message
                showToast(`Created ${extractedTasks.length} tasks from your conversation!`);
                
                // Add AI confirmation message
                addMessageToChat('ai', `Perfect! I've created ${extractedTasks.length} tasks for you based on our conversation. Check your Today view to see them!`);
            } else {
                // Add AI message asking for more specific information
                addMessageToChat('ai', "I'd love to help create tasks, but I need a bit more specific information. Can you tell me exactly what you'd like to accomplish today? For example: 'I need to clean my room' or 'I want to call my mom'.");
            }
        }

        function extractTasksFromMessage(message) {
            console.log('=== ENHANCED extractTasksFromMessage called ===');
            console.log('Original message:', message);
            const tasks = [];
            const text = message.toLowerCase().trim();
            console.log('Lowercase text:', text);
            
            // STEP 0: Handle "Add [something] to my planner" patterns first
            const addToPlannerPattern = /^add (.+) to my planner$/i;
            const addToPlannerMatch = message.match(addToPlannerPattern);
            if (addToPlannerMatch) {
                const taskText = addToPlannerMatch[1].trim();
                console.log('📝 Detected "Add to planner" pattern, extracted task:', taskText);
                return [capitalizeFirst(taskText)];
            }
            
            // Handle "Add [something] to the planner" variation  
            const addToThePlannerPattern = /^add (.+) to the planner$/i;
            const addToThePlannerMatch = message.match(addToThePlannerPattern);
            if (addToThePlannerMatch) {
                const taskText = addToThePlannerMatch[1].trim();
                console.log('📝 Detected "Add to the planner" pattern, extracted task:', taskText);
                return [capitalizeFirst(taskText)];
            }

            // Handle "Add that to task list" or similar - look back at conversation context
            const addThatPattern = /^(?:can you )?add (?:that|it) to (?:the )?(?:task list|planner|tasks?)$/i;
            if (addThatPattern.test(message)) {
                console.log('📝 Detected "Add that" pattern, looking for context...');
                const contextTask = findTaskFromRecentContext();
                if (contextTask) {
                    console.log('📝 Found contextual task:', contextTask);
                    return [contextTask];
                }
            }
            
            // STEP 1: Split message by multiple delimiters to catch all parts
            // Split by: periods followed by connectors like "oh and", "also", "then", etc.
            const segments = text.split(/(?:\.\s*(?:oh\s+and|and\s+also|also|then|and\s+then)|,\s*(?:and|also|then))/).filter(s => s.trim().length > 0);
            console.log('📝 Split into segments:', segments);
            
            // If no splits found, try simpler split on periods
            if (segments.length === 1) {
                const periodSplit = text.split(/\.\s*/).filter(s => s.trim().length > 0);
                if (periodSplit.length > 1) {
                    segments.splice(0, 1, ...periodSplit);
                    console.log('📝 Using period split instead:', segments);
                }
            }
            
            // STEP 1.5: If still only one segment, try splitting by commas
            if (segments.length === 1) {
                const commaSplit = text.split(/,\s*(?:and\s+)?/).filter(s => s.trim().length > 0);
                if (commaSplit.length > 1) {
                    segments.splice(0, 1, ...commaSplit);
                    console.log('📝 Using comma split instead:', segments);
                }
            }
            
            // STEP 1.6: Special handling for the specific pattern "Go for a run, walk my dog, and read a book"
            if (segments.length === 1 && text.includes('go for a run') && text.includes('walk my dog') && text.includes('read a book')) {
                console.log('📝 Detected specific 4-task pattern, forcing split');
                const forcedSegments = [];
                
                // Extract "swim today" from first part
                if (text.includes('swim today')) {
                    forcedSegments.push('swim today');
                }
                
                // Extract comma-separated tasks
                const commaParts = text.split(/,\s*(?:and\s+)?/).filter(s => s.trim().length > 0);
                commaParts.forEach(part => {
                    if (part.includes('go for a run') || part.includes('walk my dog') || part.includes('read a book')) {
                        forcedSegments.push(part.trim());
                    }
                });
                
                if (forcedSegments.length > 1) {
                    segments.splice(0, 1, ...forcedSegments);
                    console.log('📝 Forced split result:', segments);
                }
            }
            
            // STEP 1.7: More aggressive comma splitting for any comma-separated list
            if (segments.length === 1 && text.includes(',')) {
                console.log('📝 Detected comma-separated list, aggressive splitting');
                
                // Handle "I want to X, Y, Z, and W" pattern
                if (text.startsWith('i want to ')) {
                    const withoutPrefix = text.replace(/^i\s+want\s+to\s+/, '');
                    console.log('📝 Without prefix:', withoutPrefix);
                    
                    // Split by comma and "and"
                    const commaSplit = withoutPrefix.split(/,\s*(?:and\s+)?/).filter(s => s.trim().length > 0);
                    if (commaSplit.length > 1) {
                        segments.splice(0, 1, ...commaSplit);
                        console.log('📝 Comma split with prefix removal:', segments);
                    }
                } else {
                    // Regular comma splitting
                    const commaSplit = text.split(/,\s*(?:and\s+)?/).filter(s => s.trim().length > 0);
                    if (commaSplit.length > 1) {
                        segments.splice(0, 1, ...commaSplit);
                        console.log('📝 Regular comma split result:', segments);
                    }
                }
            }
            
            // STEP 1.8: Handle continuous task lists without punctuation
            if (segments.length === 1 && text.includes(' and ') && !text.includes(',') && !text.includes('.')) {
                console.log('📝 Detected continuous task list, splitting by "and"');
                const andSplit = text.split(/\s+and\s+/).filter(s => s.trim().length > 0);
                if (andSplit.length > 1) {
                    segments.splice(0, 1, ...andSplit);
                    console.log('📝 Continuous "and" split result:', segments);
                }
            }
            
            // STEP 1.9: Handle concatenated tasks without separators
            if (segments.length === 1 && !text.includes(',') && !text.includes('.') && !text.includes(' and ')) {
                console.log('📝 Detected concatenated tasks, trying smart extraction');
                
                // Look for known task patterns in the text
                const knownTasks = [
                    'go for a run', 'read a book', 'walk my dog', 'clean my room',
                    'swim', 'hike', 'exercise', 'workout', 'call my mom', 'go to the gym'
                ];
                
                const foundTasks = [];
                let remainingText = text;
                
                knownTasks.forEach(task => {
                    if (remainingText.includes(task)) {
                        foundTasks.push(task);
                        remainingText = remainingText.replace(task, '').trim();
                        console.log(`📝 Found task: ${task}, remaining: "${remainingText}"`);
                    }
                });
                
                if (foundTasks.length > 1) {
                    segments.splice(0, 1, ...foundTasks);
                    console.log('📝 Smart extraction result:', segments);
                }
            }
            
            // STEP 1.10: Handle "I want to X Y Z and W" pattern specifically
            if (segments.length === 1 && text.startsWith('i want to ') && text.includes(' and ')) {
                console.log('📝 Detected "I want to" pattern with "and", extracting tasks');
                
                // Remove "I want to" prefix
                const withoutPrefix = text.replace(/^i\s+want\s+to\s+/, '');
                console.log('📝 Without prefix:', withoutPrefix);
                
                // Split by "and"
                const andParts = withoutPrefix.split(/\s+and\s+/);
                console.log('📝 And parts:', andParts);
                
                if (andParts.length > 1) {
                    segments.splice(0, 1, ...andParts);
                    console.log('📝 "I want to" split result:', segments);
                }
            }
            
            segments.forEach((segment, index) => {
                console.log(`📝 Processing segment ${index + 1}:`, segment.trim());
                
                // For segments with "and", try to split further and process each part
                const segmentText = segment.trim();
                if (segmentText.includes(' and ') && index === 0) {
                    // First segment might have multiple tasks connected by "and"
                    console.log('📝 First segment contains "and", processing both parts');
                    const andParts = segmentText.split(' and ');
                    andParts.forEach((part, partIndex) => {
                        const partTasks = extractTasksFromSegment(part.trim());
                        partTasks.forEach(task => {
                            if (task && !tasks.some(existingTask => 
                                existingTask.toLowerCase().includes(task.toLowerCase()) || 
                                task.toLowerCase().includes(existingTask.toLowerCase())
                            )) {
                                tasks.push(task);
                                console.log(`📝 Added task from part ${partIndex + 1}:`, task);
                            }
                        });
                    });
                } else if (segmentText.includes(',') && segmentText.includes(' and ')) {
                    // Handle comma-separated lists with "and" at the end
                    console.log('📝 Segment contains comma list with "and", processing each part');
                    const commaParts = segmentText.split(/,\s*(?:and\s+)?/).filter(s => s.trim().length > 0);
                    commaParts.forEach((part, partIndex) => {
                        const partTasks = extractTasksFromSegment(part.trim());
                        partTasks.forEach(task => {
                            if (task && !tasks.some(existingTask => 
                                existingTask.toLowerCase().includes(task.toLowerCase()) || 
                                task.toLowerCase().includes(existingTask.toLowerCase())
                            )) {
                                tasks.push(task);
                                console.log(`📝 Added task from comma part ${partIndex + 1}:`, task);
                            }
                        });
                    });
                } else if (segmentText.includes(' and ')) {
                    // Any segment with "and" should be split
                    console.log('📝 Segment contains "and", processing both parts');
                    const andParts = segmentText.split(' and ');
                    andParts.forEach((part, partIndex) => {
                        const partTasks = extractTasksFromSegment(part.trim());
                        partTasks.forEach(task => {
                            if (task && !tasks.some(existingTask => 
                                existingTask.toLowerCase().includes(task.toLowerCase()) || 
                                task.toLowerCase().includes(existingTask.toLowerCase())
                            )) {
                                tasks.push(task);
                                console.log(`📝 Added task from "and" part ${partIndex + 1}:`, task);
                            }
                        });
                    });
                } else {
                    // Process segment normally
                    const segmentTasks = extractTasksFromSegment(segmentText);
                    segmentTasks.forEach(task => {
                        if (task && !tasks.some(existingTask => 
                            existingTask.toLowerCase().includes(task.toLowerCase()) || 
                            task.toLowerCase().includes(existingTask.toLowerCase())
                        )) {
                            tasks.push(task);
                            console.log('📝 Added task:', task);
                        }
                    });
                }
            });
            
            console.log('📝 Final extracted tasks:', tasks);
            return tasks;
        }
        
        // Helper function to extract tasks from a single segment
        function extractTasksFromSegment(segment) {
            console.log('🔍 Processing segment:', segment);
            const tasks = [];
            const text = segment.toLowerCase().trim();
            
            // Common task keywords and their normalized forms
            const taskMappings = {
                'clean my room': 'Clean my room',
                'cleand my room': 'Clean my room', // Handle typos
                'clean room': 'Clean my room',
                'tidy my room': 'Clean my room',
                'walk my dog': 'Walk my dog',
                'walk the dog': 'Walk my dog',
                'walk dog': 'Walk my dog',
                'feed my dog': 'Feed my dog',
                'feed the dog': 'Feed my dog',
                'go for a run': 'Go for a run',
                'go running': 'Go for a run',
                'run': 'Go for a run',
                'swim': 'Swim',
                'swimming': 'Swim',
                'go swimming': 'Swim',
                'go for a hike': 'Go for a hike',
                'go hiking': 'Go for a hike',
                'hike': 'Go for a hike',
                'hiking': 'Go for a hike',
                'go to the gym': 'Go to the gym',
                'go to gym': 'Go to the gym',
                'gym': 'Go to the gym',
                'workout': 'Workout',
                'exercise': 'Exercise',
                'read a book': 'Read a book',
                'read book': 'Read a book',
                'call my mom': 'Call my mom',
                'call mom': 'Call my mom',
                'play video games': 'Play video games',
                'play games': 'Play video games',
                'go to the movies': 'Go to the movies',
                'see a movie': 'Go to the movies',
                'watch a movie': 'Watch a movie',
                'eat dinner': 'Eat dinner',
                'have dinner': 'Eat dinner',
                'cook dinner': 'Cook dinner',
                'make dinner': 'Cook dinner',
                'golf': 'Golf',
                'play golf': 'Golf',
                'go golfing': 'Golf',
                'eat lunch': 'Eat lunch',
                'have lunch': 'Eat lunch',
                'eat breakfast': 'Eat breakfast',
                'have breakfast': 'Eat breakfast',
                'cook': 'Cook',
                'make food': 'Cook',
                'prepare food': 'Cook',
                'learn to ride a bike': 'Learn to ride a bike',
                'learn to ride bike': 'Learn to ride a bike',
                'ride a bike': 'Learn to ride a bike',
                'ride bike': 'Learn to ride a bike',
                'learn to play the guitar': 'Learn to play the guitar',
                'learn to play guitar': 'Learn to play the guitar',
                'play the guitar': 'Learn to play the guitar',
                'play guitar': 'Learn to play the guitar',
                'learn to fly a plane': 'Learn to fly a plane',
                'learn to fly plane': 'Learn to fly a plane',
                'fly a plane': 'Learn to fly a plane',
                'fly plane': 'Learn to fly a plane',
                'build an app': 'Build an app',
                'build app': 'Build an app',
                'create an app': 'Build an app',
                'develop an app': 'Build an app',
                'go fishing': 'Go fishing',
                'fishing': 'Go fishing'
            };
            
            // STEP 1: Try to match known task patterns directly
            for (const [pattern, normalizedTask] of Object.entries(taskMappings)) {
                if (text.includes(pattern)) {
                    tasks.push(normalizedTask);
                    console.log('🔍 Direct match found:', normalizedTask);
                    // Don't return early - continue checking for more tasks in the same segment
                }
            }
            
            // If we found direct matches, return them (but only if we found some)
            if (tasks.length > 0) {
                console.log('🔍 Returning direct matches:', tasks);
                return tasks;
            }
            
            // STEP 1.5: Handle "oh and X" patterns specifically
            if (text.startsWith('oh and ')) {
                const afterOhAnd = text.substring(7).trim(); // Remove "oh and "
                console.log('🔍 Processing "oh and" pattern:', afterOhAnd);
                
                // Check if it matches any known tasks
                for (const [pattern, normalizedTask] of Object.entries(taskMappings)) {
                    if (afterOhAnd.includes(pattern)) {
                        tasks.push(normalizedTask);
                        console.log('🔍 "Oh and" match found:', normalizedTask);
                        return tasks;
                    }
                }
                
                // If no direct match, process as regular task
                const ohAndTasks = extractTasksFromSegment(afterOhAnd);
                if (ohAndTasks.length > 0) {
                    return ohAndTasks;
                }
            }
            
            // STEP 1.6: Handle standalone action words (like "swim", "run")
            const standaloneActions = ['swim', 'run', 'walk', 'read', 'exercise', 'workout', 'clean', 'cook', 'study', 'hike'];
            for (const action of standaloneActions) {
                if (text === action || text.startsWith(action + ' ') || text.endsWith(' ' + action)) {
                    let normalizedAction = action.charAt(0).toUpperCase() + action.slice(1);
                    if (action === 'run') normalizedAction = 'Go for a run';
                    if (action === 'swim') normalizedAction = 'Swim';
                    if (action === 'hike') normalizedAction = 'Go for a hike';
                    tasks.push(normalizedAction);
                    console.log('🔍 Standalone action found:', normalizedAction);
                    return tasks;
                }
            }
            
            // STEP 1.6.5: Handle concatenated task phrases
            const concatenatedPatterns = [
                /go\s+for\s+a\s+run\s+read\s+a\s+book\s+walk\s+my\s+dog/i,
                /read\s+a\s+book\s+walk\s+my\s+dog\s+clean\s+my\s+room/i,
                /go\s+for\s+a\s+run\s+read\s+a\s+book/i,
                /read\s+a\s+book\s+walk\s+my\s+dog/i
            ];
            
            for (const pattern of concatenatedPatterns) {
                if (pattern.test(text)) {
                    console.log('🔍 Found concatenated pattern:', pattern);
                    
                    // Extract individual tasks from the pattern
                    if (text.includes('go for a run')) tasks.push('Go for a run');
                    if (text.includes('read a book')) tasks.push('Read a book');
                    if (text.includes('walk my dog')) tasks.push('Walk my dog');
                    if (text.includes('clean my room')) tasks.push('Clean my room');
                    
                    if (tasks.length > 0) {
                        console.log('🔍 Extracted concatenated tasks:', tasks);
                        return tasks;
                    }
                }
            }
            
            // STEP 1.7: Handle "swim today" specifically
            if (text.includes('swim today')) {
                tasks.push('Swim');
                console.log('🔍 "Swim today" pattern found: Swim');
                return tasks;
            }
            
                         // STEP 2: Extract using flexible patterns
             const patterns = [
                 // "I want to X", "I wanna X", etc. - but only extract the core action verb + object
                 /(?:i\s+)?(?:want(?:\s+to)?|wanna|would\s+like(?:\s+to)?|need(?:\s+to)?|have\s+to|should|plan\s+to|gonna|let's|will)\s+(golf|swim|run|walk|hike|exercise|workout|read|call|clean|cook|study|work|play|visit|go)\s*(.*)(?:\s+today|$)/i,
                 // Direct action patterns - specific actions only
                 /^(clean|walk|feed|run|swim|hike|exercise|workout|read|call|play|go|see|watch|do|finish|complete|organize|study|work|golf)\s+(.+?)(?:\s+today|$)/i
             ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    let taskText = '';
                    if (match[1] && match[2]) {
                        // Pattern with action and object (like "clean my room")
                        taskText = `${match[1]} ${match[2]}`.trim();
                    } else if (match[1]) {
                        // Single capture group
                        taskText = match[1].trim();
                    }
                    
                                         if (taskText && taskText.length > 2) {
                                                 // Clean up the task text and fix common typos
                        taskText = taskText.replace(/\bcleand\b/g, 'clean'); // Fix typo
                        
                        // Only remove articles in specific cases where they create awkward phrasing
                        // But preserve them for "learn to" phrases and other contexts where they're needed
                        if (!taskText.toLowerCase().includes('learn to') && 
                            !taskText.toLowerCase().includes('how to') &&
                            !taskText.toLowerCase().includes('try to')) {
                            // Only remove leading articles that make tasks sound awkward
                            taskText = taskText.replace(/^(the|a|an)\s+/i, '').trim();
                        }
                         
                         // Special handling for certain tasks
                         if (taskText.toLowerCase().includes('swim')) {
                             taskText = 'Swim';
                         } else if (taskText.toLowerCase().includes('run') && !taskText.toLowerCase().includes('go for')) {
                             taskText = 'Go for a run';
                         } else if (taskText.toLowerCase().includes('hike')) {
                             taskText = 'Go for a hike';
                         }
                         
                         taskText = capitalizeFirst(taskText);
                         tasks.push(taskText);
                         console.log('🔍 Pattern match found:', taskText);
                         break; // Found a match, no need to try other patterns
                     }
                }
            }
            
            return tasks;
        }
        
        // Debug function - call from console to test task extraction

        
        // Test the exact user message
        window.testUserMessage = function() {
            console.log('=== TESTING USER MESSAGE ===');
            const message = "I want to cleand my room and walk my dog. Oh and go for a run";
            console.log('Testing message:', message);
            const result = extractTasksFromMessage(message);
            console.log('Should find 3 tasks:', result);
            console.log('Expected: ["Clean my room", "Walk my dog", "Go for a run"]');
            console.log('Found', result.length, 'tasks');
            return result;
        }
        
        // Test the current 4-task message
        window.testCurrentMessage = function() {
            console.log('=== TESTING CURRENT 4-TASK MESSAGE ===');
            const message = "Okay i want to swim today. Go for a run, walk my dog, and read a book";
            console.log('Testing message:', message);
            const result = extractTasksFromMessage(message);
            console.log('Should find 4 tasks:', result);
            console.log('Expected: ["Swim", "Go for a run", "Walk my dog", "Read a book"]');
            console.log('Found', result.length, 'tasks');
            return result;
        }
        
        // Test the new 4-task message with hike
        window.testHikeMessage = function() {
            console.log('=== TESTING HIKE MESSAGE ===');
            const message = "Okay i want to read a book. Go for a run. Walk my dog and go for a hike";
            console.log('Testing message:', message);
            const result = extractTasksFromMessage(message);
            console.log('Should find 4 tasks:', result);
            console.log('Expected: ["Read a book", "Go for a run", "Walk my dog", "Go for a hike"]');
            console.log('Found', result.length, 'tasks');
            return result;
        }
        
        // Test the continuous 4-task message
        window.testContinuousMessage = function() {
            console.log('=== TESTING CONTINUOUS 4-TASK MESSAGE ===');
            const message = "I want to go for a run read a book walk my dog and clean my room today";
            console.log('Testing message:', message);
            const result = extractTasksFromMessage(message);
            console.log('Should find 4 tasks:', result);
            console.log('Expected: ["Go for a run", "Read a book", "Walk my dog", "Clean my room"]');
            console.log('Found', result.length, 'tasks');
            return result;
        }
        
        // Test the comma-separated 4-task message
        window.testCommaMessage = function() {
            console.log('=== TESTING COMMA-SEPARATED 4-TASK MESSAGE ===');
            const message = "I want to read a book, go for a run, walk my dog, and clean my room";
            console.log('Testing message:', message);
            const result = extractTasksFromMessage(message);
            console.log('Should find 4 tasks:', result);
            console.log('Expected: ["Read a book", "Go for a run", "Walk my dog", "Clean my room"]');
            console.log('Found', result.length, 'tasks');
            return result;
        }
        
        // Test the current 4-task message with eat dinner
        window.testEatDinnerMessage = function() {
            console.log('=== TESTING EAT DINNER 4-TASK MESSAGE ===');
            const message = "I want to read a book, walk my dog, eat dinner, and call my mom";
            console.log('Testing message:', message);
            const result = extractTasksFromMessage(message);
            console.log('Should find 4 tasks:', result);
            console.log('Expected: ["Read a book", "Walk my dog", "Eat dinner", "Call my mom"]');
            console.log('Found', result.length, 'tasks');
            return result;
        }
        
        // Test task completion functionality
        window.testTaskCompletion = function() {
            console.log('=== TESTING TASK COMPLETION ===');
            console.log('Current todos:', todos);
            console.log('Todo count:', todos.length);
            
            if (todos.length > 0) {
                const firstTodo = todos[0];
                console.log('Testing completion for first todo:', firstTodo);
                console.log('Current completed state:', firstTodo.completed);
                
                // Toggle the first todo
                toggleTodo(firstTodo.id);
            } else {
                console.log('No todos available to test');
            }
        }
        
        // Test checkbox functionality specifically
        window.testCheckboxes = function() {
            console.log('=== TESTING CHECKBOX FUNCTIONALITY ===');
            const checkboxes = document.querySelectorAll('.todo-checkbox');
            console.log('Found checkboxes:', checkboxes.length);
            
            checkboxes.forEach((checkbox, index) => {
                console.log(`Checkbox ${index + 1}:`);
                console.log('- Element:', checkbox);
                console.log('- Classes:', checkbox.className);
                console.log('- Styles:', {
                    zIndex: checkbox.style.zIndex || getComputedStyle(checkbox).zIndex,
                    pointerEvents: checkbox.style.pointerEvents || getComputedStyle(checkbox).pointerEvents,
                    position: getComputedStyle(checkbox).position,
                    display: getComputedStyle(checkbox).display,
                    touchAction: checkbox.style.touchAction || getComputedStyle(checkbox).touchAction
                });
                console.log('- Click handler present:', checkbox.onclick ? 'YES' : 'NO');
                console.log('- Touch handlers present:', {
                    touchstart: checkbox.ontouchstart ? 'YES' : 'NO',
                    touchmove: checkbox.ontouchmove ? 'YES' : 'NO',
                    touchend: checkbox.ontouchend ? 'YES' : 'NO'
                });
            });
            
            if (checkboxes.length > 0) {
                console.log('✅ Checkboxes found and configured');
                console.log('💡 Try clicking on a checkbox circle next to any task');
                console.log('💡 If still not working, check if any browser extensions are interfering');
            } else {
                console.log('❌ No checkboxes found - tasks may not be rendered yet');
                console.log('💡 Try adding a task first, then run this test again');
            }
        }
        
        // Force toggle a task for mobile testing
        window.testMobileCheckbox = function() {
            console.log('=== MOBILE CHECKBOX TEST ===');
            if (todos.length > 0) {
                const firstTodo = todos[0];
                console.log('Testing mobile checkbox for:', firstTodo.text);
                console.log('Current state:', firstTodo.completed ? 'completed' : 'incomplete');
                
                // Simulate a checkbox click
                toggleTodo(firstTodo.id);
                
                console.log('✅ Task toggled! Check if the checkbox visual state changed.');
                console.log('If the visual didn\'t change, there might be a CSS issue.');
            } else {
                console.log('❌ No tasks available. Add a task first.');
            }
        }
        
        // Debug checkbox click events
        window.debugCheckboxClick = function() {
            console.log('=== DEBUGGING CHECKBOX CLICKS ===');
            const checkboxes = document.querySelectorAll('.todo-checkbox');
            console.log('Found checkboxes:', checkboxes.length);
            
            checkboxes.forEach((checkbox, index) => {
                console.log(`Checkbox ${index}:`, checkbox);
                console.log(`- Classes:`, checkbox.className);
                console.log(`- Onclick:`, checkbox.onclick);
                console.log(`- Parent:`, checkbox.parentElement);
            });
        }
        
        // Test task sorting functionality
        window.testTaskSorting = function() {
            console.log('=== TESTING TASK SORTING ===');
            const dateKey = selectedDate.toISOString().split('T')[0];
            const todayTodos = todos.filter(todo => todo.date === dateKey);
            
            console.log('Original todos:', todayTodos.map(t => `${t.text} (${t.completed ? 'completed' : 'uncompleted'})`));
            
            const sortedTodos = todayTodos.sort((a, b) => {
                if (a.completed === b.completed) {
                    return new Date(a.createdAt) - new Date(b.createdAt);
                }
                return a.completed ? 1 : -1;
            });
            
            console.log('Sorted todos:', sortedTodos.map(t => `${t.text} (${t.completed ? 'completed' : 'uncompleted'})`));
            
            return sortedTodos;
        }
        
        // Create a test todo with new structure
        window.createTestTodo = function() {
            console.log('=== CREATING TEST TODO ===');
            const testTodo = {
                id: 'test-' + Date.now(),
                text: 'Test Edit Button Task',
                completed: false,
                date: selectedDate.toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            };
            
            todos.push(testTodo);
            renderTodos();
            console.log('Test todo created. Swipe it left to see edit button.');
        }
        
        // Test edit button visibility
        window.testEditButton = function() {
            console.log('=== TESTING EDIT BUTTON ===');
            
            // Force re-render todos to ensure new HTML structure
            console.log('Forcing re-render of todos...');
            renderTodos();
            
            const todoItems = document.querySelectorAll('.todo-item');
            console.log('Found todo items:', todoItems.length);
            
            todoItems.forEach((item, index) => {
                const actionButtons = item.querySelector('.todo-action-buttons');
                const editArea = item.querySelector('.todo-edit-area');
                const deleteArea = item.querySelector('.todo-delete-area');
                
                console.log(`Todo ${index + 1}:`);
                console.log('- Action buttons container:', actionButtons);
                console.log('- Edit area:', editArea);
                console.log('- Delete area:', deleteArea);
                
                if (actionButtons) {
                    console.log('- Action buttons HTML:', actionButtons.innerHTML);
                    console.log('- Action buttons styles:', {
                        display: actionButtons.style.display,
                        opacity: actionButtons.style.opacity,
                        transform: actionButtons.style.transform,
                        width: actionButtons.style.width
                    });
                } else {
                    console.log('- NO ACTION BUTTONS CONTAINER FOUND!');
                    console.log('- Full item HTML:', item.innerHTML);
                }
            });
            
            // Force show action buttons for testing
            todoItems.forEach(item => {
                item.classList.add('swiped');
            });
            
            console.log('Forced all items to swiped state. Check for yellow border around action buttons container.');
        }
        
        // Test multiple task scenarios
        window.testTaskExamples = function() {
            console.log('=== TESTING MULTIPLE TASK SCENARIOS ===');
            const examples = [
                "I want to clean my room and walk my dog. Oh and go for a run",
                "I need to read a book, also call my mom and go to the gym",
                "Let's walk the dog and then exercise",
                "I want to cook dinner. Also need to do laundry",
                "Okay i want to swim today. Go for a run, walk my dog, and read a book",
                "I want to go for a run read a book walk my dog and clean my room today",
                "I want to read a book, walk my dog, eat dinner, and call my mom"
            ];
            
            examples.forEach((msg, i) => {
                console.log(`\n--- Example ${i + 1}: "${msg}" ---`);
                const tasks = extractTasksFromMessage(msg);
                console.log('Extracted tasks:', tasks);
                console.log('Task count:', tasks.length);
            });
        }
        
        // Debug the specific 4-task issue
        window.debugFourTasks = function() {
            console.log('=== DEBUGGING 4-TASK ISSUE ===');
            const message = "Okay i want to swim today. Go for a run, walk my dog, and read a book";
            
            console.log('Original message:', message);
            console.log('Lowercase:', message.toLowerCase());
            
            // Test each part separately
            const parts = [
                "Okay i want to swim today",
                "Go for a run",
                "walk my dog", 
                "and read a book"
            ];
            
            parts.forEach((part, i) => {
                console.log(`\n--- Testing part ${i + 1}: "${part}" ---`);
                const tasks = extractTasksFromSegment(part.trim());
                console.log('Extracted from this part:', tasks);
            });
            
            // Test full message
            console.log('\n--- Testing full message ---');
            const fullResult = extractTasksFromMessage(message);
            console.log('Full result:', fullResult);
            console.log('Expected 4 tasks, found:', fullResult.length);
        }
        
        // Debug the hike message specifically
        window.debugHikeMessage = function() {
            console.log('=== DEBUGGING HIKE MESSAGE ===');
            const message = "Okay i want to read a book. Go for a run. Walk my dog and go for a hike";
            
            console.log('Original message:', message);
            console.log('Lowercase:', message.toLowerCase());
            
            // Test each part separately
            const parts = [
                "Okay i want to read a book",
                "Go for a run",
                "Walk my dog and go for a hike"
            ];
            
            parts.forEach((part, i) => {
                console.log(`\n--- Testing part ${i + 1}: "${part}" ---`);
                const tasks = extractTasksFromSegment(part.trim());
                console.log('Extracted from this part:', tasks);
            });
            
            // Test full message
            console.log('\n--- Testing full message ---');
            const fullResult = extractTasksFromMessage(message);
            console.log('Full result:', fullResult);
            console.log('Expected 4 tasks, found:', fullResult.length);
        }
        
        // Reset AI typing state - call from console if AI gets stuck
        window.resetAITyping = function() {
            console.log('=== RESETTING AI TYPING STATE ===');
            console.log('Previous isAITyping:', isAITyping);
            isAITyping = false;
            hideAITyping();
            // Remove any stuck typing indicators
            const allTypingIndicators = document.querySelectorAll('.typing-indicator');
            allTypingIndicators.forEach(indicator => indicator.remove());
            console.log('AI typing state reset. isAITyping now:', isAITyping);
            console.log('✅ AI typing state reset successfully');
        }
        
        // Add a more comprehensive reset function
        window.fullAIReset = function() {
            console.log('=== FULL AI RESET ===');
            isAITyping = false;
            hideAITyping();
            const allTypingIndicators = document.querySelectorAll('.typing-indicator');
            allTypingIndicators.forEach(indicator => indicator.remove());
            // Clear any timeouts that might be running
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            console.log('Full AI reset complete!');
            addMessageToChat('ai', "🆕 Complete AI reset done! Everything should work normally now. Try sending a message!");
        }
        
        // Test the specific user message patterns
        window.testUserMessage = function() {
            console.log('=== TESTING USER MESSAGE PATTERNS ===');
            const testMessages = [
                'I also want you to call my mom and walk my dog today',
                'I want to read a book',
                'I also want to read a book',
                'want to read a book',
                'read a book',
                'I wanna go to the gym',
                'walk my dog'
            ];
            
            testMessages.forEach(testMessage => {
                console.log('\n--- Testing:', testMessage, '---');
                const tasks = extractTasksFromMessage(testMessage);
                console.log('Extracted tasks:', tasks);
            });
            
            return testMessages.map(msg => ({
                message: msg, 
                tasks: extractTasksFromMessage(msg)
            }));
        }
        
        // Test the specific "Add to planner" pattern
        window.testAddToPlannerPattern = function() {
            console.log('=== TESTING "ADD TO PLANNER" PATTERN ===');
            const testMessages = [
                'Add doodling in a notebook to my planner',
                'Add painting to my planner', 
                'Add call my mom to the planner',
                'Add exercise for 30 minutes to my planner'
            ];
            
            testMessages.forEach(testMessage => {
                console.log(`\n--- Testing: "${testMessage}" ---`);
                
                // Test task creation intent detection
                const hasIntent = isTaskCreationIntent(testMessage);
                console.log('Task creation intent detected:', hasIntent);
                
                // Test task extraction
                const tasks = extractTasksFromMessage(testMessage);
                console.log('Extracted tasks:', tasks);
                
                if (hasIntent && tasks.length > 0) {
                    console.log('✅ SUCCESS: Should show task popup');
                } else {
                    console.log('❌ FAILED: Missing intent or task extraction');
                }
            });
            
            return testMessages.map(msg => ({
                message: msg, 
                intent: isTaskCreationIntent(msg),
                tasks: extractTasksFromMessage(msg)
            }));
        }
        
        // Quick test function for the current issue (console only, no UI popup)
        window.testReadBook = function() {
            console.log('=== TESTING "I want to read a book" ===');
            const message = 'I want to read a book';
            const tasks = extractTasksFromMessage(message);
            console.log('Message:', message);
            console.log('Extracted tasks:', tasks);
            console.log('Should detect: ["Read a book"]');
            
            if (tasks.length > 0) {
                console.log('✅ Task detection WORKING');
                console.log('Note: Use testReadBookWithUI() to also show the popup');
            } else {
                console.log('❌ Task detection FAILED');
            }
            
            return tasks;
        }
        
        // Version that shows UI popup (for manual testing only)
        window.testReadBookWithUI = function() {
            const tasks = window.testReadBook();
            if (tasks.length > 0) {
                showDetectedTasks(tasks);
                console.log('UI popup should now be visible');
            }
            return tasks;
        }
        
        // AGGRESSIVE recovery system - clean up any stuck states
        setInterval(() => {
            const indicators = document.querySelectorAll('.typing-indicator');
            
            // If we have indicators but isAITyping is false, clean them up
            if (!isAITyping && indicators.length > 0) {
                console.log('🧹 Cleanup: Removing orphaned typing indicators');
                indicators.forEach(indicator => indicator.remove());
            }
            
            // Extra safety: If isAITyping has been true for more than 10 seconds, force reset
            // This shouldn't happen with our 2-second guaranteed response, but just in case
            if (isAITyping) {
                if (!window.aiTypingStartTime) {
                    window.aiTypingStartTime = Date.now();
                } else if (Date.now() - window.aiTypingStartTime > 10000) {
                    console.log('🚨 EMERGENCY: isAITyping stuck for >10 seconds, force reset');
                    resetAIState();
                    indicators.forEach(indicator => indicator.remove());
                    addMessageToChat('ai', "Sorry, I got stuck for a moment! I'm ready now. What would you like to work on?");
                }
            } else {
                window.aiTypingStartTime = null;
            }
        }, 5000); // Check every 5 seconds
        
        // Debug function - call from console to test AI response
        window.debugAIResponse = function(message) {
            console.log('=== DEBUG AI RESPONSE ===');
            generateAIResponseWithRetry(message || "Hello").then(response => {
                console.log('AI Response:', response);
            }).catch(error => {
                console.error('AI Error:', error);
            });
        }
        
        // TASK DETECTION TEST
        window.testTaskDetection = function(message) {
            console.log('🧪 Testing task detection for:', message);
            const tasks = extractTasksFromMessage(message);
            console.log('🧪 Detected tasks:', tasks);
            const intent = isTaskCreationIntent(message);
            console.log('🧪 Task creation intent:', intent);
            return { tasks, intent };
        };
        
        // NETWORK CONNECTIVITY TEST
        window.testConnectivity = async function() {
            console.log('🌐 Testing network connectivity...');
            try {
                // Test basic internet connectivity
                const testResponse = await fetch('https://httpbin.org/get', { method: 'GET' });
                console.log('✅ Basic internet works:', testResponse.ok);
                
                // Test if we can reach Google APIs domain
                const googleTest = await fetch('https://generativelanguage.googleapis.com/', { method: 'HEAD' });
                console.log('✅ Google APIs domain reachable:', googleTest.ok);
                
                return true;
            } catch (error) {
                console.log('❌ Network connectivity issue:', error.message);
                return false;
            }
        };
        
        // EMERGENCY DEBUG: Force send a message to test the system
        window.emergencyTest = function(testMessage = "test message") {
            console.log('🚨 EMERGENCY TEST STARTED');
            console.log('🚨 Current isAITyping:', isAITyping);
            console.log('🚨 Current aiTypingStartTime:', window.aiTypingStartTime);
            
            // Force clean state
            resetAIState();
            const indicators = document.querySelectorAll('.typing-indicator');
            indicators.forEach(i => i.remove());
            console.log('🚨 State cleaned');
            
            // Set input and trigger send
            const input = document.getElementById('chatInput');
            input.value = testMessage;
            console.log('🚨 Input set to:', testMessage);
            
            // Call sendMessage directly
            sendMessage();
            console.log('🚨 sendMessage() called');
        }
        
                 // Quick API health check
        window.checkAPIHealth = function() {
            console.log('=== API HEALTH CHECK ===');
            console.log('API Key:', GEMINI_API_KEY ? 'Configured' : 'Missing');
            console.log('API URL:', GEMINI_API_URL);
            
            // Try a simple request
            generateAIResponse("Hello").then(response => {
                console.log('✅ API Status: HEALTHY');
                console.log('Response:', response);
            }).catch(error => {
                console.log('❌ API Status: FAILED');
                console.error('Error:', error.message);
                if (error.message.includes('429')) {
                    console.log('🔍 Diagnosis: Rate limited - wait 30 seconds');
                } else if (error.message.includes('403')) {
                    console.log('🔍 Diagnosis: API key issue or quota exceeded');
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    console.log('🔍 Diagnosis: Network connectivity issue');
                } else {
                    console.log('🔍 Diagnosis: Unknown API error');
                }
            });
        }

        // Firebase debug functions
        window.checkFirebaseStatus = function() {
            console.log('=== FIREBASE STATUS CHECK ===');
            console.log('Firebase Enabled:', isFirebaseEnabled);
            console.log('Online Status:', isOnline);
            console.log('Sync Queue Length:', syncQueue.length);
            console.log('Database Instance:', db ? 'Connected' : 'Not connected');
            
            if (isFirebaseEnabled && db) {
                console.log('Testing Firebase connection...');
                db.collection('todos').limit(1).get()
                    .then(snapshot => {
                        console.log('✅ Firebase Status: CONNECTED');
                        console.log('Sample data size:', snapshot.size);
                    })
                    .catch(error => {
                        console.log('❌ Firebase Status: FAILED');
                        console.error('Error:', error.message);
                    });
            } else if (firebaseConfig.apiKey === "demo-api-key") {
                console.log('🔧 Firebase Status: DEMO MODE (using localStorage)');
                console.log('💡 To enable Firebase: Update firebaseConfig with your real config');
            } else {
                console.log('❌ Firebase Status: NOT INITIALIZED');
            }
        }

        window.forceSyncNow = async function() {
            console.log('=== FORCE SYNC NOW ===');
            if (!isFirebaseEnabled) {
                console.log('❌ Firebase not enabled');
                return;
            }
            
            try {
                await DataLayer.saveTodos(todos);
                console.log('✅ Force sync completed');
                updateSyncStatus();
            } catch (error) {
                console.error('❌ Force sync failed:', error);
            }
        }

                 window.clearLocalData = function() {
             console.log('=== CLEARING LOCAL DATA ===');
             localStorage.removeItem('memaster_todos');
             localStorage.removeItem('memaster_scheduled_tasks');
             console.log('✅ Local storage cleared');
             console.log('🔄 Reload page to see changes');
         }

         // Test the second message issue specifically
         window.testSecondMessage = function() {
             console.log('=== TESTING SECOND MESSAGE ISSUE ===');
             console.log('Initial isAITyping state:', isAITyping);
             
             // Force clean state first
             isAITyping = false;
             hideAITyping();
             
             // Simulate first message
             console.log('Sending first message: "I want to feed my dog and read a book"');
             sendMessageProgrammatically("I want to feed my dog and read a book");
             
             // Wait 4 seconds then send second message
             setTimeout(() => {
                 console.log('📍 ABOUT TO SEND SECOND MESSAGE');
                 console.log('📍 Current isAITyping before second message:', isAITyping);
                 console.log('Sending second message: "I also want to call my mom"');
                 sendMessageProgrammatically("I also want to call my mom");
                 
                 // Check state after second message
                 setTimeout(() => {
                     console.log('📍 isAITyping after second message sent:', isAITyping);
                 }, 100);
             }, 4000);
         }
         
         // Simple test for debugging current issue
         window.testSingleMessage = function() {
             console.log('=== TESTING SINGLE MESSAGE ===');
             console.log('Current isAITyping before test:', isAITyping);
             sendMessageProgrammatically("I want to read and eat burgers today");
         }
         
         // Emergency AI reset function
         window.emergencyReset = function() {
             console.log('🚨 EMERGENCY RESET');
             resetAIState();
             const indicators = document.querySelectorAll('.typing-indicator');
             indicators.forEach(i => i.remove());
             console.log('✅ Emergency reset complete, isAITyping:', isAITyping);
         }
         
         // Immediate test - works instantly
         window.testNow = function() {
             console.log('🧪 IMMEDIATE TEST');
             isAITyping = false; // Force clean state
             hideAITyping();
             
             setTimeout(() => {
                 addMessageToChat('user', 'Test message: I want to read a book');
                 addMessageToChat('ai', '📚 Reading is an excellent goal! What type of book are you in the mood for?');
                 console.log('✅ Test complete - AI should have responded');
             }, 100);
         }
         
         // Monitor state continuously
         window.startStateMonitor = function() {
             console.log('🔍 Starting state monitor...');
             window.stateMonitor = setInterval(() => {
                 console.log('🔍 isAITyping:', isAITyping);
             }, 2000);
         }
         
         window.stopStateMonitor = function() {
             if (window.stateMonitor) {
                 clearInterval(window.stateMonitor);
                 console.log('🔍 State monitor stopped');
             }
         }
         
         // Rapid fire test - send multiple messages quickly
         window.rapidFireTest = function() {
             console.log('🔥 RAPID FIRE TEST - Testing multiple quick messages');
             
             // Start state monitor
             startStateMonitor();
             
             // Send first message
             setTimeout(() => {
                 console.log('🔥 Message 1: "I want to read a book"');
                 sendMessageProgrammatically("I want to read a book");
             }, 500);
             
             // Send second message quickly
             setTimeout(() => {
                 console.log('🔥 Message 2: "I also want to call my mom"');
                 sendMessageProgrammatically("I also want to call my mom");
             }, 3000);
             
             // Send third message
             setTimeout(() => {
                 console.log('🔥 Message 3: "And walk my dog"');
                 sendMessageProgrammatically("And walk my dog");
             }, 6000);
             
             // Stop monitor after test
             setTimeout(() => {
                 stopStateMonitor();
                 console.log('🔥 Rapid fire test complete');
             }, 10000);
         }
         
         // Helper function to send messages programmatically
         function sendMessageProgrammatically(message) {
             const input = document.getElementById('chatInput');
             if (input) {
                 input.value = message;
                 sendMessage();
             }
         }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Detected Tasks Management
        let currentDetectedTasks = [];

        function showDetectedTasks(tasks) {
            console.log('=== showDetectedTasks called ===');
            console.log('Tasks received:', tasks);
            console.log('Tasks length:', tasks.length);
            console.log('Tasks array:', JSON.stringify(tasks));
            
            currentDetectedTasks = tasks;
            const container = document.getElementById('detectedTasksContainer');
            const tasksList = document.getElementById('detectedTasksList');
            const messageElement = document.getElementById('detectedTasksMessage');
            
            console.log('Container:', container);
            console.log('TasksList:', tasksList);
            console.log('MessageElement:', messageElement);
            
            if (!container || !tasksList || !messageElement) {
                console.error('Could not find container, tasksList, or messageElement');
                return;
            }
            
            // Set the correct message and button text based on number of tasks
            const message = tasks.length === 1 
                ? "Should I add this task to your planner?"
                : "Should I add these tasks to your planner?";
            const buttonText = tasks.length === 1 
                ? "Add This Task"
                : "Add These Tasks";
                
            messageElement.textContent = message;
            
            const buttonTextElement = document.getElementById('addTasksButtonText');
            if (buttonTextElement) {
                buttonTextElement.textContent = buttonText;
            }
            
            console.log('Set message to:', message);
            console.log('Set button text to:', buttonText);
            
            // Clear previous tasks
            tasksList.innerHTML = '';
            console.log('Cleared tasksList, now adding', tasks.length, 'tasks');
            
            // Add each detected task
            console.log('About to add', tasks.length, 'tasks to the list');
            tasks.forEach((task, index) => {
                console.log(`Adding task ${index}:`, task);
                const taskItem = document.createElement('div');
                taskItem.className = 'detected-task-item';
                taskItem.style.cssText = 'background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 8px !important; padding: 10px 12px !important; margin-bottom: 8px !important; color: #ffffff !important; font-size: 14px !important; display: flex !important; align-items: center !important; gap: 10px !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 10 !important; min-height: 40px !important;';
                taskItem.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #667eea !important; font-size: 14px !important;"></i>
                    <span style="color: #ffffff !important; font-weight: 500 !important;">${task}</span>
                `;
                tasksList.appendChild(taskItem);
                console.log('Task item added. Element:', taskItem);
                console.log('Task item HTML:', taskItem.outerHTML);
            });
            
            // Double-check the list has items
            console.log('tasksList children count:', tasksList.children.length);
            console.log('tasksList.innerHTML:', tasksList.innerHTML);
            
            console.log('TasksList innerHTML after adding tasks:', tasksList.innerHTML);
            
            // Show the container
            container.style.display = 'block';
            console.log('Container display set to block');
            
            // Force visibility
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            
            // Simple scroll to show the latest content since tasks are now fixed positioned
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    // Just scroll to bottom to show the latest message
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, 100);
        }

        async function approveDetectedTasks() {
            console.log('approveDetectedTasks called with tasks:', currentDetectedTasks);
            
            if (currentDetectedTasks.length > 0) {
                console.log('Adding tasks to todos array:', currentDetectedTasks);
                
                // Add tasks to the todo list
                currentDetectedTasks.forEach(task => {
                    const newTask = {
                        id: (Date.now() + Math.random()).toString(),
                        text: task,
                        completed: false,
                        date: selectedDate.toISOString().split('T')[0],
                        createdAt: new Date().toISOString()
                    };
                    todos.push(newTask);
                    console.log('Added task to todos:', newTask);
                });
                
                console.log('Current todos array after adding:', todos);
                
                // Save using DataLayer
                try {
                    await DataLayer.saveTodos(todos);
                    console.log('✅ Detected tasks saved successfully');
                } catch (error) {
                    console.error('❌ Failed to save detected tasks:', error);
                }
                
                // Update the display
                renderTodos();
                console.log('Called renderTodos()');
                
                // Store task info for success message BEFORE clearing the array
                const taskCount = currentDetectedTasks.length;
                const firstTask = currentDetectedTasks[0];
                
                // Show success message
                const successMsg = taskCount === 1 
                    ? `Added "${firstTask}" to your tasks!`
                    : `Added ${taskCount} tasks to your planner!`;
                    
                addMessageToChat('ai', `✅ Great! ${successMsg} You can find them in your main todo list. What else would you like to work on today?`);
                
                // CRITICAL: Reset AI state after task approval to ensure it can respond to next message
                setTimeout(() => {
                    console.log('🔄 Resetting AI state after task approval');
                    resetAIState();
                    console.log('🔄 AI state reset complete, isAITyping:', isAITyping);
                }, 500);
                
                // Hide the detected tasks container (this clears currentDetectedTasks)
                dismissDetectedTasks();
            } else {
                console.log('No tasks to approve - currentDetectedTasks is empty');
                addMessageToChat('ai', `I didn't detect any specific tasks in your message. Could you be more specific about what you'd like to accomplish? For example: 'I need to clean my room' or 'I want to call my mom'.`);
            }
        }

        function dismissDetectedTasks() {
            const container = document.getElementById('detectedTasksContainer');
            container.style.display = 'none';
            currentDetectedTasks = [];
            
            // EXTRA SAFETY: Always reset AI state when dismissing tasks
            setTimeout(() => {
                console.log('🔄 Extra safety reset after dismissing tasks');
                resetAIState();
            }, 100);
        }


        // Day Schedule Functions
        function openDaySchedule() {
            // Hide all other views
            document.querySelectorAll('.main-screen, .calendar-view, .stats-view').forEach(v => {
                v.classList.remove('active');
            });
            
            // Show day schedule
            document.getElementById('dayScheduleView').classList.add('active');
            
            // Update header
            const dateStr = selectedDate.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('dayScheduleDate').textContent = dateStr;
            
            // Render time slots
            renderTimeSlots();
            
            currentView = 'daySchedule';
        }

        function closeDaySchedule() {
            document.getElementById('dayScheduleView').classList.remove('active');
            
            // Return to calendar view
            document.getElementById('calendarView').classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.nav-item:nth-child(2)').classList.add('active'); // Calendar nav item
            
            currentView = 'calendar';
        }

        function renderTimeSlots() {
            const container = document.getElementById('timeSlotsContainer');
            const dateKey = selectedDate.toISOString().split('T')[0];
            const dayTasks = scheduledTasks[dateKey] || {};
            
            container.innerHTML = '';
            
            // Generate 24 hours with 30-minute intervals
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeKey = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const displayTime = formatTime12Hour(hour, minute);
                    
                    const timeSlot = document.createElement('div');
                    timeSlot.className = `time-slot ${minute === 0 ? 'hour-marker' : ''}`;
                    
                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'time-label';
                    timeLabel.textContent = minute === 0 ? displayTime : '';
                    
                    const timeContent = document.createElement('div');
                    timeContent.className = 'time-content';
                    
                    // Check if there's a task scheduled for this time
                    const task = dayTasks[timeKey];
                    if (task) {
                        const taskElement = createScheduledTaskElement(task, timeKey, dateKey);
                        timeContent.appendChild(taskElement);
                    } else {
                        timeContent.classList.add('empty');
                        timeContent.innerHTML = '<span>Tap to schedule</span>';
                        timeContent.addEventListener('click', () => {
                            selectedTimeSlot = timeKey;
                            showTimeTaskModal();
                        });
                    }
                    
                    timeSlot.appendChild(timeLabel);
                    timeSlot.appendChild(timeContent);
                    container.appendChild(timeSlot);
                }
            }
        }

        function formatTime12Hour(hour, minute) {
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;
        }

        function createScheduledTaskElement(task, timeKey, dateKey) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'scheduled-task';
            
            const title = document.createElement('div');
            title.className = 'scheduled-task-title';
            title.textContent = task.title;
            
            const duration = document.createElement('div');
            duration.className = 'scheduled-task-duration';
            duration.textContent = `${task.duration} minutes`;
            
            const actions = document.createElement('div');
            actions.className = 'scheduled-task-actions';
            
            const completeBtn = document.createElement('button');
            completeBtn.className = 'task-action-btn complete';
            completeBtn.innerHTML = '<i class="fas fa-check"></i> Complete';
            completeBtn.onclick = () => completeScheduledTask(dateKey, timeKey);
            
            const editBtn = document.createElement('button');
            editBtn.className = 'task-action-btn';
            editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
            editBtn.onclick = () => editScheduledTask(dateKey, timeKey);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'task-action-btn delete';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
            deleteBtn.onclick = () => deleteScheduledTask(dateKey, timeKey);
            
            actions.appendChild(completeBtn);
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            
            taskDiv.appendChild(title);
            taskDiv.appendChild(duration);
            taskDiv.appendChild(actions);
            
            return taskDiv;
        }

        function showTimeTaskModal() {
            const modal = document.getElementById('timeTaskModal');
            const timeSlotSelect = document.getElementById('timeSlotSelect');
            
            // Populate time slot options
            timeSlotSelect.innerHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeKey = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const displayTime = formatTime12Hour(hour, minute);
                    const option = document.createElement('option');
                    option.value = timeKey;
                    option.textContent = displayTime;
                    if (timeKey === selectedTimeSlot) {
                        option.selected = true;
                    }
                    timeSlotSelect.appendChild(option);
                }
            }
            
            modal.classList.add('active');
            setTimeout(() => {
                document.getElementById('timeTaskInput').focus();
            }, 300);
        }

        function closeTimeTaskModal() {
            document.getElementById('timeTaskModal').classList.remove('active');
            document.getElementById('timeTaskInput').value = '';
            selectedTimeSlot = null;
        }

        function scheduleTimeTask() {
            const title = document.getElementById('timeTaskInput').value.trim();
            const timeSlot = document.getElementById('timeSlotSelect').value;
            const duration = parseInt(document.getElementById('durationSelect').value);
            
            if (!title) {
                alert('Please enter a task description');
                return;
            }
            
            const dateKey = selectedDate.toISOString().split('T')[0];
            
            // Initialize date in scheduled tasks if it doesn't exist
            if (!scheduledTasks[dateKey]) {
                scheduledTasks[dateKey] = {};
            }
            
            // Create task object
            const task = {
                title: title,
                duration: duration,
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            // Save task
            scheduledTasks[dateKey][timeSlot] = task;
            localStorage.setItem('memaster_scheduled_tasks', JSON.stringify(scheduledTasks));
            
            // Close modal and refresh view
            closeTimeTaskModal();
            renderTimeSlots();
            
            // Show success message
            showToast(`Task scheduled for ${formatTime12Hour(...timeSlot.split(':').map(Number))}!`);
        }

        function completeScheduledTask(dateKey, timeKey) {
            if (scheduledTasks[dateKey] && scheduledTasks[dateKey][timeKey]) {
                scheduledTasks[dateKey][timeKey].completed = true;
                
                // Also add to regular todos as completed
                const task = scheduledTasks[dateKey][timeKey];
                const todo = {
                    id: Date.now().toString(),
                    text: task.title,
                    completed: true,
                    date: dateKey,
                    createdAt: new Date().toISOString()
                };
                todos.push(todo);
                
                localStorage.setItem('memaster_scheduled_tasks', JSON.stringify(scheduledTasks));
                localStorage.setItem('memaster_todos', JSON.stringify(todos));
                
                renderTimeSlots();
                showToast('Task completed! 🎉');
            }
        }

        function editScheduledTask(dateKey, timeKey) {
            if (scheduledTasks[dateKey] && scheduledTasks[dateKey][timeKey]) {
                const task = scheduledTasks[dateKey][timeKey];
                
                // Pre-fill the modal with existing task data
                document.getElementById('timeTaskInput').value = task.title;
                document.getElementById('durationSelect').value = task.duration.toString();
                selectedTimeSlot = timeKey;
                
                showTimeTaskModal();
            }
        }

        function deleteScheduledTask(dateKey, timeKey) {
            if (confirm('Are you sure you want to delete this scheduled task?')) {
                if (scheduledTasks[dateKey] && scheduledTasks[dateKey][timeKey]) {
                    delete scheduledTasks[dateKey][timeKey];
                    localStorage.setItem('memaster_scheduled_tasks', JSON.stringify(scheduledTasks));
                    renderTimeSlots();
                    showToast('Task deleted');
                }
            }
        }



        // Event listeners
        document.getElementById('taskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        document.getElementById('editTaskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveEditedTask();
            }
        });

        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Bottom chat input event listeners
        document.getElementById('bottomChatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleBottomChatInput();
            }
        });

        document.getElementById('bottomChatInput').addEventListener('focus', function() {
            if (!isChatExpanded) {
                openChatModal();
            }
        });

        // Time task input event listener
        document.getElementById('timeTaskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scheduleTimeTask();
            }
        });

        // Close swipes when clicking outside todo items
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.todo-item') && !e.target.closest('.todo-delete-area')) {
                closeAllSwipes();
            }
        });

        // Close swipes when navigating
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', closeAllSwipes);
        });

        // Close swipes when scrolling
        let scrollTimeout;
        document.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(closeAllSwipes, 100);
        }, { passive: true });

        // Force input text visibility for mobile browsers
        function forceInputVisibility() {
            // Fix for chat inputs with original styling
            const inputs = document.querySelectorAll('input[type="text"], textarea, select');
            inputs.forEach(input => {
                input.style.setProperty('color', 'white', 'important');
                input.style.setProperty('-webkit-text-fill-color', 'white', 'important');
                input.style.setProperty('-webkit-opacity', '1', 'important');
                input.style.setProperty('opacity', '1', 'important');
                input.style.setProperty('visibility', 'visible', 'important');
                input.style.setProperty('display', input.classList.contains('chat-input') ? 'block' : 'flex', 'important');
                
                // Add event listeners to maintain color while typing
                input.addEventListener('input', function() {
                    this.style.setProperty('color', 'white', 'important');
                    this.style.setProperty('-webkit-text-fill-color', 'white', 'important');
                });
                
                input.addEventListener('focus', function() {
                    this.style.setProperty('color', 'white', 'important');
                    this.style.setProperty('-webkit-text-fill-color', 'white', 'important');
                });
            });

            // Extra handling for specific inputs
            const chatInput = document.getElementById('chatInput');
            const bottomChatInput = document.getElementById('bottomChatInput');
            
            if (chatInput) {
                chatInput.style.setProperty('color', 'white', 'important');
                chatInput.style.setProperty('-webkit-text-fill-color', 'white', 'important');
            }
            
            if (bottomChatInput) {
                bottomChatInput.style.setProperty('color', 'white', 'important');
                bottomChatInput.style.setProperty('-webkit-text-fill-color', 'white', 'important');
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set welcome screen active class
            document.body.classList.add('welcome-active');
            
            // Log available debug functions
            console.log('🤖 MeMaster Debug Functions:');
            console.log('=== AI Functions ===');
            console.log('- resetAITyping() - Reset if AI gets stuck');
            console.log('- fullAIReset() - Complete AI system reset');
            console.log('- checkAPIHealth() - Test if Gemini API is working');
            console.log('- testReadBook() - Test "I want to read a book" detection (console only)');
            console.log('- testReadBookWithUI() - Same as above but shows UI popup');
            console.log('- testUserMessage() - Test multiple message patterns');
            console.log('- debugTaskExtraction("message") - Test task detection');
            console.log('- debugAIResponse("message") - Test AI responses');
            console.log('=== Storage Functions ===');
            console.log('- clearLocalData() - Clear localStorage (testing only)');
            console.log('=== Issue Testing ===');
            console.log('- testNow() - IMMEDIATE test (works instantly)');
            console.log('- testSingleMessage() - Test a single message (debug current issue)');  
            console.log('- testSecondMessage() - Test the "second message not responding" issue');
            console.log('- rapidFireTest() - Test multiple messages quickly (with monitoring)');
            console.log('- startStateMonitor() - Monitor isAITyping state continuously');
            console.log('- stopStateMonitor() - Stop the state monitor');
            console.log('- emergencyReset() - Force reset if AI gets completely stuck');
            console.log('=== Task Extraction Testing ===');
            console.log('- testCurrentMessage() - Test the current 4-task message');
            console.log('- testHikeMessage() - Test the new 4-task message with hike');
            console.log('- testContinuousMessage() - Test the continuous 4-task message');
            console.log('- testCommaMessage() - Test the comma-separated 4-task message');
            console.log('- testEatDinnerMessage() - Test the current 4-task message with eat dinner');
            console.log('- debugFourTasks() - Debug the 4-task extraction issue');
            console.log('- debugHikeMessage() - Debug the hike message specifically');
            console.log('- testUserMessage() - Test the exact 3-task message from user');
            console.log('- testTaskExamples() - Test multiple task extraction scenarios');
            console.log('- debugTaskExtraction("your message") - Test any message for task extraction');
            console.log('=== Checkbox Testing ===');
            console.log('- testCheckboxes() - Test if checkboxes are properly configured and clickable');
            console.log('- testTaskCompletion() - Test task completion toggle functionality');
            console.log('- testMobileCheckbox() - Force toggle a task to test mobile checkbox functionality');
            console.log('=== "Add to Planner" Testing ===');
            console.log('- testAddToPlannerPattern() - Test "Add [task] to my planner" message detection');
            console.log('');
            console.log('🔧 Quick Fix: If AI stops responding, try: rapidFireTest() or emergencyReset()');
            console.log('📚 Test Current Issue: testReadBook() (safe - no UI popup)');
            console.log('🏥 Check API Status: checkAPIHealth()');
            console.log('💾 All tasks saved locally - no backend needed!');
            
            // Dismiss any accidentally shown task popups from debugging
            setTimeout(() => {
                const taskContainer = document.getElementById('detectedTasksContainer');
                if (taskContainer && taskContainer.style.display !== 'none') {
                    console.log('🧹 Hiding accidentally shown task popup from debugging');
                    dismissDetectedTasks();
                }
            }, 100);
            
            // Force input visibility
            forceInputVisibility();
            
            // Re-apply visibility fixes more frequently for dynamic content
            setInterval(forceInputVisibility, 1000);
            
            // Extra check when AI modal opens
            document.addEventListener('click', function(e) {
                if (e.target.closest('.ai-chat-modal')) {
                    setTimeout(forceInputVisibility, 100);
                }
            });
            
            // iOS Safari viewport fix for portrait mode
            function fixIOSViewport() {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isPortrait = window.innerHeight > window.innerWidth;
                
                if (isIOS && isPortrait) {
                    const chatContainer = document.querySelector('.chat-input-container');
                    if (chatContainer) {
                        chatContainer.style.setProperty('position', 'fixed', 'important');
                        chatContainer.style.setProperty('bottom', '0', 'important');
                        chatContainer.style.setProperty('z-index', '200', 'important');
                    }
                }
            }
            
            // Run iOS fix on orientation change and resize
            window.addEventListener('orientationchange', () => {
                setTimeout(fixIOSViewport, 500);
            });
            
            window.addEventListener('resize', fixIOSViewport);
            
            // Initial iOS fix
            fixIOSViewport();
            
            // Initialize sync status immediately
            updateSyncStatus();
            
            // Auto-show main app after 2 seconds or on interaction
            setTimeout(() => {
                if (document.getElementById('welcomeScreen').style.display !== 'none') {
                    showMainApp();
                }
            }, 3000);
            
            // Handle URL shortcuts from PWA manifest
            const params = new URLSearchParams(window.location.search);
            if (params.get('action') === 'add-task') {
                setTimeout(() => {
                    showTaskInputModal();
                }, 1000);
            } else if (params.get('action') === 'ai-chat') {
                setTimeout(() => {
                    openAIChat();
                }, 1000);
            }
            
            // Initialize API status indicator
            if (isGeminiConfigured()) {
                console.log('✅ Gemini API configured and ready');
            } else {
                console.log('⚙️ Gemini API not configured - click settings button to configure');
            }
            updateSettingsButtonIndicator();
            
            // Load goals
            loadGoals();
        });
        
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    console.log('PWA: Registering service worker...');
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('PWA: Service worker registered successfully:', registration.scope);
                    
                    // Handle updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                console.log('PWA: New version available');
                                showToast('New version available! Refresh to update.');
                            }
                        });
                    });
                    
                    // Show install prompt for PWA
                    let deferredPrompt;
                    window.addEventListener('beforeinstallprompt', (e) => {
                        console.log('PWA: Install prompt available');
                        e.preventDefault();
                        deferredPrompt = e;
                        
                        // Show custom install button after 10 seconds
                        setTimeout(() => {
                            showInstallPrompt(deferredPrompt);
                        }, 10000);
                    });
                    
                    // Track if app was launched from home screen
                    if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
                        console.log('PWA: Launched as standalone app');
                        document.body.classList.add('pwa-mode');
                    }
                    
                } catch (error) {
                    console.error('PWA: Service worker registration failed:', error);
                }
            });
        }
        
        // Show PWA install prompt
        function showInstallPrompt(deferredPrompt) {
            if (!deferredPrompt) return;
            
            const installToast = document.createElement('div');
            installToast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 20px;
                right: 20px;
                background: rgba(102, 126, 234, 0.95);
                color: white;
                padding: 15px;
                border-radius: 12px;
                backdrop-filter: blur(10px);
                z-index: 10000;
                text-align: center;
                font-size: 14px;
                line-height: 1.4;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            `;
            installToast.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>📱 Install MeMaster</strong><br>
                    Add to your home screen for the best experience!
                </div>
                <button onclick="installPWA()" style="background: white; color: #667eea; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; margin-right: 10px; cursor: pointer;">Install</button>
                <button onclick="dismissInstall()" style="background: transparent; color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer;">Later</button>
            `;
            
            document.body.appendChild(installToast);
            window.installToastElement = installToast;
            window.deferredPromptGlobal = deferredPrompt;
        }
        
        // Install PWA
        function installPWA() {
            if (window.deferredPromptGlobal) {
                window.deferredPromptGlobal.prompt();
                window.deferredPromptGlobal.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA: User accepted the install prompt');
                        showToast('🎉 MeMaster installed successfully!');
                    } else {
                        console.log('PWA: User dismissed the install prompt');
                    }
                    window.deferredPromptGlobal = null;
                    dismissInstall();
                });
            }
        }
        
        // Dismiss install prompt
        function dismissInstall() {
            if (window.installToastElement) {
                window.installToastElement.remove();
                window.installToastElement = null;
            }
        }
    </script>
</body>
</html>
